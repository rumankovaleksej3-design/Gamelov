<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
}
.tab{
  flex:1;
  padding:12px;
  text-align:center;
  cursor:pointer;
  opacity:.6;
}
.tab.active{opacity:1;background:#1e293b}

/* CHAT */
#chats{flex:1;display:flex;flex-direction:column}
.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#020617;
}
.msg{
  max-width:80%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:12px;
  background:#1e293b;
}
.me{margin-left:auto;background:#2563eb}
.msg small{
  display:block;
  font-size:11px;
  opacity:.6;
  text-align:right;
}
.reply-preview{
  font-size:12px;
  opacity:.7;
  border-left:2px solid #60a5fa;
  padding-left:6px;
  margin-bottom:4px;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  border:none;
  border-radius:8px;
  padding:10px;
  background:#22c55e;
  font-weight:600;
  cursor:pointer;
}

/* –ù–û–í–´–ï –°–¢–ò–õ–ò: –≠–ú–û–î–ó–ò –ü–ê–ù–ï–õ–¨ */
.emoji-category {
  display: flex;
  overflow-x: auto;
  gap: 5px;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid #334155;
}

.emoji-category-btn {
  background: #1e293b;
  border: none;
  color: white;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
  font-size: 12px;
}

.emoji-category-btn.active {
  background: #3b82f6;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 5px;
  max-height: 150px;
  overflow-y: auto;
  padding: 5px 0;
}

.emoji-grid span {
  font-size: 20px;
  text-align: center;
  cursor: pointer;
  padding: 2px;
  border-radius: 4px;
}

.emoji-grid span:hover {
  background: #1e293b;
}

/* USERS */
.user{
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
}
.status{font-size:10px; opacity:0.8; margin-top:2px;}

/* POSTS */
.post{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

/* PROFILE */
#profileView,#myProfile{
  flex:1;
  padding:20px;
  text-align:center;
}
.profileAvatar{font-size:48px}
.profileName{font-size:20px;font-weight:700}
.profileBio{opacity:.8;margin-top:8px}

/* –°–¢–ê–¢–£–° –°–û–û–ë–©–ï–ù–ò–ô */
.msg-status {
  font-size: 10px;
  margin-left: 4px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
  <input id="username" placeholder="–ù–∏–∫"><br><br>
  <input id="avatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)"><br><br>
  <textarea id="bio" placeholder="–û —Å–µ–±–µ"></textarea><br><br>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- MAIN -->
<div id="main" class="hidden">

<header>
  <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div id="replyBox" class="hidden" style="padding:6px;background:#020617">
    –û—Ç–≤–µ—Ç: <span id="replyText"></span>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden">
    <div class="emoji-category" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>

  <div class="input">
    <button onclick="toggleEmoji()">üòÄ</button>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding:10px;font-weight:600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
  <div id="users"></div>
</div>

<div id="news" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr>
  <div id="posts"></div>
</div>

<div id="friends" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <div id="friendsList"></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
</div>

</div>

<!-- PROFILE VIEW -->
<div id="profileView" class="hidden">
  <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="profileAvatar" id="pAvatar"></div>
  <div class="profileName" id="pName"></div>
  <div class="profileBio" id="pBio"></div>
  <button onclick="writeFromProfile()">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
</div>

<!-- MY PROFILE -->
<div id="myProfile" class="hidden">
  <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="profileAvatar" id="myAvatarPreview">üë§</div>
  <input id="myAvatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)"><br><br>
  <input id="myUsername" placeholder="–ù–∏–∫"><br><br>
  <textarea id="myBio" placeholder="–û —Å–µ–±–µ"></textarea><br><br>
  <button onclick="updateMyProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;
let replyMsg=null;
let profileUid=null;

// –≠–º–æ–¥–∑–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
const emojiCategories = {
  'faces': ['üòÄ','üòÇ','üòä','üòç','üòé','üòú','üò¢','üò°','ü•≥','üò¥','ü§î','ü§©','ü•∫','üòá','ü§Ø','üò±','ü§†','üòà','üëª','ü§ñ'],
  'hands': ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé'],
  'hearts': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü'],
  'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö'],
  'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë','ü•¶','ü•ê'],
  'objects': ['üí°','üì±','üíª','‚åö','üì∑','üéÆ','üîë','üí∞','üíé','‚úèÔ∏è','üìö','üéµ','üé¨','‚öΩ','üèÄ','üéÅ','üéà','üéÄ','üõí','üì¶'],
  'symbols': ['‚≠ê','üåü','üåà','‚òÄÔ∏è','‚òÅÔ∏è','‚ùÑÔ∏è','üî•','üíß','üåä','‚ú®','üéØ','‚úÖ','‚ùå','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','üî¥']
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏
function initEmojiPanel() {
  const categoriesContainer = document.getElementById('emojiCategories');
  const emojiGrid = document.getElementById('emojiGrid');
  
  // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  Object.keys(emojiCategories).forEach((cat, index) => {
    const btn = document.createElement('button');
    btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
    btn.textContent = emojiCategories[cat][0];
    btn.onclick = () => setEmojiCategory(cat);
    categoriesContainer.appendChild(btn);
  });
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  setEmojiCategory('faces');
}

function setEmojiCategory(category) {
  const emojiGrid = document.getElementById('emojiGrid');
  const buttons = document.querySelectorAll('.emoji-category-btn');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ—Ç–∫—É —ç–º–æ–¥–∑–∏
  emojiGrid.innerHTML = '';
  emojiCategories[category].forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.onclick = () => addEmoji(emoji);
    emojiGrid.appendChild(span);
  });
}

/* AUTH */
async function login(){
  try{await auth.createUserWithEmailAndPassword(email.value,password.value);}
  catch{await auth.signInWithEmailAndPassword(email.value,password.value);}
}

auth.onAuthStateChanged(async u=>{
  if(!u){show("auth");return;}
  await db.collection("users").doc(u.uid).update({
    online:true,
    lastSeen: Date.now()
  });
  const d=await db.collection("users").doc(u.uid).get();
  d.exists?startApp(d.data()):show("profileSetup");
});

/* PROFILE SETUP */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid).set({
    username:username.value,
    avatar:avatar.value||"üë§",
    bio:bio.value||"",
    online:true,
    lastSeen: Date.now()
  });
  startApp({username:username.value,avatar:avatar.value});
}

/* START */
function startApp(u){
  show("main");
  me.innerText=`${u.avatar||"üë§"} ${u.username}`;
  loadUsers(); loadPosts(); loadFriends();
  initEmojiPanel();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è
  startLastSeenUpdater();
}

/* TABS */
function openTab(id,el){
  ["chats","news","friends"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

/* USERS */
const cid=(a,b)=>[a,b].sort().join("_");

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è
function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  if (diff < 604800000) return `${Math.floor(diff/86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        const statusText = u.online ? 
          "üü¢ –æ–Ω–ª–∞–π–Ω" : 
          `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        
        users.innerHTML+=`
        <div class="user" onclick="openChat('${d.id}')">
          <div class="avatar" onclick="event.stopPropagation();openProfile('${d.id}')">${u.avatar||"üë§"}</div>
          <div style="flex:1">
            <div>${u.username}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

/* CHAT */
function openChat(uid){
  currentChat = cid(auth.currentUser.uid, uid);

  if(unsub) unsub();

  unsub = db.collection("chats")
    .doc(currentChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const timeStr=new Date(m.time).toLocaleTimeString([],{
          hour:'2-digit',minute:'2-digit'
        });
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
        let statusIcon = '';
        if (m.uid === auth.currentUser.uid) {
          if (m.status === 'sending') statusIcon = 'üîÑ';
          else if (m.status === 'delivered') statusIcon = '‚úì';
          else if (m.status === 'read') statusIcon = 'üëÅÔ∏è‚úì';
          else if (m.status === 'error') statusIcon = '‚ùå';
          else statusIcon = '‚úì'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }
        
        chat.innerHTML+=`
          <div class="msg ${m.uid===auth.currentUser.uid?"me":""}"
            onclick="reply('${m.text}')">
            ${m.replyTo?`<div class="reply-preview">‚Ü© ${m.replyTo}</div>`:""}
            ${m.text}
            <small>${timeStr} ${statusIcon}</small>
          </div>`;
      });
      chat.scrollTop=chat.scrollHeight;
      
      // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
      markMessagesAsRead(uid);
    });
}

/* SEND */
async function send(){
  if(!currentChat||!text.value) return;
  
  // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
  const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const messageData = {
    uid: auth.currentUser.uid,
    text: text.value,
    replyTo: replyMsg,
    time: Date.now(),
    status: 'sending',
    messageId: messageId
  };
  
  try {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await db.collection("chats").doc(currentChat)
      .collection("messages").doc(messageId)
      .set(messageData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"
    await db.collection("chats").doc(currentChat)
      .collection("messages").doc(messageId)
      .update({ status: 'delivered' });
    
    text.value = "";
    cancelReply();
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    try {
      await db.collection("chats").doc(currentChat)
        .collection("messages").doc(messageId)
        .update({ status: 'error' });
    } catch (e) {}
  }
}

// –ü–æ–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
async function markMessagesAsRead(uid) {
  const chatId = cid(auth.currentUser.uid, uid);
  
  try {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    const snapshot = await db.collection("chats").doc(chatId)
      .collection("messages")
      .where("uid", "==", uid)
      .where("status", "in", ["sending", "delivered"])
      .get();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "read"
    const batch = db.batch();
    snapshot.forEach(doc => {
      const ref = db.collection("chats").doc(chatId)
        .collection("messages").doc(doc.id);
      batch.update(ref, { status: 'read' });
    });
    
    if (snapshot.size > 0) {
      await batch.commit();
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ:", error);
  }
}

/* REPLY */
function reply(t){
  replyMsg=t;
  replyText.innerText=t;
  replyBox.classList.remove("hidden");
}
function cancelReply(){
  replyMsg=null;
  replyBox.classList.add("hidden");
}

/* EMOJI */
function toggleEmoji(){
  emojiPanel.classList.toggle("hidden");
}
function addEmoji(e){
  text.value+=e;
  text.focus();
}

/* PROFILE VIEW */
async function openProfile(uid){
  profileUid=uid;
  const d=await db.collection("users").doc(uid).get();
  const u=d.data();
  pAvatar.innerText=u.avatar||"üë§";
  pName.innerText=u.username;
  pBio.innerText=u.bio||"";
  show("profileView");
}
function writeFromProfile(){
  back();
  openChat(profileUid);
}

/* MY PROFILE */
async function openMyProfile(){
  const d=await db.collection("users").doc(auth.currentUser.uid).get();
  const u=d.data();
  myAvatar.value=u.avatar||"üë§";
  myUsername.value=u.username;
  myBio.value=u.bio||"";
  myAvatarPreview.innerText=myAvatar.value;
  show("myProfile");
}
myAvatar.oninput=()=>myAvatarPreview.innerText=myAvatar.value||"üë§";
async function updateMyProfile(){
  await db.collection("users").doc(auth.currentUser.uid).update({
    avatar:myAvatar.value||"üë§",
    username:myUsername.value,
    bio:myBio.value
  });
  me.innerText=`${myAvatar.value} ${myUsername.value}`;
  back();
}

/* NEWS */
function loadPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(s=>{
    posts.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      posts.innerHTML+=`<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
    });
  });
}
function createPost(){
  if(!postText.value)return;
  db.collection("posts").add({
    username:me.innerText,
    text:postText.value,
    time:Date.now()
  });
  postText.value="";
}

/* FRIENDS */
function loadFriends(){
  db.collection("users").onSnapshot(s=>{
    friendsList.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        const statusText = u.online ? 
          "üü¢ –æ–Ω–ª–∞–π–Ω" : 
          `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        
        friendsList.innerHTML+=`
        <div class="user" onclick="openProfile('${d.id}')">
          <div class="avatar">${u.avatar||"üë§"}</div>
          <div style="flex:1">
            <div>${u.username}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

/* UI */
function show(id){
  ["auth","profileSetup","main","profileView","myProfile"]
    .forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function back(){show("main")}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è
function startLastSeenUpdater() {
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  setInterval(async () => {
    if (auth.currentUser) {
      try {
        await db.collection("users").doc(auth.currentUser.uid).update({
          lastSeen: Date.now()
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è lastSeen:", error);
      }
    }
  }, 30000);
}

async function logout(){
  if (auth.currentUser) {
    await db.collection("users").doc(auth.currentUser.uid).update({
      online: false,
      lastSeen: Date.now()
    });
  }
  auth.signOut();
}
</script>
</body>
</html>
