<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
}
.hidden{display:none}
.auth{
  max-width:360px;
  margin:120px auto;
  padding:20px;
}
.auth h2{text-align:center}
.auth input,.auth button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
}
.auth button{
  background:#2ecc71;
  font-weight:600;
}
.chat{
  max-width:700px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px;
  background:#17212b;
  font-weight:600;
}
.messages{
  flex:1;
  padding:10px;
  overflow:auto;
}
.msg{
  margin:6px 0;
  padding:8px 12px;
  border-radius:12px;
  max-width:70%;
}
.me{background:#2b5278;margin-left:auto}
.other{background:#182533}
.footer{
  display:flex;
  gap:10px;
  padding:10px;
  background:#17212b;
}
.footer input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
}
.footer button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#2ecc71;
  font-weight:600;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Пароль (6+)">
  <button onclick="smartAuth()">Войти / Регистрация</button>
</div>

<!-- CHAT -->
<div id="chat" class="chat hidden">
  <div class="header">
    Общий чат
    <button onclick="logout()" style="float:right">Выйти</button>
  </div>
  <div id="messages" class="messages"></div>
  <div class="footer">
    <input id="text" placeholder="Сообщение">
    <button onclick="send()">➤</button>
  </div>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ===== AUTH ===== */
async function smartAuth(){
  const e = email.value.trim();
  const p = password.value.trim();

  if(!e || !p){
    alert("Введите email и пароль");
    return;
  }

  try{
    await auth.signInWithEmailAndPassword(e,p);
  }catch(err){
    if(err.code==="auth/user-not-found"){
      try{
        await auth.createUserWithEmailAndPassword(e,p);
      }catch(e2){
        alert(e2.message);
      }
    }else{
      alert(err.message);
    }
  }
}

function logout(){
  auth.signOut();
}

/* ===== STATE ===== */
auth.onAuthStateChanged(async user=>{
  if(!user){
    authDiv();
    return;
  }

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();
  if(!snap.exists){
    await ref.set({
      name: user.email.split("@")[0],
      created: Date.now()
    });
  }

  chatDiv();
  loadMessages();
});

function authDiv(){
  document.getElementById("auth").classList.remove("hidden");
  document.getElementById("chat").classList.add("hidden");
}
function chatDiv(){
  document.getElementById("auth").classList.add("hidden");
  document.getElementById("chat").classList.remove("hidden");
}

/* ===== CHAT ===== */
function loadMessages(){
  db.collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      messages.innerHTML="";
      snap.forEach(doc=>{
        const m = doc.data();
        messages.innerHTML += `
          <div class="msg ${m.uid===auth.currentUser.uid?"me":"other"}">
            ${m.text}
          </div>`;
      });
      messages.scrollTop = messages.scrollHeight;
    });
}

function send(){
  if(!text.value) return;
  db.collection("messages").add({
    uid: auth.currentUser.uid,
    text: text.value,
    time: Date.now()
  });
  text.value="";
}
</script>

</body>
</html>
