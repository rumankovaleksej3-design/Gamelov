<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
}
.tab{
  flex:1;
  padding:12px;
  text-align:center;
  cursor:pointer;
  opacity:.6;
}
.tab.active{opacity:1;background:#1e293b}

/* CHAT */
#chats{flex:1;display:flex;flex-direction:column}
.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#020617;
}
.msg{
  max-width:80%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:12px;
  background:#1e293b;
}
.me{margin-left:auto;background:#2563eb}
.msg small{
  display:block;
  font-size:11px;
  opacity:.6;
  text-align:right;
}
.reply-preview{
  font-size:12px;
  opacity:.7;
  border-left:2px solid #60a5fa;
  padding-left:6px;
  margin-bottom:4px;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  border:none;
  border-radius:8px;
  padding:10px;
  background:#22c55e;
  font-weight:600;
  cursor:pointer;
}

/* –ù–û–í–´–ï –°–¢–ò–õ–ò: –≠–ú–û–î–ó–ò –ü–ê–ù–ï–õ–¨ */
.emoji-category {
  display: flex;
  overflow-x: auto;
  gap: 5px;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid #334155;
}

.emoji-category-btn {
  background: #1e293b;
  border: none;
  color: white;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
  font-size: 12px;
}

.emoji-category-btn.active {
  background: #3b82f6;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 5px;
  max-height: 150px;
  overflow-y: auto;
  padding: 5px 0;
}

.emoji-grid span {
  font-size: 20px;
  text-align: center;
  cursor: pointer;
  padding: 2px;
  border-radius: 4px;
}

.emoji-grid span:hover {
  background: #1e293b;
}

/* USERS */
.user{
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
}
.status{font-size:10px; opacity:0.8; margin-top:2px;}

/* POSTS */
.post{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

/* –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–§–ò–õ–¨ */
.profile-header {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  padding: 20px;
  text-align: center;
  position: relative;
}

.profile-back-btn {
  position: absolute;
  left: 10px;
  top: 20px;
  background: rgba(0,0,0,0.3);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 20px;
  cursor: pointer;
}

.profile-avatar {
  font-size: 64px;
  width: 100px;
  height: 100px;
  margin: 0 auto 15px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 4px solid white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.profile-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 5px;
}

.profile-status {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 15px;
}

.profile-stats {
  display: flex;
  justify-content: space-around;
  padding: 15px;
  background: #020617;
  border-radius: 12px;
  margin: 15px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #60a5fa;
}

.stat-label {
  font-size: 12px;
  opacity: 0.7;
}

.profile-section {
  padding: 15px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  color: #60a5fa;
}

.profile-bio {
  background: #020617;
  padding: 15px;
  border-radius: 12px;
  line-height: 1.5;
}

.profile-actions {
  padding: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.action-btn {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: #1e293b;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-weight: 500;
}

.action-btn.primary {
  background: #3b82f6;
}

.action-btn.danger {
  background: #ef4444;
}

.action-btn.success {
  background: #22c55e;
}

.profile-info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.info-item {
  background: #020617;
  padding: 12px;
  border-radius: 8px;
}

.info-label {
  font-size: 12px;
  opacity: 0.7;
  margin-bottom: 4px;
}

.info-value {
  font-size: 14px;
  font-weight: 500;
}

/* –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å - —Ä–µ–¥–∞–∫—Ç–æ—Ä */
.avatar-selector {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.avatar-option {
  font-size: 24px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #1e293b;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
}

.avatar-option.selected {
  border-color: #3b82f6;
  background: #1e40af;
}

.status-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.status-option {
  flex: 1;
  padding: 8px;
  text-align: center;
  background: #1e293b;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
}

.status-option.selected {
  border-color: #3b82f6;
}

/* Theme selector */
.theme-options {
  display: flex;
  gap: 10px;
  margin: 10px 0;
}

.theme-option {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
}

.theme-option.selected {
  border-color: white;
}

/* Online indicator */
.online-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 5px;
}

.online-indicator.online {
  background: #22c55e;
  box-shadow: 0 0 5px #22c55e;
}

.online-indicator.offline {
  background: #6b7280;
}

/* –°–¢–ê–¢–£–° –°–û–û–ë–©–ï–ù–ò–ô */
.msg-status {
  font-size: 10px;
  margin-left: 4px;
}

/* Quick actions */
.quick-actions {
  display: flex;
  gap: 10px;
  padding: 15px;
  background: #020617;
  border-top: 1px solid #334155;
}

.quick-action-btn {
  flex: 1;
  text-align: center;
  padding: 10px;
  background: #1e293b;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}

.quick-action-btn:hover {
  background: #334155;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <div class="profile-header">
    <div class="profile-avatar" id="setupAvatarPreview">üë§</div>
    <div class="profile-name">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
    <div class="avatar-selector" id="avatarSelectorSetup">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'setup')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'setup')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'setup')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'setup')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'setup')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'setup')">üëë</div>
    </div>
    
    <input id="username" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0"><br>
    
    <div class="section-title">–°—Ç–∞—Ç—É—Å</div>
    <div class="status-selector" id="statusSelectorSetup">
      <div class="status-option selected" onclick="selectStatus('online', 'setup')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'setup')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'setup')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <textarea id="bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." style="width:100%;height:80px;margin:10px 0"></textarea><br>
    
    <button onclick="saveProfile()" style="width:100%;padding:12px;background:#3b82f6">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
<header>
  <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div id="replyBox" class="hidden" style="padding:6px;background:#020617">
    –û—Ç–≤–µ—Ç: <span id="replyText"></span>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden">
    <div class="emoji-category" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>

  <div class="input">
    <button onclick="toggleEmoji()">üòÄ</button>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding:10px;font-weight:600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
  <div id="users"></div>
</div>

<div id="news" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr>
  <div id="posts"></div>
</div>

<div id="friends" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <div id="friendsList"></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
</div>

</div>

<!-- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø –î–†–£–ì–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø -->
<div id="profileView" class="hidden">
  <div class="profile-header">
    <button class="profile-back-btn" onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="pAvatar"></div>
    <div class="profile-name" id="pName"></div>
    <div class="profile-status" id="pStatus"></div>
  </div>
  
  <div class="profile-stats">
    <div class="stat-item">
      <div class="stat-value" id="pMessages">0</div>
      <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pFriends">0</div>
      <div class="stat-label">–î—Ä—É–∑–µ–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pPosts">0</div>
      <div class="stat-label">–ü–æ—Å—Ç–æ–≤</div>
    </div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">–û —Å–µ–±–µ</div>
    <div class="profile-bio" id="pBio">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
    <div class="profile-info-grid">
      <div class="info-item">
        <div class="info-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        <div class="info-value" id="pJoined">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤ —Å–µ—Ç–∏</div>
        <div class="info-value" id="pLastSeen">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">–°—Ç–∞—Ç—É—Å</div>
        <div class="info-value" id="pOnlineStatus">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">ID</div>
        <div class="info-value" style="font-size:10px" id="pId">-</div>
      </div>
    </div>
  </div>
  
  <div class="profile-actions">
    <button class="action-btn primary" onclick="writeFromProfile()">
      ‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å
    </button>
    <button class="action-btn" onclick="toggleFriend()" id="friendBtn">
      ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
    </button>
    <button class="action-btn danger" onclick="blockUser()" id="blockBtn">
      üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>
</div>

<!-- –ú–û–ô –ü–†–û–§–ò–õ–¨ (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) -->
<div id="myProfile" class="hidden">
  <div class="profile-header">
    <button class="profile-back-btn" onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="myAvatarPreview">üë§</div>
    <div class="profile-name">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <div class="profile-status" id="myStatusPreview">üü¢ –í —Å–µ—Ç–∏</div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
    <input id="myUsername" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;margin:5px 0">
    
    <div class="section-title">–ê–≤–∞—Ç–∞—Ä</div>
    <div class="avatar-selector" id="avatarSelector">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'my')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'my')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'my')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'my')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'my')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'my')">üëë</div>
    </div>
    <input id="myAvatarCustom" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —ç–º–æ–¥–∑–∏" style="width:100%;margin:10px 0">
    
    <div class="section-title">–°—Ç–∞—Ç—É—Å</div>
    <div class="status-selector" id="statusSelector">
      <div class="status-option selected" onclick="selectStatus('online', 'my')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'my')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('away', 'my')">üü† –û—Ç–æ—à–µ–ª</div>
      <div class="status-option" onclick="selectStatus('invisible', 'my')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <div class="section-title">–û —Å–µ–±–µ</div>
    <textarea id="myBio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." style="width:100%;height:100px"></textarea>
    
    <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
      <input type="checkbox" id="showOnline" checked style="width:20px;height:20px">
      <label for="showOnline">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å</label>
    </div>
    
    <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
      <input type="checkbox" id="allowMessages" checked style="width:20px;height:20px">
      <label for="allowMessages">–†–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –≤—Å–µ—Ö</label>
    </div>
    
    <button class="action-btn success" onclick="updateMyProfile()" style="width:100%;margin-top:20px">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
  </div>
  
  <div class="quick-actions">
    <div class="quick-action-btn" onclick="showMyStats()">
      üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </div>
    <div class="quick-action-btn" onclick="exportMyData()">
      üìÅ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    </div>
    <div class="quick-action-btn" onclick="deleteAccount()">
      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
    </div>
  </div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;
let replyMsg=null;
let profileUid=null;
let selectedAvatar = 'üë§';
let selectedStatus = 'online';
let selectedAvatarType = 'my';

// –≠–º–æ–¥–∑–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
const emojiCategories = {
  'faces': ['üòÄ','üòÇ','üòä','üòç','üòé','üòú','üò¢','üò°','ü•≥','üò¥','ü§î','ü§©','ü•∫','üòá','ü§Ø','üò±','ü§†','üòà','üëª','ü§ñ'],
  'hands': ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé'],
  'hearts': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü'],
  'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö'],
  'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë','ü•¶','ü•ê'],
  'objects': ['üí°','üì±','üíª','‚åö','üì∑','üéÆ','üîë','üí∞','üíé','‚úèÔ∏è','üìö','üéµ','üé¨','‚öΩ','üèÄ','üéÅ','üéà','üéÄ','üõí','üì¶'],
  'symbols': ['‚≠ê','üåü','üåà','‚òÄÔ∏è','‚òÅÔ∏è','‚ùÑÔ∏è','üî•','üíß','üåä','‚ú®','üéØ','‚úÖ','‚ùå','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','üî¥']
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏
function initEmojiPanel() {
  const categoriesContainer = document.getElementById('emojiCategories');
  const emojiGrid = document.getElementById('emojiGrid');
  
  Object.keys(emojiCategories).forEach((cat, index) => {
    const btn = document.createElement('button');
    btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
    btn.textContent = emojiCategories[cat][0];
    btn.onclick = () => setEmojiCategory(cat);
    categoriesContainer.appendChild(btn);
  });
  
  setEmojiCategory('faces');
}

function setEmojiCategory(category) {
  const emojiGrid = document.getElementById('emojiGrid');
  const buttons = document.querySelectorAll('.emoji-category-btn');
  
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  emojiGrid.innerHTML = '';
  emojiCategories[category].forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.onclick = () => addEmoji(emoji);
    emojiGrid.appendChild(span);
  });
}

// –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
function selectAvatar(avatar, type) {
  selectedAvatar = avatar;
  selectedAvatarType = type;
  
  const selector = type === 'setup' ? '#avatarSelectorSetup' : '#avatarSelector';
  document.querySelectorAll(`${selector} .avatar-option`).forEach(option => {
    option.classList.remove('selected');
  });
  event.target.classList.add('selected');
  
  if (type === 'setup') {
    document.getElementById('setupAvatarPreview').textContent = avatar;
  } else {
    document.getElementById('myAvatarPreview').textContent = avatar;
    document.getElementById('myAvatarCustom').value = avatar;
  }
}

// –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
function selectStatus(status, type) {
  selectedStatus = status;
  
  const selector = type === 'setup' ? '#statusSelectorSetup' : '#statusSelector';
  document.querySelectorAll(`${selector} .status-option`).forEach(option => {
    option.classList.remove('selected');
  });
  event.target.classList.add('selected');
  
  if (type === 'my') {
    const statusText = {
      'online': 'üü¢ –í —Å–µ—Ç–∏',
      'busy': 'üü° –ó–∞–Ω—è—Ç',
      'away': 'üü† –û—Ç–æ—à–µ–ª',
      'invisible': '‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞'
    };
    document.getElementById('myStatusPreview').textContent = statusText[status];
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
function getStatusText(status) {
  const statuses = {
    'online': '–í —Å–µ—Ç–∏',
    'busy': '–ó–∞–Ω—è—Ç',
    'away': '–û—Ç–æ—à–µ–ª',
    'invisible': '–ù–µ –≤ —Å–µ—Ç–∏',
    'offline': '–ù–µ –≤ —Å–µ—Ç–∏'
  };
  return statuses[status] || '–ù–µ –≤ —Å–µ—Ç–∏';
}

/* AUTH */
async function login(){
  try{await auth.createUserWithEmailAndPassword(email.value,password.value);}
  catch{await auth.signInWithEmailAndPassword(email.value,password.value);}
}

auth.onAuthStateChanged(async u=>{
  if(!u){show("auth");return;}
  await db.collection("users").doc(u.uid).update({
    online:true,
    lastSeen: Date.now(),
    status: 'online'
  });
  const d=await db.collection("users").doc(u.uid).get();
  d.exists?startApp(d.data()):show("profileSetup");
});

/* PROFILE SETUP */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid).set({
    username: username.value || `User${Math.floor(Math.random()*10000)}`,
    avatar: selectedAvatar || "üë§",
    bio: bio.value || "",
    online: true,
    lastSeen: Date.now(),
    status: selectedStatus,
    createdAt: Date.now(),
    showOnline: true,
    allowMessages: true,
    friends: [],
    blocked: [],
    stats: {
      messages: 0,
      posts: 0,
      friends: 0
    }
  });
  startApp({username: username.value, avatar: selectedAvatar});
}

/* START */
function startApp(u){
  show("main");
  me.innerText=`${u.avatar||"üë§"} ${u.username}`;
  loadUsers(); loadPosts(); loadFriends();
  initEmojiPanel();
  startLastSeenUpdater();
}

/* TABS */
function openTab(id,el){
  ["chats","news","friends"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

/* USERS */
const cid=(a,b)=>[a,b].sort().join("_");

function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  if (diff < 604800000) return `${Math.floor(diff/86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        let statusText = '';
        
        if (u.status === 'invisible') {
          statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
        } else if (u.online && u.showOnline !== false) {
          statusText = `üü¢ ${getStatusText(u.status || 'online')}`;
        } else {
          statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        }
        
        users.innerHTML+=`
        <div class="user" onclick="openChat('${d.id}')">
          <div class="avatar" onclick="event.stopPropagation();openProfile('${d.id}')">${u.avatar||"üë§"}</div>
          <div style="flex:1">
            <div>${u.username}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

/* –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø */
async function openProfile(uid){
  profileUid = uid;
  const d = await db.collection("users").doc(uid).get();
  const u = d.data();
  
  // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  document.getElementById('pAvatar').textContent = u.avatar || "üë§";
  document.getElementById('pName').textContent = u.username;
  document.getElementById('pBio').textContent = u.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ";
  document.getElementById('pId').textContent = uid.substring(0, 8) + '...';
  
  // –°—Ç–∞—Ç—É—Å
  if (u.status === 'invisible') {
    document.getElementById('pStatus').textContent = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
    document.getElementById('pOnlineStatus').textContent = '–ù–µ –≤ —Å–µ—Ç–∏';
  } else if (u.online && u.showOnline !== false) {
    document.getElementById('pStatus').textContent = `üü¢ ${getStatusText(u.status || 'online')}`;
    document.getElementById('pOnlineStatus').textContent = getStatusText(u.status || 'online');
  } else {
    document.getElementById('pStatus').textContent = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
    document.getElementById('pOnlineStatus').textContent = '–ù–µ –≤ —Å–µ—Ç–∏';
  }
  
  // –í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  if (u.createdAt) {
    const joinDate = new Date(u.createdAt);
    document.getElementById('pJoined').textContent = joinDate.toLocaleDateString('ru-RU');
  }
  
  // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤ —Å–µ—Ç–∏
  document.getElementById('pLastSeen').textContent = formatLastSeen(u.lastSeen);
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  document.getElementById('pMessages').textContent = u.stats?.messages || 0;
  document.getElementById('pFriends').textContent = u.stats?.friends || 0;
  document.getElementById('pPosts').textContent = u.stats?.posts || 0;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö
  const myData = await db.collection("users").doc(auth.currentUser.uid).get();
  const myFriends = myData.data()?.friends || [];
  const friendBtn = document.getElementById('friendBtn');
  
  if (myFriends.includes(uid)) {
    friendBtn.innerHTML = 'ü§ù –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
    friendBtn.classList.add('danger');
  } else {
    friendBtn.innerHTML = 'ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑–µ–π';
    friendBtn.classList.remove('danger');
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const myBlocked = myData.data()?.blocked || [];
  const blockBtn = document.getElementById('blockBtn');
  
  if (myBlocked.includes(uid)) {
    blockBtn.innerHTML = '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
    blockBtn.classList.add('success');
  } else {
    blockBtn.innerHTML = 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
    blockBtn.classList.remove('success');
  }
  
  show("profileView");
}

// –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π
async function toggleFriend() {
  if (!profileUid) return;
  
  const myRef = db.collection("users").doc(auth.currentUser.uid);
  const myData = await myRef.get();
  const myFriends = myData.data()?.friends || [];
  
  if (myFriends.includes(profileUid)) {
    // –£–¥–∞–ª—è–µ–º –∏–∑ –¥—Ä—É–∑–µ–π
    await myRef.update({
      friends: firebase.firestore.FieldValue.arrayRemove(profileUid),
      'stats.friends': firebase.firestore.FieldValue.increment(-1)
    });
    document.getElementById('friendBtn').innerHTML = 'ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑–µ–π';
    document.getElementById('friendBtn').classList.remove('danger');
  } else {
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥—Ä—É–∑–µ–π
    await myRef.update({
      friends: firebase.firestore.FieldValue.arrayUnion(profileUid),
      'stats.friends': firebase.firestore.FieldValue.increment(1)
    });
    document.getElementById('friendBtn').innerHTML = 'ü§ù –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
    document.getElementById('friendBtn').classList.add('danger');
  }
}

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function blockUser() {
  if (!profileUid) return;
  
  const myRef = db.collection("users").doc(auth.currentUser.uid);
  const myData = await myRef.get();
  const myBlocked = myData.data()?.blocked || [];
  
  if (myBlocked.includes(profileUid)) {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    await myRef.update({
      blocked: firebase.firestore.FieldValue.arrayRemove(profileUid)
    });
    document.getElementById('blockBtn').innerHTML = 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
    document.getElementById('blockBtn').classList.remove('success');
  } else {
    // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    await myRef.update({
      blocked: firebase.firestore.FieldValue.arrayUnion(profileUid),
      friends: firebase.firestore.FieldValue.arrayRemove(profileUid)
    });
    document.getElementById('blockBtn').innerHTML = '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
    document.getElementById('blockBtn').classList.add('success');
    document.getElementById('friendBtn').innerHTML = 'ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑–µ–π';
    document.getElementById('friendBtn').classList.remove('danger');
  }
}

function writeFromProfile(){
  back();
  openChat(profileUid);
}

/* –ú–û–ô –ü–†–û–§–ò–õ–¨ */
async function openMyProfile(){
  const d = await db.collection("users").doc(auth.currentUser.uid).get();
  const u = d.data();
  
  document.getElementById('myUsername').value = u.username;
  document.getElementById('myBio').value = u.bio || "";
  document.getElementById('myAvatarCustom').value = u.avatar || "üë§";
  document.getElementById('myAvatarPreview').textContent = u.avatar || "üë§";
  document.getElementById('showOnline').checked = u.showOnline !== false;
  document.getElementById('allowMessages').checked = u.allowMessages !== false;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
  selectedStatus = u.status || 'online';
  const statusText = {
    'online': 'üü¢ –í —Å–µ—Ç–∏',
    'busy': 'üü° –ó–∞–Ω—è—Ç',
    'away': 'üü† –û—Ç–æ—à–µ–ª',
    'invisible': '‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞'
  };
  document.getElementById('myStatusPreview').textContent = statusText[selectedStatus];
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  document.querySelectorAll('#statusSelector .status-option').forEach(option => {
    option.classList.remove('selected');
    if (option.textContent.includes(statusText[selectedStatus].substring(2))) {
      option.classList.add('selected');
    }
  });
  
  // –í—ã–±–∏—Ä–∞–µ–º –∞–≤–∞—Ç–∞—Ä
  document.querySelectorAll('#avatarSelector .avatar-option').forEach(option => {
    option.classList.remove('selected');
    if (option.textContent === u.avatar) {
      option.classList.add('selected');
    }
  });
  
  show("myProfile");
}

// –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤–∞—Ç–∞—Ä
document.getElementById('myAvatarCustom').oninput = function() {
  document.getElementById('myAvatarPreview').textContent = this.value || "üë§";
};

async function updateMyProfile(){
  const updateData = {
    avatar: document.getElementById('myAvatarCustom').value || selectedAvatar,
    username: document.getElementById('myUsername').value,
    bio: document.getElementById('myBio').value,
    status: selectedStatus,
    showOnline: document.getElementById('showOnline').checked,
    allowMessages: document.getElementById('allowMessages').checked
  };
  
  await db.collection("users").doc(auth.currentUser.uid).update(updateData);
  
  me.innerText = `${updateData.avatar} ${updateData.username}`;
  back();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
async function showMyStats() {
  const d = await db.collection("users").doc(auth.currentUser.uid).get();
  const u = d.data();
  
  alert(`üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n` +
        `–°–æ–æ–±—â–µ–Ω–∏–π: ${u.stats?.messages || 0}\n` +
        `–ü–æ—Å—Ç–æ–≤: ${u.stats?.posts || 0}\n` +
        `–î—Ä—É–∑–µ–π: ${u.stats?.friends || 0}\n` +
        `–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${u.createdAt ? new Date(u.createdAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
async function exportMyData() {
  const d = await db.collection("users").doc(auth.currentUser.uid).get();
  const data = d.data();
  
  // –°–æ–∑–¥–∞–µ–º JSON —Ñ–∞–π–ª
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `chatnet_data_${new Date().getTime()}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
async function deleteAccount() {
  if (confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ: –ø—Ä–æ—Ñ–∏–ª—å, —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ—Å—Ç—ã.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) {
    if (confirm("–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å! –ù–∞–ø–∏—à–∏—Ç–µ '–£–î–ê–õ–ò–¢–¨' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:")) {
      // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
      alert("–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ");
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ:
      // 1. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      // 2. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã
      // 3. –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
      // 4. –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    }
  }
}

/* CHAT, SEND, REPLY, EMOJI - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ */
function openChat(uid){
  currentChat = cid(auth.currentUser.uid, uid);
  if(unsub) unsub();
  unsub = db.collection("chats").doc(currentChat).collection("messages").orderBy("time").onSnapshot(s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const timeStr=new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      let statusIcon = '';
      if (m.uid === auth.currentUser.uid) {
        if (m.status === 'sending') statusIcon = 'üîÑ';
        else if (m.status === 'delivered') statusIcon = '‚úì';
        else if (m.status === 'read') statusIcon = 'üëÅÔ∏è‚úì';
        else if (m.status === 'error') statusIcon = '‚ùå';
        else statusIcon = '‚úì';
      }
      chat.innerHTML+=`
        <div class="msg ${m.uid===auth.currentUser.uid?"me":""}" onclick="reply('${m.text}')">
          ${m.replyTo?`<div class="reply-preview">‚Ü© ${m.replyTo}</div>`:""}
          ${m.text}
          <small>${timeStr} ${statusIcon}</small>
        </div>`;
    });
    chat.scrollTop=chat.scrollHeight;
    markMessagesAsRead(uid);
  });
}

async function send(){
  if(!currentChat||!text.value) return;
  const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const messageData = {
    uid: auth.currentUser.uid,
    text: text.value,
    replyTo: replyMsg,
    time: Date.now(),
    status: 'sending',
    messageId: messageId
  };
  try {
    await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).set(messageData);
    await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).update({ status: 'delivered' });
    text.value = "";
    cancelReply();
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
    await db.collection("users").doc(auth.currentUser.uid).update({
      'stats.messages': firebase.firestore.FieldValue.increment(1)
    });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
    try {
      await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).update({ status: 'error' });
    } catch (e) {}
  }
}

async function markMessagesAsRead(uid) {
  const chatId = cid(auth.currentUser.uid, uid);
  try {
    const snapshot = await db.collection("chats").doc(chatId).collection("messages")
      .where("uid", "==", uid).where("status", "in", ["sending", "delivered"]).get();
    const batch = db.batch();
    snapshot.forEach(doc => {
      const ref = db.collection("chats").doc(chatId).collection("messages").doc(doc.id);
      batch.update(ref, { status: 'read' });
    });
    if (snapshot.size > 0) await batch.commit();
  } catch (error) {}
}

function reply(t){ replyMsg=t; replyText.innerText=t; replyBox.classList.remove("hidden"); }
function cancelReply(){ replyMsg=null; replyBox.classList.add("hidden"); }
function toggleEmoji(){ emojiPanel.classList.toggle("hidden"); }
function addEmoji(e){ text.value+=e; text.focus(); }

/* NEWS */
function loadPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(s=>{
    posts.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      posts.innerHTML+=`<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
    });
  });
}
async function createPost(){
  if(!postText.value) return;
  await db.collection("posts").add({
    username: me.innerText,
    text: postText.value,
    time: Date.now(),
    uid: auth.currentUser.uid
  });
  postText.value="";
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å—Ç–æ–≤
  await db.collection("users").doc(auth.currentUser.uid).update({
    'stats.posts': firebase.firestore.FieldValue.increment(1)
  });
}

/* FRIENDS */
function loadFriends(){
  db.collection("users").onSnapshot(s=>{
    friendsList.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        let statusText = '';
        if (u.status === 'invisible') {
          statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
        } else if (u.online && u.showOnline !== false) {
          statusText = `üü¢ ${getStatusText(u.status || 'online')}`;
        } else {
          statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        }
        friendsList.innerHTML+=`
        <div class="user" onclick="openProfile('${d.id}')">
          <div class="avatar">${u.avatar||"üë§"}</div>
          <div style="flex:1">
            <div>${u.username}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

/* UI */
function show(id){
  ["auth","profileSetup","main","profileView","myProfile"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function back(){ show("main") }

function startLastSeenUpdater() {
  setInterval(async () => {
    if (auth.currentUser) {
      try {
        await db.collection("users").doc(auth.currentUser.uid).update({
          lastSeen: Date.now()
        });
      } catch (error) {}
    }
  }, 30000);
}

async function logout(){
  if (auth.currentUser) {
    await db.collection("users").doc(auth.currentUser.uid).update({
      online: false,
      lastSeen: Date.now(),
      status: 'offline'
    });
  }
  auth.signOut();
}
</script>
</body>
</html>
