<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet Pro</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: #0f172a;
  color: #e2e8f0;
  height: 100vh;
  overflow: hidden;
}

.hidden {
  display: none !important;
}

.container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
#auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 40px 20px;
}

#auth h2 {
  font-size: 3rem;
  color: white;
  margin-bottom: 40px;
  font-weight: 800;
  background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

#auth input {
  width: 100%;
  max-width: 320px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  background: rgba(30, 41, 59, 0.8);
  color: white;
  font-size: 16px;
}

#auth button {
  width: 100%;
  max-width: 320px;
  padding: 16px;
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

/* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
#main {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* –®–ê–ü–ö–ê */
header {
  background: rgba(15, 23, 42, 0.95);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#me {
  font-size: 18px;
  font-weight: 600;
  color: #e2e8f0;
  cursor: pointer;
  padding: 10px 18px;
  border-radius: 12px;
  background: rgba(30, 41, 59, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.header-actions {
  display: flex;
  gap: 10px;
}

.header-btn {
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
  cursor: pointer;
  font-size: 14px;
}

/* –í–ö–õ–ê–î–ö–ò */
.tabs {
  display: flex;
  background: rgba(15, 23, 42, 0.95);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding: 0 20px;
}

.tab {
  flex: 1;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  font-weight: 500;
  color: #94a3b8;
  border-bottom: 3px solid transparent;
}

.tab.active {
  color: #60a5fa;
  border-bottom-color: #60a5fa;
  font-weight: 600;
}

/* –ß–ê–¢–´ */
#chats {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#users {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.user {
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  border-radius: 16px;
  margin-bottom: 10px;
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.user:hover {
  background: rgba(51, 65, 85, 0.6);
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
}

.user-info div:first-child {
  font-weight: 600;
  color: #f1f5f9;
  margin-bottom: 4px;
}

.status {
  font-size: 13px;
  color: #94a3b8;
}

/* –û–ö–ù–û –ß–ê–¢–ê */
.chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.msg {
  max-width: 75%;
  padding: 14px 18px;
  margin: 8px 0;
  border-radius: 18px;
  background: rgba(30, 41, 59, 0.8);
  word-wrap: break-word;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.msg.me {
  margin-left: auto;
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
}

.msg small {
  display: block;
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 6px;
}

/* –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê */
.input {
  display: flex;
  gap: 12px;
  padding: 20px;
  background: rgba(15, 23, 42, 0.95);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.input input {
  flex: 1;
  padding: 16px 20px;
  border-radius: 25px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  font-size: 16px;
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
}

.input button {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  font-size: 20px;
}

/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-title {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 20px;
  color: white;
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
}

/* –ü–†–û–§–ò–õ–ò */
.profile-header {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 50px 20px 30px;
  text-align: center;
}

.profile-avatar {
  font-size: 64px;
  width: 120px;
  height: 120px;
  margin: 0 auto 25px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  background: #1e293b;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 1000;
  max-width: 300px;
}

/* –°–ö–†–û–õ–õ–ë–ê–† */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-thumb {
  background: #3b82f6;
  border-radius: 4px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
<div id="auth">
  <h2>ChatNet Pro</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <div class="profile-header">
    <div class="profile-avatar" id="setupAvatarPreview">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: white;">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
  </div>
  
  <div style="padding: 20px;">
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
    <div id="avatarSelectorSetup" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 20px 0;">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'setup')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'setup')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'setup')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'setup')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'setup')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'setup')">üëë</div>
    </div>
    
    <input id="username" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;"><br>
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–°—Ç–∞—Ç—É—Å</div>
    <div id="statusSelectorSetup" style="display: flex; gap: 12px; margin: 20px 0;">
      <div class="status-option selected" onclick="selectStatus('online', 'setup')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'setup')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'setup')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <button onclick="saveProfile()" style="width:100%;padding:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 12px; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
<div id="main" class="hidden">
<header>
  <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
  <div class="header-actions">
    <button class="header-btn" onclick="showGroupCreation()">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    <button class="header-btn" onclick="showThemeSelector()">üé® –¢–µ–º—ã</button>
    <button class="header-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
  </div>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div class="input">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key=='Enter') send()">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding: 20px; font-weight: 600; color: #f1f5f9; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  </div>
  <div id="users"></div>
</div>

<div id="news" class="hidden">
  <div style="padding: 24px;">
    <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" style="width:100%;padding:18px 20px;border:2px solid rgba(255,255,255,0.1);border-radius:16px;background:rgba(30,41,59,0.8);color:#e2e8f0;min-height:120px;margin-bottom:20px;"></textarea><br>
    <button onclick="createPost()" style="padding:14px 30px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </div>
  <div id="posts"></div>
</div>

<div id="friends" class="hidden">
  <div style="padding:24px;">
    <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 20px; font-size: 18px;">–î—Ä—É–∑—å—è</div>
    <div id="friendsList"></div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
  <div class="tab" onclick="showModerationPanel()">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</div>
</div>

</div>

<!-- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø -->
<div id="profileView" class="hidden">
  <div class="profile-header">
    <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer;">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="pAvatar">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;" id="pName"></div>
    <div style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;" id="pStatus"></div>
  </div>
  
  <div style="padding: 20px;">
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–û —Å–µ–±–µ</div>
    <div id="pBio" style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 16px; line-height: 1.6;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</div>
    
    <div style="margin-top: 30px; display: flex; gap: 12px;">
      <button onclick="writeFromProfile()" style="flex:1;padding:14px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;cursor:pointer;">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
      <button onclick="toggleFriend()" id="friendBtn" style="flex:1;padding:14px;background:rgba(30,41,59,0.8);color:#e2e8f0;border:1px solid rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;">ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
    </div>
  </div>
</div>

<!-- –ú–û–ô –ü–†–û–§–ò–õ–¨ -->
<div id="myProfile" class="hidden">
  <div class="profile-header">
    <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer;">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="myAvatarPreview">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <div style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;" id="myStatusPreview">üü¢ –í —Å–µ—Ç–∏</div>
  </div>
  
  <div style="padding: 20px;">
    <input id="myUsername" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;">
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–ê–≤–∞—Ç–∞—Ä</div>
    <div id="avatarSelector" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 20px 0;">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'my')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'my')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'my')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'my')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'my')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'my')">üëë</div>
    </div>
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–°—Ç–∞—Ç—É—Å</div>
    <div id="statusSelector" style="display: flex; gap: 12px; margin: 20px 0;">
      <div class="status-option selected" onclick="selectStatus('online', 'my')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'my')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'my')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <button onclick="updateMyProfile()" style="width:100%;padding:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-top:20px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

<!-- –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü–´ -->
<div id="groupCreationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('groupCreationModal')">√ó</button>
    <div class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</div>
    
    <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%;margin-bottom:15px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:white;">
    
    <div style="margin: 15px 0;">
      <div style="font-weight:600;margin-bottom:10px;color:white;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</div>
      <div id="groupMembersList" style="max-height:200px;overflow-y:auto;padding:10px;background:rgba(30,41,59,0.6);border-radius:8px;"></div>
    </div>
    
    <button onclick="createGroup()" style="width:100%;padding:14px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
  </div>
</div>

<!-- –ú–û–î–ï–†–ê–¶–ò–Ø -->
<div id="moderationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('moderationModal')">√ó</button>
    <div class="modal-title">–ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
    
    <div style="margin: 20px 0;">
      <div id="reportsList" style="max-height:300px;overflow-y:auto;padding:10px;background:rgba(30,41,59,0.6);border-radius:8px;">
        <div style="text-align:center;padding:20px;color:white;opacity:0.7;">–ù–µ—Ç –∂–∞–ª–æ–±</div>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;">
      <button onclick="loadReports()" style="flex:1;padding:12px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:8px;cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button onclick="showUserManagement()" style="flex:1;padding:12px;background:rgba(30,41,59,0.8);color:white;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
    </div>
  </div>
</div>

</div>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
firebase.initializeApp({
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentChat = null;
let currentChatType = 'private';
let unsub = null;
let replyMsg = null;
let selectedGroupMembers = new Set();
let profileUid = null;

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  if (!email || !password) {
    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  try {
    // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏
    await auth.signInWithEmailAndPassword(email, password);
    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
  } catch (error) {
    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞, –ø—Ä–æ–±—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
    if (error.code === 'auth/user-not-found') {
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
      } catch (regError) {
        showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + regError.message, 'error');
      }
    } else {
      showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
    }
  }
}

// –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
auth.onAuthStateChanged(async user => {
  if (!user) {
    show("auth");
    return;
  }
  
  currentUser = user;
  
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å
    const userDoc = await db.collection("users").doc(user.uid).get();
    
    if (!userDoc.exists) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
      show("profileSetup");
    } else {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      startApp(userDoc.data());
    }
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
async function saveProfile() {
  const username = document.getElementById('username').value.trim();
  if (!username) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
    return;
  }
  
  try {
    await db.collection("users").doc(auth.currentUser.uid).set({
      username: username,
      avatar: selectedAvatar || "üë§",
      bio: "",
      online: true,
      lastSeen: Date.now(),
      status: selectedStatus || 'online',
      createdAt: Date.now(),
      role: 'user', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      friends: [],
      groups: [],
      bannedUntil: null,
      warnings: 0
    });
    
    startApp({ username: username, avatar: selectedAvatar });
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω', 'success');
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
function startApp(userData) {
  show("main");
  document.getElementById('me').innerText = `${userData.avatar || "üë§"} ${userData.username}`;
  loadUsers();
  loadPosts();
  loadFriends();
  showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.username}!`, 'success');
}

// === –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –ß–ê–¢–´ ===

function loadUsers() {
  db.collection("users").onSnapshot(snapshot => {
    const usersContainer = document.getElementById('users');
    usersContainer.innerHTML = '';
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (user.bannedUntil && user.bannedUntil > Date.now()) {
          return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
        }
        
        const statusText = getStatusText(user);
        
        const userDiv = document.createElement('div');
        userDiv.className = 'user';
        userDiv.innerHTML = `
          <div class="avatar" onclick="event.stopPropagation();openProfile('${doc.id}')">${user.avatar || "üë§"}</div>
          <div class="user-info" onclick="openChat('${doc.id}')">
            <div>${user.username} ${user.role === 'admin' ? 'üëë' : user.role === 'moderator' ? 'üõ°Ô∏è' : ''}</div>
            <div class="status">${statusText}</div>
          </div>
        `;
        usersContainer.appendChild(userDiv);
      }
    });
  });
}

function getStatusText(user) {
  if (user.status === 'invisible') {
    return '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
  } else if (user.online) {
    return `üü¢ ${user.status === 'busy' ? '–ó–∞–Ω—è—Ç' : '–í —Å–µ—Ç–∏'}`;
  } else {
    const lastSeen = formatLastSeen(user.lastSeen);
    return `‚ö™ –±—ã–ª(–∞) ${lastSeen}`;
  }
}

function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const diff = Date.now() - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

// –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
function openChat(uid) {
  currentChat = cid(auth.currentUser.uid, uid);
  currentChatType = 'private';
  
  if (unsub) unsub();
  
  // –û—á–∏—â–∞–µ–º —á–∞—Ç
  document.getElementById('chat').innerHTML = '';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  unsub = db.collection("chats").doc(currentChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snapshot => {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        displayMessage(msg, chat);
      });
      
      chat.scrollTop = chat.scrollHeight;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ID —á–∞—Ç–∞
function cid(a, b) {
  return [a, b].sort().join("_");
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
async function send() {
  const textInput = document.getElementById('text');
  const text = textInput.value.trim();
  
  if (!text || !currentChat) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
    return;
  }
  
  try {
    const messageData = {
      uid: auth.currentUser.uid,
      text: text,
      replyTo: replyMsg,
      time: Date.now(),
      status: 'delivered'
    };
    
    if (currentChatType === 'private') {
      await db.collection("chats").doc(currentChat)
        .collection("messages").add(messageData);
    } else if (currentChatType === 'group') {
      await db.collection("groupMessages").doc(currentChat)
        .collection("messages").add(messageData);
    }
    
    textInput.value = "";
    if (replyMsg) cancelReply();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await updateMessageStats();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
async function updateMessageStats() {
  try {
    await db.collection("users").doc(auth.currentUser.uid).update({
      'stats.messages': firebase.firestore.FieldValue.increment(1)
    });
  } catch (error) {
    console.error('Error updating stats:', error);
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function displayMessage(msg, container) {
  const timeStr = new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const isOwnMessage = msg.uid === auth.currentUser.uid;
  
  let messageHTML = `
    <div class="msg ${isOwnMessage ? "me" : ""}">
      ${msg.replyTo ? `<div style="font-size:13px;color:#cbd5e1;border-left:3px solid #60a5fa;padding-left:10px;margin-bottom:8px;">‚Ü© ${msg.replyTo}</div>` : ""}
      ${msg.text}
      <small>${timeStr}</small>
    </div>
  `;
  
  container.innerHTML += messageHTML;
}

// === –ü–†–û–§–ò–õ–ò ===

// –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function openProfile(uid) {
  profileUid = uid;
  
  try {
    const userDoc = await db.collection("users").doc(uid).get();
    if (!userDoc.exists) {
      showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
      return;
    }
    
    const user = userDoc.data();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('pAvatar').textContent = user.avatar || "üë§";
    document.getElementById('pName').textContent = user.username;
    document.getElementById('pStatus').textContent = getStatusText(user);
    document.getElementById('pBio').textContent = user.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ";
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –¥—Ä—É–∑—å—è—Ö
    const myDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const myFriends = myDoc.data()?.friends || [];
    const friendBtn = document.getElementById('friendBtn');
    
    if (myFriends.includes(uid)) {
      friendBtn.textContent = 'ü§ù –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
      friendBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    } else {
      friendBtn.textContent = 'ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑–µ–π';
      friendBtn.style.background = 'rgba(30,41,59,0.8)';
    }
    
    show("profileView");
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å
async function openMyProfile() {
  try {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const user = userDoc.data();
    
    document.getElementById('myUsername').value = user.username || "";
    document.getElementById('myAvatarPreview').textContent = user.avatar || "üë§";
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    selectedStatus = user.status || 'online';
    const statusText = {
      'online': 'üü¢ –í —Å–µ—Ç–∏',
      'busy': 'üü° –ó–∞–Ω—è—Ç',
      'invisible': '‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞'
    };
    document.getElementById('myStatusPreview').textContent = statusText[selectedStatus] || 'üü¢ –í —Å–µ—Ç–∏';
    
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä
    document.querySelectorAll('#avatarSelector .avatar-option').forEach(el => {
      el.classList.remove('selected');
      if (el.textContent === user.avatar) {
        el.classList.add('selected');
      }
    });
    
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    document.querySelectorAll('#statusSelector .status-option').forEach(el => {
      el.classList.remove('selected');
      if (el.textContent.includes(statusText[selectedStatus]?.substring(2))) {
        el.classList.add('selected');
      }
    });
    
    show("myProfile");
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å
async function updateMyProfile() {
  const username = document.getElementById('myUsername').value.trim();
  if (!username) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
    return;
  }
  
  try {
    await db.collection("users").doc(auth.currentUser.uid).update({
      username: username,
      avatar: selectedAvatar || document.getElementById('myAvatarPreview').textContent,
      status: selectedStatus || 'online'
    });
    
    document.getElementById('me').innerText = `${selectedAvatar || "üë§"} ${username}`;
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    back();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

// –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
function selectAvatar(avatar, type) {
  selectedAvatar = avatar;
  
  if (type === 'setup') {
    document.getElementById('setupAvatarPreview').textContent = avatar;
    document.querySelectorAll('#avatarSelectorSetup .avatar-option').forEach(el => {
      el.classList.remove('selected');
    });
    event.target.classList.add('selected');
  } else if (type === 'my') {
    document.getElementById('myAvatarPreview').textContent = avatar;
    document.querySelectorAll('#avatarSelector .avatar-option').forEach(el => {
      el.classList.remove('selected');
    });
    event.target.classList.add('selected');
  }
}

// –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
function selectStatus(status, type) {
  selectedStatus = status;
  
  if (type === 'setup') {
    document.querySelectorAll('#statusSelectorSetup .status-option').forEach(el => {
      el.classList.remove('selected');
    });
    event.target.classList.add('selected');
  } else if (type === 'my') {
    const statusText = {
      'online': 'üü¢ –í —Å–µ—Ç–∏',
      'busy': 'üü° –ó–∞–Ω—è—Ç',
      'invisible': '‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞'
    };
    document.getElementById('myStatusPreview').textContent = statusText[status] || 'üü¢ –í —Å–µ—Ç–∏';
    document.querySelectorAll('#statusSelector .status-option').forEach(el => {
      el.classList.remove('selected');
    });
    event.target.classList.add('selected');
  }
}

// –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –¥—Ä—É–≥–∞
async function toggleFriend() {
  if (!profileUid) return;
  
  try {
    const myRef = db.collection("users").doc(auth.currentUser.uid);
    const myDoc = await myRef.get();
    const myFriends = myDoc.data()?.friends || [];
    
    if (myFriends.includes(profileUid)) {
      // –£–¥–∞–ª—è–µ–º –∏–∑ –¥—Ä—É–∑–µ–π
      await myRef.update({
        friends: firebase.firestore.FieldValue.arrayRemove(profileUid)
      });
      document.getElementById('friendBtn').textContent = 'ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑–µ–π';
      document.getElementById('friendBtn').style.background = 'rgba(30,41,59,0.8)';
      showNotification('–£–¥–∞–ª–µ–Ω –∏–∑ –¥—Ä—É–∑–µ–π', 'success');
    } else {
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥—Ä—É–∑–µ–π
      await myRef.update({
        friends: firebase.firestore.FieldValue.arrayUnion(profileUid)
      });
      document.getElementById('friendBtn').textContent = 'ü§ù –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
      document.getElementById('friendBtn').style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      showNotification('–î–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è', 'success');
    }
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
  }
}

// –ù–∞–ø–∏—Å–∞—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
function writeFromProfile() {
  if (!profileUid) return;
  back();
  openChat(profileUid);
}

// === –ì–†–£–ü–ü–û–í–´–ï –ß–ê–¢–´ ===

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
async function showGroupCreation() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const userRole = userDoc.data()?.role || 'user';
    
    if (userRole === 'user') {
      showNotification('–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º', 'error');
      return;
    }
    
    await loadUsersForGroup();
    showModal('groupCreationModal');
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≥—Ä—É–ø–ø—ã
async function loadUsersForGroup() {
  const membersList = document.getElementById('groupMembersList');
  membersList.innerHTML = '';
  selectedGroupMembers.clear();
  
  try {
    const snapshot = await db.collection("users").get();
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
        if (user.bannedUntil && user.bannedUntil > Date.now()) {
          return;
        }
        
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:5px;cursor:pointer;border:1px solid rgba(255,255,255,0.1);';
        div.innerHTML = `
          <div class="avatar" style="width:32px;height:32px;font-size:16px;">${user.avatar || 'üë§'}</div>
          <div style="color:white;">${user.username}</div>
          <div style="margin-left:auto;color:#3b82f6;">+</div>
        `;
        div.onclick = () => toggleGroupMember(doc.id, div);
        membersList.appendChild(div);
      }
    });
    
  } catch (error) {
    membersList.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

// –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≥—Ä—É–ø–ø—ã
function toggleGroupMember(uid, element) {
  if (selectedGroupMembers.has(uid)) {
    selectedGroupMembers.delete(uid);
    element.style.background = '';
    element.querySelector('div:last-child').textContent = '+';
    element.querySelector('div:last-child').style.color = '#3b82f6';
  } else {
    selectedGroupMembers.add(uid);
    element.style.background = 'rgba(59, 130, 246, 0.2)';
    element.querySelector('div:last-child').textContent = '‚úì';
    element.querySelector('div:last-child').style.color = '#22c55e';
  }
}

// –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
async function createGroup() {
  const groupName = document.getElementById('groupNameInput').value.trim();
  
  if (!groupName) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
    return;
  }
  
  if (selectedGroupMembers.size === 0) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã', 'error');
    return;
  }
  
  try {
    const groupId = 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const members = Array.from(selectedGroupMembers);
    members.push(auth.currentUser.uid); // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è
    
    const groupData = {
      id: groupId,
      name: groupName,
      avatar: 'üë•',
      creator: auth.currentUser.uid,
      members: members,
      admins: [auth.currentUser.uid],
      createdAt: Date.now()
    };
    
    // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
    await db.collection('groups').doc(groupId).set(groupData);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    const batch = db.batch();
    members.forEach(memberId => {
      const userRef = db.collection('users').doc(memberId);
      batch.update(userRef, {
        groups: firebase.firestore.FieldValue.arrayUnion(groupId)
      });
    });
    await batch.commit();
    
    showNotification(`–ì—Ä—É–ø–ø–∞ "${groupName}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
    closeModal('groupCreationModal');
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('groupNameInput').value = '';
    selectedGroupMembers.clear();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + error.message, 'error');
  }
}

// === –ú–û–î–ï–†–ê–¶–ò–Ø ===

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
async function showModerationPanel() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const userRole = userDoc.data()?.role || 'user';
    
    if (userRole === 'user') {
      showNotification('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º', 'error');
      return;
    }
    
    showModal('moderationModal');
    await loadReports();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∂–∞–ª–æ–±—ã
async function loadReports() {
  const reportsList = document.getElementById('reportsList');
  reportsList.innerHTML = '<div style="text-align:center;padding:20px;color:white;opacity:0.7;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  try {
    const snapshot = await db.collection('reports')
      .orderBy('timestamp', 'desc')
      .limit(10)
      .get();
    
    if (snapshot.empty) {
      reportsList.innerHTML = '<div style="text-align:center;padding:20px;color:white;opacity:0.7;">–ù–µ—Ç –∂–∞–ª–æ–±</div>';
      return;
    }
    
    reportsList.innerHTML = '';
    snapshot.forEach(doc => {
      const report = doc.data();
      const time = new Date(report.timestamp).toLocaleString();
      
      const reportDiv = document.createElement('div');
      reportDiv.style.cssText = 'padding:15px;margin:10px 0;background:rgba(30,41,59,0.8);border-radius:8px;border:1px solid rgba(255,255,255,0.1);';
      
      reportDiv.innerHTML = `
        <div style="font-weight:600;color:white;margin-bottom:5px;">
          –ñ–∞–ª–æ–±–∞ –æ—Ç: ${report.reporterName || '–ê–Ω–æ–Ω–∏–º'}
          <span style="font-size:12px;color:#94a3b8;margin-left:10px;">${time}</span>
        </div>
        <div style="color:white;opacity:0.9;margin-bottom:10px;">
          –ü—Ä–∏—á–∏–Ω–∞: ${report.reason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
        </div>
        <div style="color:white;opacity:0.8;font-style:italic;margin-bottom:10px;">
          –°–æ–æ–±—â–µ–Ω–∏–µ: "${report.messageText || ''}"
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="handleReport('${doc.id}', 'approved')" style="padding:5px 10px;background:#22c55e;color:white;border:none;border-radius:4px;cursor:pointer;">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button onclick="handleReport('${doc.id}', 'rejected')" style="padding:5px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      `;
      
      reportsList.appendChild(reportDiv);
    });
    
  } catch (error) {
    reportsList.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∂–∞–ª–æ–±—É
async function handleReport(reportId, action) {
  try {
    const reportDoc = await db.collection('reports').doc(reportId).get();
    if (!reportDoc.exists) {
      showNotification('–ñ–∞–ª–æ–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
      return;
    }
    
    const report = reportDoc.data();
    
    if (action === 'approved') {
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (report.chatType === 'group') {
        await db.collection('groupMessages').doc(report.chatId)
          .collection('messages').doc(report.messageId).delete();
      } else {
        await db.collection('chats').doc(report.chatId)
          .collection('messages').doc(report.messageId).delete();
      }
      
      // –ë–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 1 —á–∞—Å
      await db.collection('users').doc(report.reportedUserId).update({
        bannedUntil: Date.now() + 3600000, // 1 —á–∞—Å
        warnings: firebase.firestore.FieldValue.increment(1)
      });
      
      showNotification('–ñ–∞–ª–æ–±–∞ –ø—Ä–∏–Ω—è—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 1 —á–∞—Å', 'success');
    } else {
      showNotification('–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
    }
    
    // –£–¥–∞–ª—è–µ–º –∂–∞–ª–æ–±—É
    await db.collection('reports').doc(reportId).delete();
    await loadReports();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + error.message, 'error');
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
function showUserManagement() {
  showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// === –ù–û–í–û–°–¢–ò ===

function loadPosts() {
  db.collection("posts").orderBy("time", "desc").onSnapshot(snapshot => {
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = '';
    
    snapshot.forEach(doc => {
      const post = doc.data();
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.style.cssText = 'background:rgba(30,41,59,0.8);padding:20px;border-radius:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);';
      postDiv.innerHTML = `
        <b>${post.username}</b><br>
        ${post.text}
      `;
      postsContainer.appendChild(postDiv);
    });
  });
}

async function createPost() {
  const postText = document.getElementById('postText').value.trim();
  if (!postText) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'error');
    return;
  }
  
  try {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const username = userDoc.data()?.username || '–ê–Ω–æ–Ω–∏–º';
    
    await db.collection("posts").add({
      username: username,
      text: postText,
      time: Date.now(),
      uid: auth.currentUser.uid
    });
    
    document.getElementById('postText').value = '';
    showNotification('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω', 'success');
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message, 'error');
  }
}

// === –î–†–£–ó–¨–Ø ===

function loadFriends() {
  db.collection("users").onSnapshot(snapshot => {
    const friendsList = document.getElementById('friendsList');
    friendsList.innerHTML = '';
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        const statusText = getStatusText(user);
        
        const friendDiv = document.createElement('div');
        friendDiv.className = 'user';
        friendDiv.innerHTML = `
          <div class="avatar">${user.avatar || "üë§"}</div>
          <div class="user-info">
            <div>${user.username}</div>
            <div class="status">${statusText}</div>
          </div>
        `;
        friendsList.appendChild(friendDiv);
      }
    });
  });
}

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.style.cssText = `
    animation: slideIn 0.3s ease;
    border-left: 4px solid ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
  `;
  
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      ${icon}
      <div style="color:white;">${message}</div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function showModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function openTab(id, el) {
  ["chats", "news", "friends"].forEach(x => {
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
  
  document.querySelectorAll(".tab").forEach(t => {
    t.classList.remove("active");
  });
  el.classList.add("active");
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
function show(id) {
  ["auth", "profileSetup", "main", "profileView", "myProfile"].forEach(x => {
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// –ù–∞–∑–∞–¥
function back() {
  show("main");
}

// –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
function reply(text) {
  replyMsg = text;
  showNotification('–†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞ –∞–∫—Ç–∏–≤–µ–Ω', 'info');
}

// –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
function cancelReply() {
  replyMsg = null;
}

// –í—ã–π—Ç–∏
async function logout() {
  try {
    if (auth.currentUser) {
      await db.collection("users").doc(auth.currentUser.uid).update({
        online: false,
        lastSeen: Date.now()
      });
    }
    await auth.signOut();
    showNotification('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message, 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã (–∑–∞–≥–ª—É—à–∫–∞)
function showThemeSelector() {
  showNotification('–§—É–Ω–∫—Ü–∏—è —Ç–µ–º –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(100px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .avatar-option, .status-option {
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    border: 2px solid transparent;
    text-align: center;
  }
  
  .avatar-option.selected, .status-option.selected {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
  }
  
  .avatar-option:hover, .status-option:hover {
    background: rgba(255, 255, 255, 0.1);
  }
`;
document.head.appendChild(style);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  if (auth.currentUser) {
    auth.signOut(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  }
});
</script>
</body>
</html>
