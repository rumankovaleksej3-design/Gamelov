<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
  display:flex;
  justify-content:center;
}
.hidden{display:none}

.container{
  width:100%;
  max-width:420px;
  display:flex;
  flex-direction:column;
}

header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.msg{
  margin:6px 0;
  padding:8px 12px;
  border-radius:10px;
  background:#1e293b;
  max-width:80%;
}
.me{
  background:#2563eb;
  margin-left:auto;
}

.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}

input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}

button{
  padding:10px;
  border-radius:8px;
  border:none;
  background:#22c55e;
  font-weight:600;
}

.user{
  padding:8px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.user:hover{background:#020617}
.activeUser{background:#1e293b}

small{opacity:.6}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Пароль"><br><br>
  <button onclick="login()">Войти / Регистрация</button>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden">
  <h3>Введите ник</h3>
  <input id="username" placeholder="Никнейм"><br><br>
  <button onclick="saveProfile()">Сохранить</button>
</div>

<!-- CHAT -->
<div id="app" class="hidden">

<header>
  <span id="me"></span>
  <button onclick="logout()" style="background:#ef4444">Выйти</button>
</header>

<div class="chat" id="chat"></div>

<div class="input">
  <input id="text" placeholder="Сообщение">
  <button onclick="send()">➤</button>
</div>

<h4 style="padding:10px;margin:0">Пользователи</h4>
<div id="users"></div>

<small id="chatTitle" style="padding:10px">Выберите пользователя</small>

</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsubscribeMessages=null;

/* AUTH */
async function login(){
  if(password.value.length<6){
    alert("Пароль минимум 6 символов");
    return;
  }
  try{
    await auth.createUserWithEmailAndPassword(email.value,password.value);
  }catch(e){
    await auth.signInWithEmailAndPassword(email.value,password.value);
  }
}

auth.onAuthStateChanged(async user=>{
  if(!user){ show("auth"); return; }
  const doc=await db.collection("users").doc(user.uid).get();
  if(!doc.exists){ show("profile"); }
  else startApp(doc.data().username);
});

/* PROFILE */
async function saveProfile(){
  if(!username.value){ alert("Введите ник"); return; }
  await db.collection("users").doc(auth.currentUser.uid).set({
    username:username.value
  });
  startApp(username.value);
}

/* START */
function startApp(name){
  show("app");
  me.innerText="Вы: "+name;
  loadUsers();
}

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    users.innerHTML="";
    snap.forEach(d=>{
      if(d.id===auth.currentUser.uid) return;
      users.innerHTML+=`
        <div class="user" onclick="openChat('${d.id}','${d.data().username}',this)">
          ${d.data().username}
        </div>`;
    });
  });
}

/* CHAT */
function chatId(a,b){ return [a,b].sort().join("_"); }

function openChat(uid,name,el){
  document.querySelectorAll(".user").forEach(u=>u.classList.remove("activeUser"));
  el.classList.add("activeUser");

  currentChat=chatId(auth.currentUser.uid,uid);
  chatTitle.innerText="Чат с "+name;
  chat.innerHTML="";

  if(unsubscribeMessages) unsubscribeMessages();

  unsubscribeMessages=db.collection("chats")
    .doc(currentChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      chat.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        chat.innerHTML+=`
          <div class="msg ${m.uid===auth.currentUser.uid?"me":""}">
            ${m.text}
          </div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

function send(){
  if(!currentChat){
    alert("Выберите пользователя");
    return;
  }
  if(!text.value) return;

  db.collection("chats")
    .doc(currentChat)
    .collection("messages")
    .add({
      uid:auth.currentUser.uid,
      text:text.value,
      time:Date.now()
    });

  text.value="";
}

text.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});

/* LOGOUT */
function logout(){
  auth.signOut();
}

/* UI */
function show(id){
  ["auth","profile","app"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
</script>
</body>
</html>
