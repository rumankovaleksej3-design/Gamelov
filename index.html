<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
}
.tab{
  flex:1;
  padding:12px;
  text-align:center;
  cursor:pointer;
  opacity:.6;
}
.tab.active{opacity:1;background:#1e293b}

/* CHAT */
#chats{flex:1;display:flex;flex-direction:column}
.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#020617;
}
.msg{
  max-width:80%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:12px;
  background:#1e293b;
}
.me{margin-left:auto;background:#2563eb}
.msg small{
  display:block;
  font-size:11px;
  opacity:.6;
  text-align:right;
}
.reply-preview{
  font-size:12px;
  opacity:.7;
  border-left:2px solid #60a5fa;
  padding-left:6px;
  margin-bottom:4px;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  border:none;
  border-radius:8px;
  padding:10px;
  background:#22c55e;
  font-weight:600;
  cursor:pointer;
}

/* EMOJI */
#emojiPanel{
  padding:8px;
  background:#020617;
}
#emojiPanel span{
  font-size:20px;
  margin:4px;
  cursor:pointer;
}

/* USERS */
.user{
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
}
.status{font-size:10px}

/* POSTS */
.post{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

/* PROFILE */
#profileView,#myProfile{
  flex:1;
  padding:20px;
  text-align:center;
}
.profileAvatar{font-size:48px}
.profileName{font-size:20px;font-weight:700}
.profileBio{opacity:.8;margin-top:8px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
  <input id="username" placeholder="–ù–∏–∫"><br><br>
  <input id="avatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)"><br><br>
  <textarea id="bio" placeholder="–û —Å–µ–±–µ"></textarea><br><br>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- MAIN -->
<div id="main" class="hidden">

<header>
  <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div id="replyBox" class="hidden" style="padding:6px;background:#020617">
    –û—Ç–≤–µ—Ç: <span id="replyText"></span>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden">
    <span onclick="addEmoji('üòÄ')">üòÄ</span>
    <span onclick="addEmoji('üòÇ')">üòÇ</span>
    <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span onclick="addEmoji('üî•')">üî•</span>
    <span onclick="addEmoji('üëç')">üëç</span>
  </div>

  <div class="input">
    <button onclick="toggleEmoji()">üòÄ</button>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding:10px;font-weight:600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
  <div id="users"></div>
</div>

<div id="news" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr>
  <div id="posts"></div>
</div>

<div id="friends" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <div id="friendsList"></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
</div>

</div>

<!-- PROFILE VIEW (—á—É–∂–æ–π –ø—Ä–æ—Ñ–∏–ª—å) -->
<div id="profileView" class="hidden">
  <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="profileAvatar" id="pAvatar"></div>
  <div class="profileName" id="pName"></div>
  <div class="profileBio" id="pBio"></div>
  <button onclick="writeFromProfile()">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
</div>

<!-- MY PROFILE (–Ω–æ–≤—ã–π, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π) -->
<div id="myProfile" class="hidden">
  <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="profileAvatar" id="myAvatarPreview">üë§</div>
  <input id="myAvatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)"><br><br>
  <input id="myUsername" placeholder="–ù–∏–∫"><br><br>
  <textarea id="myBio" placeholder="–û —Å–µ–±–µ"></textarea><br><br>
  <button onclick="updateMyProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;
let replyMsg=null;
let profileUid=null;

/* AUTH */
async function login(){
  try{await auth.createUserWithEmailAndPassword(email.value,password.value);}
  catch{await auth.signInWithEmailAndPassword(email.value,password.value);}
}

auth.onAuthStateChanged(async u=>{
  if(!u){show("auth");return;}
  await db.collection("users").doc(u.uid).update({online:true});
  const d=await db.collection("users").doc(u.uid).get();
  d.exists?startApp(d.data()):show("profileSetup");
});

/* PROFILE SETUP */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid).set({
    username:username.value,
    avatar:avatar.value||"üë§",
    bio:bio.value||"",
    online:true
  });
  startApp({username:username.value,avatar:avatar.value});
}

/* START */
function startApp(u){
  show("main");
  me.innerText=`${u.avatar||"üë§"} ${u.username}`;
  loadUsers(); loadPosts(); loadFriends();
}

/* TABS */
function openTab(id,el){
  ["chats","news","friends"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

/* USERS + CHAT */
const cid=(a,b)=>[a,b].sort().join("_");

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        users.innerHTML+=`
          <div class="user" onclick="openChat('${d.id}')">
            <div class="avatar" onclick="event.stopPropagation();openProfile('${d.id}')">${u.avatar||"üë§"}</div>
            ${u.username}
            <span class="status">${u.online?"üü¢":"‚ö™"}</span>
          </div>`;
      }
    });
  });
}

function openChat(uid){
  currentChat=cid(auth.currentUser.uid,uid);
}

/* SEND */
function send(){
  if(!currentChat||!text.value)return;
  db.collection("chats").doc(currentChat)
    .collection("messages")
    .add({
      uid:auth.currentUser.uid,
      text:text.value,
      replyTo:replyMsg,
      time:Date.now()
    });
  text.value="";
  cancelReply();
}

/* REPLY */
function reply(t){
  replyMsg=t;
  replyText.innerText=t;
  replyBox.classList.remove("hidden");
}
function cancelReply(){
  replyMsg=null;
  replyBox.classList.add("hidden");
}

/* EMOJI */
function toggleEmoji(){emojiPanel.classList.toggle("hidden")}
function addEmoji(e){text.value+=e}

/* PROFILE VIEW */
async function openProfile(uid){
  profileUid=uid;
  const d=await db.collection("users").doc(uid).get();
  const u=d.data();
  pAvatar.innerText=u.avatar||"üë§";
  pName.innerText=u.username;
  pBio.innerText=u.bio||"";
  show("profileView");
}
function writeFromProfile(){
  back();
  openChat(profileUid);
}

/* MY PROFILE */
async function openMyProfile(){
  const d=await db.collection("users").doc(auth.currentUser.uid).get();
  const u=d.data();
  myAvatar.value=u.avatar||"üë§";
  myUsername.value=u.username;
  myBio.value=u.bio||"";
  myAvatarPreview.innerText=myAvatar.value;
  show("myProfile");
}
myAvatar.oninput=()=>myAvatarPreview.innerText=myAvatar.value||"üë§";
async function updateMyProfile(){
  await db.collection("users").doc(auth.currentUser.uid).update({
    avatar:myAvatar.value||"üë§",
    username:myUsername.value,
    bio:myBio.value
  });
  me.innerText=`${myAvatar.value} ${myUsername.value}`;
  back();
}

/* NEWS */
function loadPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(s=>{
    posts.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      posts.innerHTML+=`<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
    });
  });
}
function createPost(){
  if(!postText.value)return;
  db.collection("posts").add({
    username:me.innerText,
    text:postText.value,
    time:Date.now()
  });
  postText.value="";
}

/* FRIENDS */
function loadFriends(){
  db.collection("users").onSnapshot(s=>{
    friendsList.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid)
        friendsList.innerHTML+=`<div class="user" onclick="openProfile('${d.id}')">${d.data().username}</div>`;
    });
  });
}

/* UI */
function show(id){
  ["auth","profileSetup","main","profileView","myProfile"]
    .forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function back(){show("main")}
function logout(){
  db.collection("users").doc(auth.currentUser.uid).update({online:false});
  auth.signOut();
}
</script>
</body>
</html>
