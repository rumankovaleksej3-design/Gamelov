<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatNet">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ChatNet">
    <meta name="description" content="ChatNet - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä">
    <meta name="keywords" content="–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä, —á–∞—Ç, –æ–±—â–µ–Ω–∏–µ">
    
    <title>ChatNet</title>
    
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEx8ENQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7BlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u7A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEx8ENQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7BlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u7A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg==">
    
    <style>
    /* –°–ë–†–û–° –ò –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .hidden {
      display: none !important;
    }

    /* –ö–û–ù–¢–ï–ô–ù–ï–† */
    .container {
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #0f172a;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* PWA –°–ü–õ–ê–® –≠–ö–†–ê–ù */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .splash-logo {
      font-size: 4rem;
      margin-bottom: 2rem;
      animation: pulse 2s infinite;
    }

    .splash-text {
      font-size: 1.5rem;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 2rem;
    }

    .splash-loading {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(96, 165, 250, 0.3);
      border-radius: 50%;
      border-top-color: #60a5fa;
      animation: spin 1s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
    #auth {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 40px 20px;
      position: relative;
      overflow: hidden;
    }

    #auth::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
    }

    #auth h2 {
      font-size: 3.5rem;
      color: white;
      margin-bottom: 40px;
      font-weight: 800;
      text-align: center;
      letter-spacing: 1px;
      text-shadow: 0 2px 20px rgba(59, 130, 246, 0.3);
      position: relative;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #auth input {
      width: 100%;
      max-width: 320px;
      padding: 16px 20px;
      margin-bottom: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    #auth input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    #auth input:focus {
      outline: none;
      border-color: #3b82f6;
      background: rgba(30, 41, 59, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }

    #auth button {
      width: 100%;
      max-width: 320px;
      padding: 16px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    #auth button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
    }

    /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
    #main {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #0f172a;
    }

    /* –®–ê–ü–ö–ê */
    header {
      background: rgba(15, 23, 42, 0.95);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
      backdrop-filter: blur(10px);
      padding-top: env(safe-area-inset-top, 16px);
      padding-left: calc(20px + env(safe-area-inset-left, 0px));
      padding-right: calc(20px + env(safe-area-inset-right, 0px));
    }

    #me {
      font-size: 18px;
      font-weight: 600;
      color: #e2e8f0;
      cursor: pointer;
      padding: 10px 18px;
      border-radius: 12px;
      transition: all 0.3s ease;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    header button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* –í–ö–õ–ê–î–ö–ò */
    .tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0 20px;
      backdrop-filter: blur(10px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .tab {
      flex: 1;
      padding: 18px;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      color: #94a3b8;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      font-size: 15px;
    }

    .tab.active {
      color: #60a5fa;
      border-bottom-color: #60a5fa;
      font-weight: 600;
    }

    /* –ß–ê–¢ */
    #chats {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      background: #0f172a;
    }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 18px;
      background: rgba(30, 41, 59, 0.8);
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .msg.me {
      margin-left: auto;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
    }

    /* –°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô */
    #users {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(15, 23, 42, 0.8);
    }

    .user {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      border-radius: 16px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      flex-shrink: 0;
    }

    /* –í–í–û–î –°–û–û–ë–©–ï–ù–ò–ô */
    .input {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      align-items: center;
      backdrop-filter: blur(10px);
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
    }

    .input input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 25px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      font-size: 16px;
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
    }

    .input button {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      font-size: 20px;
    }

    /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
      z-index: 10000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    #notification.show {
      transform: translateX(0);
    }

    /* –û–§–§–õ–ê–ô–ù –°–¢–ê–¢–£–° */
    #offlineStatus {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ef4444;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 10000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    #offlineStatus.show {
      transform: translateY(0);
    }

    /* INSTALL –ü–†–û–ú–ü–¢ */
    #installPrompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      z-index: 10000;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transform: translateY(120%);
      transition: transform 0.3s ease;
    }

    #installPrompt.show {
      transform: translateY(0);
    }

    .install-content {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .install-icon {
      font-size: 48px;
    }

    .install-buttons {
      display: flex;
      gap: 12px;
    }

    .install-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .install-buttons button:first-child {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
    }

    .install-buttons button:last-child {
      background: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
    }

    /* –ú–ï–î–ò–ê –ó–ê–ü–†–û–°–´ –î–õ–Ø PWA */
    @media (display-mode: standalone) {
      header {
        padding-top: calc(16px + env(safe-area-inset-top, 0px));
      }
      
      .tabs {
        padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      }
    }

    @media (max-width: 768px) {
      .msg {
        max-width: 85%;
      }
      
      .avatar {
        width: 44px;
        height: 44px;
        font-size: 22px;
      }
      
      .tab {
        padding: 16px 12px;
        font-size: 14px;
      }
    }

    /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ù–û–¢–ß–ò */
    @supports (padding: max(0px)) {
      header {
        padding-top: max(16px, env(safe-area-inset-top));
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
      }
      
      .input {
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }
    }

    /* –°–ö–†–û–õ–õ–ë–ê–† */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 4px;
    }
    </style>
</head>

<body>
<!-- –°–ø–ª–∞—à —ç–∫—Ä–∞–Ω -->
<div id="splash">
    <div class="splash-logo">üí¨</div>
    <div class="splash-text">ChatNet</div>
    <div class="splash-loading"></div>
</div>

<!-- –û—Ñ—Ñ–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å -->
<div id="offlineStatus">
    ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification">
    <div id="notificationTitle"></div>
    <div id="notificationBody"></div>
</div>

<!-- Install –ø—Ä–æ–º–ø—Ç -->
<div id="installPrompt">
    <div class="install-content">
        <div class="install-icon">üì±</div>
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ChatNet</div>
            <div style="font-size: 14px; color: #94a3b8;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</div>
        </div>
    </div>
    <div class="install-buttons">
        <button onclick="installApp()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button onclick="hideInstallPrompt()">–ü–æ–∑–∂–µ</button>
    </div>
</div>

<div class="container">
    <!-- AUTH -->
    <div id="auth">
        <h2>ChatNet</h2>
        <input id="email" type="email" placeholder="Email" autocomplete="email">
        <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
        <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <div style="margin-top: 20px; font-size: 14px; color: #94a3b8; text-align: center;">
            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞
        </div>
    </div>

    <!-- PROFILE SETUP -->
    <div id="profileSetup" class="hidden">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 60px 20px 30px; text-align: center;">
            <div style="font-size: 64px; width: 120px; height: 120px; margin: 0 auto 25px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3)); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid rgba(255, 255, 255, 0.2);">üë§</div>
            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
        </div>
        
        <div style="padding: 25px 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
            <div id="avatarSelectorSetup" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 20px 0;">
                <div onclick="selectAvatar('üë§', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid #3b82f6;">üë§</div>
                <div onclick="selectAvatar('üòé', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid transparent;">üòé</div>
                <div onclick="selectAvatar('ü§ñ', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid transparent;">ü§ñ</div>
                <div onclick="selectAvatar('üê∂', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid transparent;">üê∂</div>
                <div onclick="selectAvatar('ü¶ä', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid transparent;">ü¶ä</div>
                <div onclick="selectAvatar('üëë', 'setup')" style="font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(30, 41, 59, 0.8); border-radius: 50%; cursor: pointer; border: 2px solid transparent;">üëë</div>
            </div>
            
            <input id="username" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;">
            
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–°—Ç–∞—Ç—É—Å</div>
            <div id="statusSelectorSetup" style="display: flex; gap: 12px; margin: 20px 0;">
                <div onclick="selectStatus('online', 'setup')" style="flex: 1; padding: 14px; text-align: center; background: rgba(30, 41, 59, 0.8); border-radius: 12px; cursor: pointer; border: 2px solid #3b82f6;">üü¢ –í —Å–µ—Ç–∏</div>
                <div onclick="selectStatus('busy', 'setup')" style="flex: 1; padding: 14px; text-align: center; background: rgba(30, 41, 59, 0.8); border-radius: 12px; cursor: pointer; border: 2px solid transparent;">üü° –ó–∞–Ω—è—Ç</div>
                <div onclick="selectStatus('invisible', 'setup')" style="flex: 1; padding: 14px; text-align: center; background: rgba(30, 41, 59, 0.8); border-radius: 12px; cursor: pointer; border: 2px solid transparent;">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
            </div>
            
            <textarea id="bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." style="width:100%;height:120px; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white; resize: none;"></textarea>
            
            <button onclick="saveProfile()" style="width:100%;padding:16px;margin-top:20px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 12px; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <!-- MAIN -->
    <div id="main" class="hidden">
        <header>
            <span id="me" onclick="openMyProfile()">üë§ User</span>
            <button onclick="logout()">–í—ã–π—Ç–∏</button>
        </header>

        <div id="chats">
            <div class="chat" id="chat">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>

            <div id="replyBox" class="hidden" style="padding:12px 20px; background: rgba(30, 41, 59, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                –û—Ç–≤–µ—Ç: <span id="replyText"></span>
                <button onclick="cancelReply()" style="background:none;border:none;color:#94a3b8;margin-left:10px;">‚úñ</button>
            </div>

            <div id="emojiPanel" class="hidden" style="padding:20px; background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div id="emojiCategories" style="display: flex; overflow-x: auto; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);"></div>
                <div id="emojiGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 150px; overflow-y: auto;"></div>
            </div>

            <div class="input">
                <button onclick="toggleEmoji()" style="background: rgba(30, 41, 59, 0.8);">üòÄ</button>
                <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off">
                <button onclick="send()">‚û§</button>
            </div>

            <div style="padding: 20px; font-weight: 600; color: #f1f5f9; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div id="users"></div>
        </div>

        <div id="news" class="hidden" style="padding:24px;overflow:auto;flex:1; background: #0f172a;">
            <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" style="width:100%;height:120px; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white; resize: none;"></textarea>
            <button onclick="createPost()" style="width:100%;padding:16px;margin-top:20px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 12px; font-weight: 600;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <hr style="border:none;border-top:1px solid rgba(255,255,255,0.1);margin:20px 0;">
            <div id="posts"></div>
        </div>

        <div id="friends" class="hidden" style="padding:24px;overflow:auto;flex:1; background: #0f172a;">
            <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 20px; font-size: 18px;">–î—Ä—É–∑—å—è</div>
            <div id="friendsList"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
            <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
            <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
        </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="profileView" class="hidden">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 60px 20px 30px; text-align: center; position: relative;">
            <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px);">‚Üê –ù–∞–∑–∞–¥</button>
            <div id="pAvatar" style="font-size: 64px; width: 120px; height: 120px; margin: 0 auto 25px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3)); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid rgba(255, 255, 255, 0.2);">üë§</div>
            <div id="pName" style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;"></div>
            <div id="pStatus" style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;"></div>
        </div>
        
        <div style="padding: 25px 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div id="pBio" style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 16px; line-height: 1.6; border: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 20px;"></div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="writeFromProfile()" style="flex:1;padding:14px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;font-weight:500;">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
                <button onclick="toggleFriend()" id="friendBtn" style="flex:1;padding:14px;background:rgba(30,41,59,0.8);color:white;border:1px solid rgba(255,255,255,0.1);border-radius:12px;font-weight:500;">ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
            </div>
        </div>
    </div>

    <!-- MY PROFILE -->
    <div id="myProfile" class="hidden">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 60px 20px 30px; text-align: center; position: relative;">
            <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px);">‚Üê –ù–∞–∑–∞–¥</button>
            <div id="myAvatarPreview" style="font-size: 64px; width: 120px; height: 120px; margin: 0 auto 25px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3)); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid rgba(255, 255, 255, 0.2);">üë§</div>
            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
            <div id="myStatusPreview" style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;">üü¢ –í —Å–µ—Ç–∏</div>
        </div>
        
        <div style="padding: 25px 20px;">
            <input id="myUsername" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;margin-bottom:20px; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;">
            
            <textarea id="myBio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." style="width:100%;height:120px; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white; resize: none; margin-bottom: 20px;"></textarea>
            
            <button onclick="updateMyProfile()" style="width:100%;padding:16px;background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 12px; font-weight: 600;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>
</div>

<script>
// ============ PWA –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ ============

// Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
        }).catch(err => {
            console.log('ServiceWorker –æ—à–∏–±–∫–∞:', err);
        });
    });
}

// –ú–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è PWA
const manifest = {
    "name": "ChatNet",
    "short_name": "ChatNet",
    "description": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#0f172a",
    "theme_color": "#0f172a",
    "icons": [
        {
            "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEz8GNQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7BlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u6A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg==",
            "sizes": "192x192",
            "type": "image/png"
        },
        {
            "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEx8ENQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7FlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u7A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg==",
            "sizes": "512x512",
            "type": "image/png"
        }
    ]
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
    const offlineStatus = document.getElementById('offlineStatus');
    if (!navigator.onLine) {
        offlineStatus.classList.add('show');
    } else {
        offlineStatus.classList.remove('show');
    }
}

// –°–∫—Ä—ã—Ç–∏–µ —Å–ø–ª–∞—à —ç–∫—Ä–∞–Ω–∞
setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
}, 2000);

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEx8ENQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7BlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u7A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg==',
            badge: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAQnSURBVHgB7d1faBVVHMfx79m7rX+yaLJEW8JM8AGjtgglEPRB0IeoJx96EjN9KBF6yEx8ENQkBB8q8o8owgfrwZd6UIuSfEgktCwt/9JgpoHhA7q1t+fOd87+u3u93uzu2V/3nB28nxe4d2dnZ+bsfOd3zswwP5YQIYRkKhOZNgGIJASEJAGIJDmT0jS9E6jj4amkAIlGDI8JgYkQBCCkEYJcAiQWsQT0KAXgk38gKQAZEkIgx05HJSAhAFrVd+58HjVLB4cxjXjmTgCGA9kGg8A0oN8B6A/FCcG3CaQAZEt0lJm0N9FvAqUAZEvoSE3i9oc8gRSA6RRIASDpQqA8gZQmJgQhpQSGpwS6R4x+0EafACQZ+9lSAsNTgqyJ3E8DAhBSuN+MCSC0QC6zOPr/GgAk2bo3JgAQAt1J4gVCTwABdQv1JwAhhR1rX9eOAAQ1Tf//f75Hv7QBTEjJdAIJ1DhJcL79N/L9P4D+C4F9+0h00nFdBaZq/3KvhQgRTARIAEISgEhCABKCkEAACEEAQgIBSAhCAgFICEICASAEAYgkBJAQhAT9AfT/0gUA9i1L5eQ7i7FvWio9l3bX5d+61Evs80M2wANLF+Dd4gN4dH4WXhq9CEw2Wz/+0wTgvqlZfL6ngG0Ls7BlL+C3g39g/LtpYBo1mxG35Y11eP3lh5E17ZvA1i9/xod7B5Fm/j8I0PXn0+3L8GLnCqTd3fNz2P7NADr/qsJ3+gegp3iK7gfn9N9K+w8D6Fg2H/u7VmPTqiV4UBwfBvDcAeCEc/2n+1a8+f2YpK++OP4nJhCAdA24/zgBJBSd/Cy4rz9LAoC+0r7+TQH0I4GAIOYSOgEkkCH/XwWQ9gBKbQDa8I9F6qPeDS4sX4R3Nq9Glv1+2b3923MYujyFpGtYPFmGf2JHA9DQ6lZk2eJFC5B02v1P6xZo69wVa/1uZWn+kj76B6C59vnZmHhsDtdHZ/DJvmGU2u7A6iWf+gF86Ef/+t5Lvyd+OHsLvR+fwFCpHWmnSw/8iF0KECa2/H57HheGppH2TTuJrEV8AGs68sii1Y2A6k/F+7Y33/HvAyCn/GnT6n+Pdn88gJhCACavz+G9b8Ywcv0fZNH0T98jgEULXOu2rCcnzZ+6zdjSPaO4dP02smzhfKt/AO6FnxdX++1Tt/vjA/jq2A1M/TuH7PJk2yKCU3/g5E9TyLrc/AXxAUxet5Bp9vXPKto+AYhsWrC0CQBNf3qsfgBo8rVTfx0E0JyFqH3hI1LchZgACAAhiGQJ8Jz6ffP/lwAk0f4PwA3A4oUuCQAAAABJRU5ErkJggg=='
        });
    }
}

// –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission();
    }
}

// PWA Install –ø—Ä–æ–º–ø—Ç
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (deferredPrompt) {
            installPrompt.classList.add('show');
        }
    }, 5000);
});

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
            }
            deferredPrompt = null;
            installPrompt.classList.remove('show');
        });
    }
}

function hideInstallPrompt() {
    installPrompt.classList.remove('show');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
    console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ standalone —Ä–µ–∂–∏–º–µ');
}

// ============ –û–°–ù–û–í–ù–û–ô –ö–û–î –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê ============

// Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
    authDomain: "chatnet-2a748.firebaseapp.com",
    projectId: "chatnet-2a748"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentChat = null;
let unsub = null;
let replyMsg = null;
let profileUid = null;
let selectedAvatar = 'üë§';
let selectedStatus = 'online';

// –≠–º–æ–¥–∑–∏
const emojiCategories = {
    'faces': ['üòÄ','üòÇ','üòä','üòç','üòé','üòú','üò¢','üò°','ü•≥','üò¥','ü§î','ü§©','ü•∫','üòá','ü§Ø','üò±','ü§†','üòà','üëª','ü§ñ'],
    'hands': ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé'],
    'hearts': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü'],
    'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö'],
    'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë','ü•¶','ü•ê']
};

function initEmojiPanel() {
    const categoriesContainer = document.getElementById('emojiCategories');
    const emojiGrid = document.getElementById('emojiGrid');
    
    Object.keys(emojiCategories).forEach((cat, index) => {
        const btn = document.createElement('button');
        btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
        btn.textContent = emojiCategories[cat][0];
        btn.onclick = () => setEmojiCategory(cat);
        btn.style.cssText = 'background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;padding:8px 16px;border-radius:20px;cursor:pointer;white-space:nowrap;font-size:13px;';
        categoriesContainer.appendChild(btn);
    });
    
    setEmojiCategory('faces');
}

function setEmojiCategory(category) {
    const emojiGrid = document.getElementById('emojiGrid');
    const buttons = document.querySelectorAll('#emojiCategories button');
    
    buttons.forEach(btn => btn.style.background = 'rgba(30,41,59,0.8)');
    event.target.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
    event.target.style.color = 'white';
    
    emojiGrid.innerHTML = '';
    emojiCategories[category].forEach(emoji => {
        const span = document.createElement('span');
        span.textContent = emoji;
        span.onclick = () => addEmoji(emoji);
        span.style.cssText = 'font-size:24px;text-align:center;cursor:pointer;padding:6px;border-radius:10px;transition:all 0.2s ease;background:rgba(30,41,59,0.5);';
        span.onmouseover = () => span.style.background = 'rgba(59,130,246,0.3)';
        span.onmouseout = () => span.style.background = 'rgba(30,41,59,0.5)';
        emojiGrid.appendChild(span);
    });
}

// –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
function selectAvatar(avatar, type) {
    selectedAvatar = avatar;
    const selector = type === 'setup' ? '#avatarSelectorSetup' : '#avatarSelector';
    document.querySelectorAll(`${selector} > div`).forEach(option => {
        option.style.borderColor = 'transparent';
    });
    event.target.style.borderColor = '#3b82f6';
    
    if (type === 'setup') {
        document.querySelector('#profileSetup .profile-avatar').textContent = avatar;
    }
}

// –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
function selectStatus(status, type) {
    selectedStatus = status;
    const selector = type === 'setup' ? '#statusSelectorSetup' : '#statusSelector';
    document.querySelectorAll(`${selector} > div`).forEach(option => {
        option.style.borderColor = 'transparent';
    });
    event.target.style.borderColor = '#3b82f6';
}

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
async function login() {
    try {
        await auth.createUserWithEmailAndPassword(email.value, password.value);
    } catch(err) {
        try {
            await auth.signInWithEmailAndPassword(email.value, password.value);
        } catch(err2) {
            showNotification('–û—à–∏–±–∫–∞', err2.message);
        }
    }
}

auth.onAuthStateChanged(async u => {
    if(!u) {
        show("auth");
        return;
    }
    
    try {
        await db.collection("users").doc(u.uid).update({
            online: true,
            lastSeen: Date.now(),
            status: 'online'
        });
    } catch(err) {}
    
    const d = await db.collection("users").doc(u.uid).get();
    d.exists ? startApp(d.data()) : show("profileSetup");
});

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
async function saveProfile() {
    await db.collection("users").doc(auth.currentUser.uid).set({
        username: username.value || `User${Math.floor(Math.random()*10000)}`,
        avatar: selectedAvatar || "üë§",
        bio: bio.value || "",
        online: true,
        lastSeen: Date.now(),
        status: selectedStatus,
        createdAt: Date.now(),
        friends: [],
        blocked: [],
        stats: { messages: 0, posts: 0, friends: 0 }
    });
    startApp({username: username.value, avatar: selectedAvatar});
}

// –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
function startApp(u) {
    show("main");
    me.innerText = `${u.avatar || "üë§"} ${u.username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}`;
    loadUsers();
    initEmojiPanel();
    requestNotificationPermission();
}

// –í–∫–ª–∞–¥–∫–∏
function openTab(id, el) {
    ["chats","news","friends"].forEach(x => document.getElementById(x).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
}

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
const cid = (a,b) => [a,b].sort().join("_");

function formatLastSeen(timestamp) {
    if (!timestamp) return "–¥–∞–≤–Ω–æ";
    const now = Date.now();
    const diff = now - timestamp;
    if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
    if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
    const date = new Date(timestamp);
    return date.toLocaleDateString('ru-RU');
}

function loadUsers() {
    db.collection("users").onSnapshot(s => {
        users.innerHTML = "";
        s.forEach(d => {
            if(d.id !== auth.currentUser.uid) {
                const u = d.data();
                let statusText = '';
                if (u.status === 'invisible') {
                    statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
                } else if (u.online) {
                    statusText = `üü¢ –í —Å–µ—Ç–∏`;
                } else {
                    statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
                }
                
                users.innerHTML += `
                <div class="user" onclick="openChat('${d.id}')">
                    <div class="avatar">${u.avatar || "üë§"}</div>
                    <div style="flex:1">
                        <div>${u.username}</div>
                        <div style="font-size:13px;color:#94a3b8;">${statusText}</div>
                    </div>
                </div>`;
            }
        });
    });
}

// –ß–∞—Ç
function openChat(uid) {
    currentChat = cid(auth.currentUser.uid, uid);
    if(unsub) unsub();
    unsub = db.collection("chats").doc(currentChat).collection("messages").orderBy("time").onSnapshot(s => {
        chat.innerHTML = "";
        s.forEach(d => {
            const m = d.data();
            const timeStr = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            chat.innerHTML += `
            <div class="msg ${m.uid === auth.currentUser.uid ? "me" : ""}" onclick="reply('${m.text.replace(/'/g, "\\'")}')">
                ${m.replyTo ? `<div style="font-size:13px;color:#cbd5e1;border-left:3px solid #60a5fa;padding-left:8px;margin-bottom:6px;">‚Ü© ${m.replyTo}</div>` : ""}
                ${m.text}
                <div style="font-size:11px;opacity:0.7;text-align:right;margin-top:4px;">${timeStr}</div>
            </div>`;
        });
        chat.scrollTop = chat.scrollHeight;
    });
}

async function send() {
    if(!currentChat || !text.value) return;
    const messageData = {
        uid: auth.currentUser.uid,
        text: text.value,
        replyTo: replyMsg,
        time: Date.now()
    };
    
    try {
        await db.collection("chats").doc(currentChat).collection("messages").add(messageData);
        text.value = "";
        cancelReply();
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        const chatParts = currentChat.split('_');
        const receiverId = chatParts[0] === auth.currentUser.uid ? chatParts[1] : chatParts[0];
        const receiver = await db.collection("users").doc(receiverId).get();
        if (receiver.exists) {
            showNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', `${me.innerText}: ${messageData.text.substring(0, 50)}...`);
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
    }
}

function reply(t) { 
    replyMsg = t; 
    replyText.innerText = t; 
    replyBox.classList.remove("hidden"); 
}

function cancelReply() { 
    replyMsg = null; 
    replyBox.classList.add("hidden"); 
}

function toggleEmoji() { 
    emojiPanel.classList.toggle("hidden"); 
}

function addEmoji(e) { 
    text.value += e; 
    text.focus(); 
}

// –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
function loadPosts() {
    db.collection("posts").orderBy("time","desc").onSnapshot(s => {
        posts.innerHTML = "";
        s.forEach(d => {
            const p = d.data();
            posts.innerHTML += `<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
        });
    });
}

async function createPost() {
    if(!postText.value) return;
    await db.collection("posts").add({
        username: me.innerText,
        text: postText.value,
        time: Date.now(),
        uid: auth.currentUser.uid
    });
    postText.value = "";
}

// –ü—Ä–æ—Ñ–∏–ª—å
async function openProfile(uid) {
    profileUid = uid;
    const d = await db.collection("users").doc(uid).get();
    const u = d.data();
    
    document.getElementById('pAvatar').textContent = u.avatar || "üë§";
    document.getElementById('pName').textContent = u.username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    document.getElementById('pBio').textContent = u.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ";
    
    if (u.status === 'invisible') {
        document.getElementById('pStatus').textContent = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
    } else if (u.online) {
        document.getElementById('pStatus').textContent = `üü¢ –í —Å–µ—Ç–∏`;
    } else {
        document.getElementById('pStatus').textContent = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
    }
    
    show("profileView");
}

function writeFromProfile() {
    back();
    openChat(profileUid);
}

async function openMyProfile() {
    const d = await db.collection("users").doc(auth.currentUser.uid).get();
    const u = d.data();
    
    document.getElementById('myUsername').value = u.username || "";
    document.getElementById('myBio').value = u.bio || "";
    document.getElementById('myAvatarPreview').textContent = u.avatar || "üë§";
    
    show("myProfile");
}

async function updateMyProfile() {
    const updateData = {
        avatar: document.getElementById('myAvatarPreview').textContent,
        username: document.getElementById('myUsername').value,
        bio: document.getElementById('myBio').value
    };
    
    await db.collection("users").doc(auth.currentUser.uid).update(updateData);
    me.innerText = `${updateData.avatar} ${updateData.username}`;
    back();
}

// –î—Ä—É–∑—å—è
function loadFriends() {
    db.collection("users").onSnapshot(s => {
        friendsList.innerHTML = "";
        s.forEach(d => {
            if(d.id !== auth.currentUser.uid) {
                const u = d.data();
                let statusText = '';
                if (u.status === 'invisible') {
                    statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
                } else if (u.online) {
                    statusText = `üü¢ –í —Å–µ—Ç–∏`;
                } else {
                    statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
                }
                friendsList.innerHTML += `
                <div class="user" onclick="openProfile('${d.id}')">
                    <div class="avatar">${u.avatar || "üë§"}</div>
                    <div style="flex:1">
                        <div>${u.username}</div>
                        <div style="font-size:13px;color:#94a3b8;">${statusText}</div>
                    </div>
                </div>`;
            }
        });
    });
}

// UI —Ñ—É–Ω–∫—Ü–∏–∏
function show(id) {
    ["auth","profileSetup","main","profileView","myProfile"].forEach(x => document.getElementById(x).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
}

function back() { 
    show("main"); 
}

async function logout() {
    if (auth.currentUser) {
        await db.collection("users").doc(auth.currentUser.uid).update({
            online: false,
            lastSeen: Date.now(),
            status: 'offline'
        });
    }
    auth.signOut();
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    updateOnlineStatus();
});
</script>
</body>
</html>
