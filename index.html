<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet Pro</title>

<style>
/* –°–ë–†–û–° –ò –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary-bg: #0f172a;
  --secondary-bg: #1e293b;
  --accent-color: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  --text-color: #e2e8f0;
  --border-color: rgba(255, 255, 255, 0.1);
}

.theme-light {
  --primary-bg: #f8fafc;
  --secondary-bg: #ffffff;
  --accent-color: #2563eb;
  --accent-gradient: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  --text-color: #1e293b;
  --border-color: rgba(30, 41, 59, 0.1);
}

.theme-dark {
  --primary-bg: #0f172a;
  --secondary-bg: #1e293b;
  --accent-color: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  --text-color: #e2e8f0;
  --border-color: rgba(255, 255, 255, 0.1);
}

.theme-blue {
  --primary-bg: #0c4a6e;
  --secondary-bg: #0369a1;
  --accent-color: #38bdf8;
  --accent-gradient: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
  --text-color: #e0f2fe;
  --border-color: rgba(56, 189, 248, 0.2);
}

.theme-purple {
  --primary-bg: #4c1d95;
  --secondary-bg: #7c3aed;
  --accent-color: #a78bfa;
  --accent-gradient: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
  --text-color: #f5f3ff;
  --border-color: rgba(167, 139, 250, 0.2);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: var(--primary-bg);
  color: var(--text-color);
  height: 100vh;
  overflow: hidden;
  transition: all 0.3s ease;
}

.hidden {
  display: none !important;
}

/* –ö–û–ù–¢–ï–ô–ù–ï–† */
.container {
  max-width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--primary-bg);
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

/* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
#auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: var(--accent-gradient);
  padding: 40px 20px;
  position: relative;
  overflow: hidden;
}

#auth h2 {
  font-size: 3.5rem;
  color: white;
  margin-bottom: 40px;
  font-weight: 800;
  text-align: center;
  letter-spacing: 1px;
  text-shadow: 0 2px 20px rgba(59, 130, 246, 0.3);
}

#auth input {
  width: 100%;
  max-width: 320px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: white;
  font-size: 16px;
  transition: all 0.3s ease;
}

#auth input::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

#auth input:focus {
  outline: none;
  border-color: white;
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
}

#auth button {
  width: 100%;
  max-width: 320px;
  padding: 16px;
  background: white;
  color: #3b82f6;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}

#auth button:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(255, 255, 255, 0.3);
}

/* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
#main {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: var(--primary-bg);
}

/* –®–ê–ü–ö–ê */
header {
  background: var(--secondary-bg);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
  z-index: 10;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

#me {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-color);
  cursor: pointer;
  padding: 10px 18px;
  border-radius: 12px;
  transition: all 0.3s ease;
  background: var(--primary-bg);
  border: 1px solid var(--border-color);
}

#me:hover {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.header-btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: var(--primary-bg);
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.header-btn:hover {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
}

/* –í–ö–õ–ê–î–ö–ò */
.tabs {
  display: flex;
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  padding: 0 20px;
}

.tab {
  flex: 1;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  font-weight: 500;
  color: #94a3b8;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
  font-size: 15px;
}

.tab:hover {
  color: var(--text-color);
  background: var(--primary-bg);
}

.tab.active {
  color: var(--accent-color);
  border-bottom-color: var(--accent-color);
  font-weight: 600;
  background: var(--primary-bg);
}

/* –û–ë–õ–ê–°–¢–¨ –ß–ê–¢–û–í */
#chats {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* –°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ò –ì–†–£–ü–ü */
#users {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: var(--primary-bg);
}

.user, .group-item {
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  border-radius: 16px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
  background: var(--secondary-bg);
  border: 1px solid var(--border-color);
}

.user:hover, .group-item:hover {
  transform: translateX(5px);
  border-color: var(--accent-color);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
  border: 2px solid var(--border-color);
}

.group-avatar {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.user-info {
  flex: 1;
  min-width: 0;
}

.user-info div:first-child {
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 4px;
  font-size: 16px;
}

.status {
  font-size: 13px;
  color: #94a3b8;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* –û–ö–ù–û –ß–ê–¢–ê */
.chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  background: var(--primary-bg);
}

.msg {
  max-width: 75%;
  padding: 14px 18px;
  margin: 8px 0;
  border-radius: 18px;
  background: var(--secondary-bg);
  position: relative;
  word-wrap: break-word;
  line-height: 1.5;
  transition: all 0.3s ease;
  border: 1px solid var(--border-color);
  animation: slideIn 0.3s ease;
}

.msg:hover {
  transform: translateY(-2px);
  border-color: var(--accent-color);
}

.msg.me {
  margin-left: auto;
  background: var(--accent-gradient);
  color: white;
  border: none;
}

.msg.edited::after {
  content: " (—Ä–µ–¥.)";
  font-size: 11px;
  opacity: 0.7;
  font-style: italic;
}

.msg small {
  display: block;
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 6px;
}

.msg-actions {
  position: absolute;
  right: -40px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  flex-direction: column;
  gap: 5px;
  background: var(--secondary-bg);
  padding: 8px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.msg:hover .msg-actions {
  display: flex;
}

.msg-action-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: var(--primary-bg);
  color: var(--text-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s ease;
}

.msg-action-btn:hover {
  background: var(--accent-color);
  color: white;
}

.reply-preview {
  font-size: 13px;
  color: #cbd5e1;
  border-left: 3px solid var(--accent-color);
  padding-left: 10px;
  margin-bottom: 8px;
  background: rgba(96, 165, 250, 0.1);
  padding: 8px 12px;
  border-radius: 10px;
  font-style: italic;
}

.forwarded-from {
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* –ü–ê–ù–ï–õ–¨ –≠–ú–û–î–ó–ò */
#emojiPanel {
  background: var(--secondary-bg);
  border-top: 1px solid var(--border-color);
  padding: 20px;
  max-height: 200px;
  overflow: hidden;
}

/* –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê */
.input {
  display: flex;
  gap: 12px;
  padding: 20px;
  background: var(--secondary-bg);
  border-top: 1px solid var(--border-color);
  align-items: flex-end;
}

.input input {
  flex: 1;
  padding: 16px 20px;
  border-radius: 25px;
  border: 2px solid var(--border-color);
  font-size: 16px;
  transition: all 0.3s ease;
  background: var(--primary-bg);
  color: var(--text-color);
}

.input input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.input input:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
}

.input button {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
  border: 1px solid var(--border-color);
}

.input button:first-child {
  background: var(--primary-bg);
  color: var(--text-color);
  font-size: 20px;
}

.input button:first-child:hover {
  background: var(--accent-color);
  color: white;
}

.input button:last-child {
  background: var(--accent-gradient);
  color: white;
  font-size: 20px;
}

.input button:last-child:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
}

/* –ü–†–ï–í–¨–Æ –û–¢–í–ï–¢–ê */
#replyBox {
  padding: 14px 20px;
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: #94a3b8;
}

/* –õ–ï–ù–¢–ê –ù–û–í–û–°–¢–ï–ô */
#news {
  flex: 1;
  overflow-y: auto;
  background: var(--primary-bg);
  padding: 24px;
}

#postText {
  width: 100%;
  padding: 18px 20px;
  border: 2px solid var(--border-color);
  border-radius: 16px;
  font-size: 16px;
  margin-bottom: 20px;
  background: var(--secondary-bg);
  resize: none;
  min-height: 120px;
  color: var(--text-color);
}

#postText::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

#postText:focus {
  outline: none;
  border-color: var(--accent-color);
}

.post {
  background: var(--secondary-bg);
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 20px;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.post:hover {
  transform: translateY(-2px);
  border-color: var(--accent-color);
}

.post b {
  color: var(--text-color);
  font-size: 16px;
  margin-bottom: 8px;
  display: block;
}

/* –î–†–£–ó–¨–Ø */
#friends {
  padding: 24px;
  overflow: auto;
  flex: 1;
  background: var(--primary-bg);
}

/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: var(--secondary-bg);
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid var(--border-color);
}

.modal-title {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--text-color);
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  color: var(--text-color);
  font-size: 24px;
  cursor: pointer;
}

.modal-close:hover {
  color: var(--accent-color);
}

/* –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø */
.theme-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.theme-option {
  padding: 20px;
  border-radius: 12px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  text-align: center;
}

.theme-option:hover {
  transform: scale(1.05);
}

.theme-option.selected {
  border-color: var(--accent-color);
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
}

/* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  background: var(--secondary-bg);
  border-radius: 12px;
  border: 1px solid var(--border-color);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  z-index: 1000;
  animation: slideInRight 0.3s ease;
  max-width: 300px;
}

.notification.success {
  border-left: 4px solid #22c55e;
}

.notification.error {
  border-left: 4px solid #ef4444;
}

.notification.info {
  border-left: 4px solid #3b82f6;
}

.notification-warning {
  border-left: 4px solid #f59e0b;
}

/* –ú–û–î–ï–†–ê–¶–ò–Ø */
.report-btn {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.report-btn:hover {
  background: rgba(239, 68, 68, 0.2);
}

/* –†–û–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô */
.role-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.role-admin {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.role-moderator {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
}

.role-user {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  color: white;
}

/* –°–ö–†–û–õ–õ–ë–ê–† */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--secondary-bg);
}

::-webkit-scrollbar-thumb {
  background: var(--accent-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #2563eb;
}

/* –ê–ù–ò–ú–ê–¶–ò–ò */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
@media (max-width: 768px) {
  .tab {
    padding: 16px 12px;
    font-size: 14px;
  }
  
  .avatar {
    width: 44px;
    height: 44px;
    font-size: 22px;
  }
  
  .input {
    padding: 16px;
  }
  
  .modal-content {
    width: 95%;
    padding: 20px;
  }
  
  .theme-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet Pro</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <div class="profile-header" style="background: var(--accent-gradient); padding: 40px 20px 30px; text-align: center;">
    <div class="profile-avatar" id="setupAvatarPreview" style="font-size: 64px; width: 120px; height: 120px; margin: 0 auto 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid rgba(255, 255, 255, 0.2);">üë§</div>
    <div class="profile-name" style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: white;">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
  </div>
  
  <div class="profile-section" style="padding: 20px;">
    <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
    <div class="avatar-selector" id="avatarSelectorSetup">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'setup')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'setup')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'setup')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'setup')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'setup')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'setup')">üëë</div>
    </div>
    
    <input id="username" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid var(--border-color); background: var(--secondary-bg); color: var(--text-color);"><br>
    
    <div class="section-title">–°—Ç–∞—Ç—É—Å</div>
    <div class="status-selector" id="statusSelectorSetup">
      <div class="status-option selected" onclick="selectStatus('online', 'setup')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'setup')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'setup')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <button onclick="saveProfile()" style="width:100%;padding:16px;background:var(--accent-gradient); color: white; border: none; border-radius: 12px; font-weight: 600; margin-top: 20px;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
<header>
  <div class="header-left">
    <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
    <button class="header-btn" onclick="showGroupCreation()">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    <button class="header-btn" onclick="showThemeSelector()">üé® –¢–µ–º—ã</button>
    <button class="header-btn" onclick="showNotificationsSettings()">üîî</button>
  </div>
  <div class="header-actions">
    <button class="header-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
  </div>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div id="replyBox" class="hidden">
    –û—Ç–≤–µ—Ç: <span id="replyText"></span>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden">
    <div class="emoji-category" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>

  <div class="input">
    <button onclick="toggleEmoji()">üòÄ</button>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key=='Enter') send()">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding: 20px; font-weight: 600; color: var(--text-color); background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); display: flex; gap: 10px;">
    <span onclick="showUsersList()" style="cursor: pointer; padding: 8px 16px; border-radius: 8px; background: var(--accent-color); color: white;">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
    <span onclick="showGroupsList()" style="cursor: pointer; padding: 8px 16px; border-radius: 8px; background: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color);">üë• –ì—Ä—É–ø–ø—ã</span>
  </div>
  <div id="users"></div>
</div>

<div id="news" class="hidden">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()" style="padding: 14px 30px; background: var(--accent-gradient); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
  <div id="posts"></div>
</div>

<div id="friends" class="hidden" style="padding:24px;overflow:auto;flex:1;">
  <div style="font-weight: 600; color: var(--text-color); margin-bottom: 20px; font-size: 18px;">–î—Ä—É–∑—å—è</div>
  <div id="friendsList"></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
  <div class="tab" onclick="showModerationPanel()">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</div>
</div>

</div>

<!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

<!-- –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü–´ -->
<div id="groupCreationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('groupCreationModal')">√ó</button>
    <div class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</div>
    
    <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%;margin-bottom:15px;padding:12px;border-radius:8px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-color);">
    
    <div style="margin: 15px 0;">
      <div style="font-weight:600;margin-bottom:10px;color:var(--text-color);">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</div>
      <div id="groupAvatarSelector" style="display:flex;gap:10px;flex-wrap:wrap;">
        <div class="avatar-option" onclick="selectGroupAvatar('üë•')">üë•</div>
        <div class="avatar-option" onclick="selectGroupAvatar('üë®‚Äçüë©‚Äçüëß‚Äçüë¶')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="avatar-option" onclick="selectGroupAvatar('üéâ')">üéâ</div>
        <div class="avatar-option" onclick="selectGroupAvatar('üíº')">üíº</div>
        <div class="avatar-option" onclick="selectGroupAvatar('üéÆ')">üéÆ</div>
        <div class="avatar-option" onclick="selectGroupAvatar('üìö')">üìö</div>
      </div>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight:600;margin-bottom:10px;color:var(--text-color);">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</div>
      <div id="groupMembersList" style="max-height:200px;overflow-y:auto;padding:10px;background:var(--primary-bg);border-radius:8px;border:1px solid var(--border-color);"></div>
    </div>
    
    <button onclick="createGroup()" style="width:100%;padding:14px;background:var(--accent-gradient);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
  </div>
</div>

<!-- –í–´–ë–û–† –¢–ï–ú–´ -->
<div id="themeSelectorModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('themeSelectorModal')">√ó</button>
    <div class="modal-title">–í—ã–±–æ—Ä —Ç–µ–º—ã</div>
    
    <div class="theme-grid">
      <div class="theme-option" onclick="selectTheme('light')" style="background: #f8fafc; color: #1e293b;">
        ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è
      </div>
      <div class="theme-option" onclick="selectTheme('dark')" style="background: #0f172a; color: #e2e8f0;">
        üåô –¢–µ–º–Ω–∞—è
      </div>
      <div class="theme-option" onclick="selectTheme('blue')" style="background: #0c4a6e; color: #e0f2fe;">
        üîµ –°–∏–Ω—è—è
      </div>
      <div class="theme-option" onclick="selectTheme('purple')" style="background: #4c1d95; color: #f5f3ff;">
        üü£ –§–∏–æ–ª–µ—Ç–æ–≤–∞—è
      </div>
      <div class="theme-option" onclick="selectTheme('green')" style="background: #064e3b; color: #d1fae5;">
        üü¢ –ó–µ–ª–µ–Ω–∞—è
      </div>
      <div class="theme-option" onclick="selectTheme('red')" style="background: #7f1d1d; color: #fee2e2;">
        üî¥ –ö—Ä–∞—Å–Ω–∞—è
      </div>
    </div>
  </div>
</div>

<!-- –ù–ê–°–¢–†–û–ô–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
<div id="notificationsModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('notificationsModal')">√ó</button>
    <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
    
    <div style="margin: 20px 0;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin:10px 0;">
        <span style="color:var(--text-color);">–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
        <label class="switch">
          <input type="checkbox" id="soundEnabled" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="display:flex;align-items:center;justify-content:space-between;margin:10px 0;">
        <span style="color:var(--text-color);">Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        <label class="switch">
          <input type="checkbox" id="pushEnabled">
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="display:flex;align-items:center;justify-content:space-between;margin:10px 0;">
        <span style="color:var(--text-color);">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</span>
        <label class="switch">
          <input type="checkbox" id="messageNotifications" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="display:flex;align-items:center;justify-content:space-between;margin:10px 0;">
        <span style="color:var(--text-color);">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞—Ö</span>
        <label class="switch">
          <input type="checkbox" id="postNotifications">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <button onclick="saveNotificationSettings()" style="width:100%;padding:14px;background:var(--accent-gradient);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- –ü–ê–ù–ï–õ–¨ –ú–û–î–ï–†–ê–¶–ò–ò -->
<div id="moderationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('moderationModal')">√ó</button>
    <div class="modal-title">–ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
    
    <div style="margin: 20px 0;">
      <div style="font-weight:600;color:var(--text-color);margin-bottom:15px;">–ñ–∞–ª–æ–±—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
      <div id="reportsList" style="max-height:300px;overflow-y:auto;">
        <!-- –°–ø–∏—Å–æ–∫ –∂–∞–ª–æ–± –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
      </div>
    </div>
    
    <div style="margin: 20px 0;">
      <div style="font-weight:600;color:var(--text-color);margin-bottom:15px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</div>
      <div id="bannedUsersList" style="max-height:200px;overflow-y:auto;">
        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö -->
      </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button onclick="loadReports()" style="flex:1;padding:12px;background:var(--accent-gradient);color:white;border:none;border-radius:8px;cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button onclick="showUserManagement()" style="flex:1;padding:12px;background:var(--secondary-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px;cursor:pointer;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
    </div>
  </div>
</div>

<!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò -->
<div id="userManagementModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('userManagementModal')">√ó</button>
    <div class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
    
    <div style="margin: 20px 0;">
      <div style="font-weight:600;color:var(--text-color);margin-bottom:15px;">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</div>
      <input type="text" id="userSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ email" oninput="searchUsers(this.value)" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-color);margin-bottom:15px;">
      
      <div id="searchResults" style="max-height:300px;overflow-y:auto;">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
      </div>
    </div>
  </div>
</div>

<!-- –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) -->
<div id="profileView" class="hidden">
  <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ—Ñ–∏–ª—è -->
</div>

</div>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
firebase.initializeApp({
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentChat = null;
let currentChatType = null; // 'private' –∏–ª–∏ 'group'
let unsub = null;
let replyMsg = null;
let forwardMsg = null;
let editingMsg = null;
let selectedGroupAvatar = 'üë•';
let currentTheme = 'dark';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('chatnet_theme') || 'dark';
  selectTheme(savedTheme);
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  loadNotificationSettings();
});

// === –ì–†–£–ü–ü–û–í–´–ï –ß–ê–¢–´ ===

let selectedGroupMembers = new Set();

function showGroupCreation() {
  loadUsersForGroup();
  showModal('groupCreationModal');
}

async function loadUsersForGroup() {
  const membersList = document.getElementById('groupMembersList');
  membersList.innerHTML = '';
  selectedGroupMembers.clear();
  
  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc => {
    if (doc.id !== auth.currentUser.uid) {
      const user = doc.data();
      const div = document.createElement('div');
      div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:5px;cursor:pointer;border:1px solid var(--border-color);';
      div.innerHTML = `
        <div class="avatar" style="width:32px;height:32px;font-size:16px;">${user.avatar || 'üë§'}</div>
        <div>${user.username}</div>
        <div style="margin-left:auto;color:var(--accent-color);">+</div>
      `;
      div.onclick = () => toggleGroupMember(doc.id, div);
      membersList.appendChild(div);
    }
  });
}

function toggleGroupMember(uid, element) {
  if (selectedGroupMembers.has(uid)) {
    selectedGroupMembers.delete(uid);
    element.style.background = '';
    element.querySelector('div:last-child').textContent = '+';
  } else {
    selectedGroupMembers.add(uid);
    element.style.background = 'var(--accent-gradient)';
    element.querySelector('div:last-child').textContent = '‚úì';
  }
}

function selectGroupAvatar(avatar) {
  selectedGroupAvatar = avatar;
  document.querySelectorAll('#groupAvatarSelector .avatar-option').forEach(el => {
    el.style.border = '2px solid transparent';
  });
  event.target.style.border = '2px solid var(--accent-color)';
}

async function createGroup() {
  const groupName = document.getElementById('groupNameInput').value.trim();
  if (!groupName || selectedGroupMembers.size === 0) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', 'error');
    return;
  }
  
  const groupId = 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  const members = Array.from(selectedGroupMembers);
  members.push(auth.currentUser.uid);
  
  const groupData = {
    id: groupId,
    name: groupName,
    avatar: selectedGroupAvatar,
    creator: auth.currentUser.uid,
    members: members,
    admins: [auth.currentUser.uid],
    createdAt: Date.now(),
    lastActivity: Date.now()
  };
  
  try {
    await db.collection('groups').doc(groupId).set(groupData);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –≤ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    const batch = db.batch();
    members.forEach(memberId => {
      const userRef = db.collection('users').doc(memberId);
      batch.update(userRef, {
        groups: firebase.firestore.FieldValue.arrayUnion(groupId)
      });
    });
    await batch.commit();
    
    showNotification(`–ì—Ä—É–ø–ø–∞ "${groupName}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
    closeModal('groupCreationModal');
    loadGroups();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + error.message, 'error');
  }
}

async function loadGroups() {
  const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
  const userGroups = userDoc.data()?.groups || [];
  
  if (userGroups.length === 0) return;
  
  const groupsSnapshot = await db.collection('groups')
    .where('id', 'in', userGroups)
    .get();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
  // ... –∫–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä—É–ø–ø
}

function openGroupChat(groupId) {
  currentChat = groupId;
  currentChatType = 'group';
  loadGroupMessages(groupId);
}

async function loadGroupMessages(groupId) {
  if (unsub) unsub();
  
  unsub = db.collection('groupMessages')
    .doc(groupId)
    .collection('messages')
    .orderBy('time')
    .onSnapshot(snapshot => {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        displayMessage(msg, chat, true);
      });
      
      chat.scrollTop = chat.scrollHeight;
    });
}

// === –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ===

function forwardMessage(messageId) {
  forwardMsg = messageId;
  showUsersListForForward();
}

async function showUsersListForForward() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;">
      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
      <div class="modal-title">–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
      <div id="forwardUsersList" style="max-height:300px;overflow-y:auto;"></div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const usersList = document.getElementById('forwardUsersList');
  usersList.innerHTML = '';
  
  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc => {
    if (doc.id !== auth.currentUser.uid) {
      const user = doc.data();
      const div = document.createElement('div');
      div.className = 'user';
      div.style.cssText = 'padding:10px;margin:5px;cursor:pointer;border-radius:8px;border:1px solid var(--border-color);';
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="avatar" style="width:32px;height:32px;font-size:16px;">${user.avatar || 'üë§'}</div>
          <div>${user.username}</div>
        </div>
      `;
      div.onclick = () => sendForwardedMessage(doc.id, user);
      usersList.appendChild(div);
    }
  });
}

async function sendForwardedMessage(toUid, userData) {
  if (!forwardMsg) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  let originalMsg;
  if (currentChatType === 'group') {
    const msgDoc = await db.collection('groupMessages').doc(currentChat)
      .collection('messages').doc(forwardMsg).get();
    originalMsg = msgDoc.data();
  } else {
    const chatId = cid(auth.currentUser.uid, toUid);
    const msgDoc = await db.collection('chats').doc(chatId)
      .collection('messages').doc(forwardMsg).get();
    originalMsg = msgDoc.data();
  }
  
  if (!originalMsg) return;
  
  const messageData = {
    uid: auth.currentUser.uid,
    text: originalMsg.text,
    forwardedFrom: originalMsg.username || userData.username,
    forwardedFromId: originalMsg.uid,
    time: Date.now(),
    status: 'delivered'
  };
  
  const chatId = cid(auth.currentUser.uid, toUid);
  await db.collection('chats').doc(chatId)
    .collection('messages').add(messageData);
  
  showNotification(`–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ ${userData.username}`, 'success');
  document.querySelector('.modal').remove();
  forwardMsg = null;
}

// === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===

function startEditingMessage(messageId, currentText) {
  editingMsg = { id: messageId, text: currentText };
  const textInput = document.getElementById('text');
  textInput.value = currentText;
  textInput.focus();
  textInput.setSelectionRange(currentText.length, currentText.length);
  
  // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  const sendBtn = document.querySelector('.input button:last-child');
  sendBtn.innerHTML = 'üíæ';
  sendBtn.onclick = saveEditedMessage;
}

async function saveEditedMessage() {
  if (!editingMsg || !currentChat) return;
  
  const newText = document.getElementById('text').value.trim();
  if (!newText || newText === editingMsg.text) {
    cancelEditing();
    return;
  }
  
  try {
    if (currentChatType === 'group') {
      await db.collection('groupMessages').doc(currentChat)
        .collection('messages').doc(editingMsg.id)
        .update({
          text: newText,
          edited: true,
          editTime: Date.now()
        });
    } else {
      await db.collection('chats').doc(currentChat)
        .collection('messages').doc(editingMsg.id)
        .update({
          text: newText,
          edited: true,
          editTime: Date.now()
        });
    }
    
    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
    cancelEditing();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message, 'error');
  }
}

function cancelEditing() {
  editingMsg = null;
  document.getElementById('text').value = '';
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
  const sendBtn = document.querySelector('.input button:last-child');
  sendBtn.innerHTML = '‚û§';
  sendBtn.onclick = send;
}

// === –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø ===

function showThemeSelector() {
  showModal('themeSelectorModal');
}

function selectTheme(themeName) {
  currentTheme = themeName;
  
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º
  document.body.classList.remove('theme-light', 'theme-dark', 'theme-blue', 'theme-purple');
  // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
  document.body.classList.add(`theme-${themeName}`);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
  localStorage.setItem('chatnet_theme', themeName);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –º–µ–Ω—é
  document.querySelectorAll('.theme-option').forEach(el => {
    el.classList.remove('selected');
  });
  event.target.classList.add('selected');
  
  showNotification(`–¢–µ–º–∞ "${themeName}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞`, 'success');
}

// === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===

function showNotificationsSettings() {
  showModal('notificationsModal');
}

function loadNotificationSettings() {
  const settings = JSON.parse(localStorage.getItem('chatnet_notifications') || '{}');
  
  document.getElementById('soundEnabled').checked = settings.soundEnabled !== false;
  document.getElementById('pushEnabled').checked = settings.pushEnabled || false;
  document.getElementById('messageNotifications').checked = settings.messageNotifications !== false;
  document.getElementById('postNotifications').checked = settings.postNotifications || false;
}

function saveNotificationSettings() {
  const settings = {
    soundEnabled: document.getElementById('soundEnabled').checked,
    pushEnabled: document.getElementById('pushEnabled').checked,
    messageNotifications: document.getElementById('messageNotifications').checked,
    postNotifications: document.getElementById('postNotifications').checked
  };
  
  localStorage.setItem('chatnet_notifications', JSON.stringify(settings));
  showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
  closeModal('notificationsModal');
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    notification.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function playNotificationSound() {
  const settings = JSON.parse(localStorage.getItem('chatnet_notifications') || '{}');
  if (settings.soundEnabled !== false) {
    // –°–æ–∑–¥–∞–µ–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  }
}

// === –ú–û–î–ï–†–ê–¶–ò–Ø –ö–û–ù–¢–ï–ù–¢–ê ===

function showModerationPanel() {
  if (!checkUserRole(['admin', 'moderator'])) {
    showNotification('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º', 'error');
    return;
  }
  showModal('moderationModal');
  loadReports();
  loadBannedUsers();
}

async function checkUserRole(allowedRoles) {
  const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
  const userRole = userDoc.data()?.role || 'user';
  return allowedRoles.includes(userRole);
}

async function loadReports() {
  const reportsList = document.getElementById('reportsList');
  reportsList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-color);opacity:0.7;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  try {
    const snapshot = await db.collection('reports')
      .orderBy('timestamp', 'desc')
      .limit(20)
      .get();
    
    if (snapshot.empty) {
      reportsList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-color);opacity:0.7;">–ù–µ—Ç –∂–∞–ª–æ–±</div>';
      return;
    }
    
    reportsList.innerHTML = '';
    snapshot.forEach(doc => {
      const report = doc.data();
      const reportDiv = document.createElement('div');
      reportDiv.style.cssText = 'padding:15px;margin:10px 0;background:var(--primary-bg);border-radius:8px;border:1px solid var(--border-color);';
      
      const time = new Date(report.timestamp).toLocaleString();
      reportDiv.innerHTML = `
        <div style="font-weight:600;color:var(--text-color);margin-bottom:5px;">
          –ñ–∞–ª–æ–±–∞ –æ—Ç: ${report.reporterName || '–ê–Ω–æ–Ω–∏–º'}
          <span style="font-size:12px;color:#94a3b8;margin-left:10px;">${time}</span>
        </div>
        <div style="color:var(--text-color);opacity:0.9;margin-bottom:10px;">
          –ü—Ä–∏—á–∏–Ω–∞: ${report.reason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
        </div>
        <div style="color:var(--text-color);opacity:0.8;font-style:italic;margin-bottom:10px;">
          –°–æ–æ–±—â–µ–Ω–∏–µ: "${report.messageText || ''}"
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="handleReport('${doc.id}', 'approved')" style="padding:5px 10px;background:#22c55e;color:white;border:none;border-radius:4px;cursor:pointer;">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button onclick="handleReport('${doc.id}', 'rejected')" style="padding:5px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <button onclick="viewReportDetails('${report.messageId}', '${report.chatType}')" style="padding:5px 10px;background:var(--accent-color);color:white;border:none;border-radius:4px;cursor:pointer;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>
      `;
      reportsList.appendChild(reportDiv);
    });
  } catch (error) {
    reportsList.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

async function handleReport(reportId, action) {
  if (!await checkUserRole(['admin', 'moderator'])) {
    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
    return;
  }
  
  try {
    const reportDoc = await db.collection('reports').doc(reportId).get();
    const report = reportDoc.data();
    
    if (action === 'approved') {
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (report.chatType === 'group') {
        await db.collection('groupMessages').doc(report.chatId)
          .collection('messages').doc(report.messageId).delete();
      } else {
        await db.collection('chats').doc(report.chatId)
          .collection('messages').doc(report.messageId).delete();
      }
      
      // –ë–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Ä–µ–º—è
      await db.collection('users').doc(report.reportedUserId).update({
        bannedUntil: Date.now() + 24 * 60 * 60 * 1000, // 24 —á–∞—Å–∞
        warnings: firebase.firestore.FieldValue.increment(1)
      });
      
      showNotification('–ñ–∞–ª–æ–±–∞ –ø—Ä–∏–Ω—è—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 24 —á–∞—Å–∞', 'success');
    } else {
      showNotification('–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
    }
    
    // –£–¥–∞–ª—è–µ–º –∂–∞–ª–æ–±—É
    await db.collection('reports').doc(reportId).delete();
    loadReports();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã: ' + error.message, 'error');
  }
}

async function loadBannedUsers() {
  const bannedList = document.getElementById('bannedUsersList');
  bannedList.innerHTML = '';
  
  try {
    const snapshot = await db.collection('users')
      .where('bannedUntil', '>', Date.now())
      .get();
    
    snapshot.forEach(doc => {
      const user = doc.data();
      const div = document.createElement('div');
      div.style.cssText = 'padding:10px;margin:5px 0;background:var(--primary-bg);border-radius:8px;border:1px solid var(--border-color);';
      
      const bannedUntil = new Date(user.bannedUntil).toLocaleString();
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="avatar" style="width:32px;height:32px;font-size:16px;">${user.avatar || 'üë§'}</div>
          <div style="flex:1;">
            <div style="font-weight:600;color:var(--text-color);">${user.username}</div>
            <div style="font-size:12px;color:#ef4444;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ: ${bannedUntil}</div>
          </div>
          <button onclick="unbanUser('${doc.id}')" style="padding:5px 10px;background:#22c55e;color:white;border:none;border-radius:4px;cursor:pointer;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      `;
      bannedList.appendChild(div);
    });
  } catch (error) {
    console.error('Error loading banned users:', error);
  }
}

async function unbanUser(userId) {
  if (!await checkUserRole(['admin'])) {
    showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', 'error');
    return;
  }
  
  try {
    await db.collection('users').doc(userId).update({
      bannedUntil: null
    });
    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
    loadBannedUsers();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ' + error.message, 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –∂–∞–ª–æ–±—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
function reportMessage(messageId, chatType, chatId, userId, messageText) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;">
      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
      <div class="modal-title">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
      
      <div style="margin:15px 0;">
        <div style="margin-bottom:10px;color:var(--text-color);">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É:</div>
        <select id="reportReason" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-color);">
          <option value="spam">–°–ø–∞–º</option>
          <option value="offensive">–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è</option>
          <option value="illegal">–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
          <option value="harassment">–•–∞—Ä–∞—Å—Å–º–µ–Ω—Ç</option>
          <option value="other">–î—Ä—É–≥–æ–µ</option>
        </select>
        <textarea id="reportDetails" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏..." style="width:100%;height:100px;margin-top:10px;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-color);"></textarea>
      </div>
      
      <button onclick="submitReport('${messageId}', '${chatType}', '${chatId}', '${userId}', '${messageText}')" style="width:100%;padding:12px;background:var(--accent-gradient);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function submitReport(messageId, chatType, chatId, reportedUserId, messageText) {
  const reason = document.getElementById('reportReason').value;
  const details = document.getElementById('reportDetails').value;
  
  if (!reason) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã', 'error');
    return;
  }
  
  const reportData = {
    messageId: messageId,
    chatType: chatType,
    chatId: chatId,
    reportedUserId: reportedUserId,
    reporterId: auth.currentUser.uid,
    reporterName: (await db.collection('users').doc(auth.currentUser.uid).get()).data().username,
    reason: reason,
    details: details,
    messageText: messageText,
    timestamp: Date.now(),
    status: 'pending'
  };
  
  try {
    await db.collection('reports').add(reportData);
    showNotification('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º', 'success');
    document.querySelector('.modal').remove();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã: ' + error.message, 'error');
  }
}

// === –†–û–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===

function showUserManagement() {
  if (!checkUserRole(['admin'])) {
    showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–æ–ª—è–º–∏', 'error');
    return;
  }
  showModal('userManagementModal');
  searchUsers('');
}

async function searchUsers(query) {
  const resultsDiv = document.getElementById('searchResults');
  resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-color);opacity:0.7;">–ü–æ–∏—Å–∫...</div>';
  
  try {
    let snapshot;
    if (query) {
      // –ü–æ–∏—Å–∫ –ø–æ username
      snapshot = await db.collection('users')
        .where('username', '>=', query)
        .where('username', '<=', query + '\uf8ff')
        .limit(20)
        .get();
    } else {
      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      snapshot = await db.collection('users')
        .orderBy('createdAt', 'desc')
        .limit(20)
        .get();
    }
    
    resultsDiv.innerHTML = '';
    snapshot.forEach(doc => {
      const user = doc.data();
      const userDiv = document.createElement('div');
      userDiv.style.cssText = 'padding:15px;margin:10px 0;background:var(--primary-bg);border-radius:8px;border:1px solid var(--border-color);';
      
      const role = user.role || 'user';
      userDiv.innerHTML = `
        <div style="display:flex;align-items:center;gap:15px;">
          <div class="avatar" style="width:40px;height:40px;font-size:20px;">${user.avatar || 'üë§'}</div>
          <div style="flex:1;">
            <div style="font-weight:600;color:var(--text-color);">${user.username}</div>
            <div style="font-size:12px;color:#94a3b8;">${user.email || '–ù–µ—Ç email'}</div>
          </div>
          <div class="role-badge role-${role}">${role === 'admin' ? '–ê–¥–º–∏–Ω' : role === 'moderator' ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
          <select onchange="changeUserRole('${doc.id}', this.value)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--secondary-bg);color:var(--text-color);">
            <option value="user" ${role === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
            <option value="moderator" ${role === 'moderator' ? 'selected' : ''}>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
            <option value="admin" ${role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          </select>
        </div>
      `;
      resultsDiv.appendChild(userDiv);
    });
    
    if (snapshot.empty) {
      resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-color);opacity:0.7;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    }
  } catch (error) {
    resultsDiv.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
  }
}

async function changeUserRole(userId, newRole) {
  if (!await checkUserRole(['admin'])) {
    showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏', 'error');
    return;
  }
  
  try {
    await db.collection('users').doc(userId).update({
      role: newRole,
      roleUpdatedAt: Date.now(),
      roleUpdatedBy: auth.currentUser.uid
    });
    
    showNotification(`–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "${newRole}"`, 'success');
    searchUsers(document.getElementById('userSearch').value);
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏: ' + error.message, 'error');
  }
}

// === –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò ===

function showModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

function cid(a, b) {
  return [a, b].sort().join("_");
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
function displayMessage(msg, container, isGroup = false) {
  const timeStr = new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const isOwnMessage = msg.uid === auth.currentUser.uid;
  
  let messageHTML = `
    <div class="msg ${isOwnMessage ? "me" : ""} ${msg.edited ? "edited" : ""}" 
         style="position:relative;">
      ${msg.forwardedFrom ? `
        <div class="forwarded-from">
          ‚Ü™Ô∏è –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç: ${msg.forwardedFrom}
        </div>
      ` : ''}
      ${msg.replyTo ? `
        <div class="reply-preview">‚Ü© ${msg.replyTo}</div>
      ` : ""}
      ${msg.text}
      <small>${timeStr} ${msg.edited ? '(—Ä–µ–¥.)' : ''}</small>
      
      <div class="msg-actions">
        <button class="msg-action-btn" onclick="reply('${msg.text.replace(/'/g, "\\'")}')" title="–û—Ç–≤–µ—Ç–∏—Ç—å">‚Ü©</button>
        <button class="msg-action-btn" onclick="forwardMessage('${msg.messageId || ''}')" title="–ü–µ—Ä–µ—Å–ª–∞—Ç—å">‚Ü™</button>
        ${isOwnMessage ? `
          <button class="msg-action-btn" onclick="startEditingMessage('${msg.messageId || ''}', '${msg.text.replace(/'/g, "\\'")}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
        ` : `
          <button class="msg-action-btn" onclick="reportMessage('${msg.messageId || ''}', '${isGroup ? 'group' : 'private'}', '${currentChat}', '${msg.uid}', '${msg.text.replace(/'/g, "\\'")}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">üö´</button>
        `}
      </div>
    </div>
  `;
  
  container.innerHTML += messageHTML;
}

// === –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò (–ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–´–ï) ===

async function login(){
  try{
    await auth.createUserWithEmailAndPassword(email.value, password.value);
  } catch(err){
    try{
      await auth.signInWithEmailAndPassword(email.value, password.value);
    } catch(err2){
      showNotification('–û—à–∏–±–∫–∞: ' + err2.message, 'error');
    }
  }
}

auth.onAuthStateChanged(async u => {
  if(!u){
    show("auth");
    return;
  }
  
  try {
    await db.collection("users").doc(u.uid).update({
      online: true,
      lastSeen: Date.now(),
      status: 'online'
    });
  } catch(err) {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  }
  
  const d = await db.collection("users").doc(u.uid).get();
  d.exists ? startApp(d.data()) : show("profileSetup");
});

async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid).set({
    username: username.value || `User${Math.floor(Math.random()*10000)}`,
    avatar: selectedAvatar || "üë§",
    online: true,
    lastSeen: Date.now(),
    status: selectedStatus,
    createdAt: Date.now(),
    role: 'user',
    groups: []
  });
  startApp({username: username.value, avatar: selectedAvatar});
}

function startApp(u){
  show("main");
  me.innerText = `${u.avatar || "üë§"} ${u.username}`;
  loadUsers(); 
  loadPosts(); 
  loadFriends();
  showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${u.username}!`, 'success');
}

function openTab(id, el){
  ["chats","news","friends"].forEach(x => document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  el.classList.add("active");
}

function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  if (diff < 604800000) return `${Math.floor(diff/86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

function loadUsers(){
  db.collection("users").onSnapshot(s => {
    users.innerHTML = "";
    s.forEach(d => {
      if(d.id !== auth.currentUser.uid){
        const u = d.data();
        let statusText = '';
        
        if (u.status === 'invisible') {
          statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
        } else if (u.online) {
          statusText = `üü¢ –í —Å–µ—Ç–∏`;
        } else {
          statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        }
        
        users.innerHTML += `
        <div class="user" onclick="openChat('${d.id}')">
          <div class="avatar">${u.avatar || "üë§"}</div>
          <div class="user-info">
            <div>${u.username} ${u.role === 'admin' ? 'üëë' : u.role === 'moderator' ? 'üõ°Ô∏è' : ''}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

async function openChat(uid){
  currentChat = cid(auth.currentUser.uid, uid);
  currentChatType = 'private';
  if(unsub) unsub();
  unsub = db.collection("chats").doc(currentChat).collection("messages").orderBy("time").onSnapshot(s => {
    chat.innerHTML = "";
    s.forEach(d => {
      const m = d.data();
      displayMessage(m, chat);
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

async function send(){
  if(!currentChat || !text.value) return;
  
  const messageData = {
    uid: auth.currentUser.uid,
    text: text.value,
    replyTo: replyMsg,
    time: Date.now(),
    status: 'delivered',
    messageId: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  };
  
  try {
    if (currentChatType === 'group') {
      await db.collection('groupMessages').doc(currentChat)
        .collection('messages').add(messageData);
    } else {
      await db.collection("chats").doc(currentChat)
        .collection("messages").add(messageData);
    }
    
    text.value = "";
    cancelReply();
    cancelEditing();
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
  }
}

function reply(t){ 
  replyMsg = t; 
  document.getElementById('replyText').innerText = t; 
  document.getElementById('replyBox').classList.remove("hidden"); 
}

function cancelReply(){ 
  replyMsg = null; 
  document.getElementById('replyBox').classList.add("hidden"); 
}

function toggleEmoji(){ 
  document.getElementById('emojiPanel').classList.toggle("hidden"); 
}

function loadPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(s => {
    posts.innerHTML = "";
    s.forEach(d => {
      const p = d.data();
      posts.innerHTML += `<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
    });
  });
}

async function createPost(){
  if(!postText.value) return;
  await db.collection("posts").add({
    username: me.innerText,
    text: postText.value,
    time: Date.now(),
    uid: auth.currentUser.uid
  });
  postText.value = "";
  showNotification('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω', 'success');
}

function loadFriends(){
  db.collection("users").onSnapshot(s => {
    friendsList.innerHTML = "";
    s.forEach(d => {
      if(d.id !== auth.currentUser.uid){
        const u = d.data();
        let statusText = '';
        if (u.status === 'invisible') {
          statusText = '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
        } else if (u.online) {
          statusText = `üü¢ –í —Å–µ—Ç–∏`;
        } else {
          statusText = `‚ö™ –±—ã–ª(–∞) ${formatLastSeen(u.lastSeen)}`;
        }
        friendsList.innerHTML += `
        <div class="user">
          <div class="avatar">${u.avatar || "üë§"}</div>
          <div class="user-info">
            <div>${u.username}</div>
            <div class="status">${statusText}</div>
          </div>
        </div>`;
      }
    });
  });
}

function show(id){
  ["auth","profileSetup","main","profileView","myProfile"].forEach(x => document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function back(){ 
  show("main"); 
}

async function logout(){
  if (auth.currentUser) {
    await db.collection("users").doc(auth.currentUser.uid).update({
      online: false,
      lastSeen: Date.now(),
      status: 'offline'
    });
  }
  auth.signOut();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏
function initEmojiPanel() {
  const categories = {
    'faces': ['üòÄ','üòÇ','üòä','üòç','üòé','üòú','üò¢','üò°','ü•≥','üò¥'],
    'hearts': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é'],
    'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®'],
    'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê'],
    'objects': ['üí°','üì±','üíª','‚åö','üì∑','üéÆ','üîë','üí∞','üíé']
  };
  
  const categoriesContainer = document.getElementById('emojiCategories');
  const emojiGrid = document.getElementById('emojiGrid');
  
  Object.keys(categories).forEach((cat, index) => {
    const btn = document.createElement('button');
    btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
    btn.textContent = categories[cat][0];
    btn.onclick = () => setEmojiCategory(cat, categories[cat]);
    categoriesContainer.appendChild(btn);
  });
  
  setEmojiCategory('faces', categories['faces']);
}

function setEmojiCategory(category, emojis) {
  const emojiGrid = document.getElementById('emojiGrid');
  const buttons = document.querySelectorAll('.emoji-category-btn');
  
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  emojiGrid.innerHTML = '';
  emojis.forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.onclick = () => addEmoji(emoji);
    emojiGrid.appendChild(span);
  });
}

function addEmoji(e){ 
  document.getElementById('text').value += e; 
  document.getElementById('text').focus(); 
}

function selectAvatar(avatar, type) {
  selectedAvatar = avatar;
  if (type === 'setup') {
    document.getElementById('setupAvatarPreview').textContent = avatar;
  }
}

function selectStatus(status, type) {
  selectedStatus = status;
}
</script>
</body>
</html>
