<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --success: #22c55e;
  --danger: #f72585;
  --warning: #f59e0b;
  --dark: #0a0e17;
  --dark-secondary: #131b2d;
  --dark-tertiary: #1a243f;
  --light: #f8f9fa;
  --gray: #6c757d;
  --border: #2a3655;
  --shadow: rgba(0, 0, 0, 0.3);
  --gradient: linear-gradient(135deg, #4361ee, #7209b7);
}

body {
  background: var(--dark);
  color: var(--light);
  height: 100vh;
  overflow: hidden;
}

/* –û–±—â–∏–µ –∫–ª–∞—Å—Å—ã */
.hidden { display: none !important; }
.text-muted { color: var(--gray); }
.text-small { font-size: 0.85rem; }
.text-center { text-align: center; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-1 { gap: 0.5rem; }
.gap-2 { gap: 1rem; }
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.rounded { border-radius: 10px; }
.rounded-full { border-radius: 50%; }
.shadow { box-shadow: 0 4px 12px var(--shadow); }
.transition { transition: all 0.3s ease; }

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
.container {
  max-width: 500px;
  height: 100vh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  background: var(--dark);
  position: relative;
  overflow: hidden;
}

/* –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è */
#auth {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  padding: 2rem;
  background: var(--gradient);
}

.auth-card {
  background: var(--dark-secondary);
  padding: 2.5rem;
  border-radius: 20px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
}

.logo {
  text-align: center;
  margin-bottom: 2rem;
}

.logo-icon {
  font-size: 3.5rem;
  background: var(--gradient);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin-bottom: 0.5rem;
}

.logo h1 {
  font-size: 2.2rem;
  background: linear-gradient(to right, #4cc9f0, #4361ee);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 800;
  letter-spacing: 1px;
}

.logo p {
  color: var(--gray);
  font-size: 0.9rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--light);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 1rem;
  background: var(--dark-tertiary);
  border: 2px solid var(--border);
  border-radius: 12px;
  color: var(--light);
  font-size: 1rem;
  transition: all 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

.btn {
  padding: 1rem 1.5rem;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.3s;
  width: 100%;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--dark-tertiary);
  color: var(--light);
}

.btn-secondary:hover {
  background: var(--border);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
}

.auth-footer {
  margin-top: 1.5rem;
  text-align: center;
  color: var(--gray);
  font-size: 0.9rem;
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
#main {
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* –®–∞–ø–∫–∞ */
.header {
  background: var(--dark-secondary);
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.user-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: var(--gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  cursor: pointer;
  border: 3px solid var(--primary);
}

.user-info h3 {
  font-size: 1.1rem;
  font-weight: 600;
}

.user-info p {
  font-size: 0.8rem;
  color: var(--gray);
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.online-dot {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  display: inline-block;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--dark-tertiary);
  border: none;
  color: var(--light);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
}

.icon-btn:hover {
  background: var(--primary);
}

/* –í–∫–ª–∞–¥–∫–∏ */
.tabs {
  display: flex;
  background: var(--dark-secondary);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 73px;
  z-index: 9;
}

.tab {
  flex: 1;
  padding: 1rem;
  text-align: center;
  cursor: pointer;
  color: var(--gray);
  font-weight: 500;
  transition: all 0.3s;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.tab.active {
  color: var(--primary);
}

.tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40%;
  height: 3px;
  background: var(--primary);
  border-radius: 3px 3px 0 0;
}

.tab-badge {
  background: var(--danger);
  color: white;
  font-size: 0.7rem;
  padding: 0.1rem 0.4rem;
  border-radius: 10px;
  margin-left: 0.3rem;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
.tab-content {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.tab-pane {
  height: 100%;
  display: flex;
  flex-direction: column;
  flex: 1;
}

/* –ß–∞—Ç */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  flex: 1;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.message {
  max-width: 85%;
  padding: 1rem;
  border-radius: 18px;
  position: relative;
  animation: fadeIn 0.3s ease;
  word-wrap: break-word;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-incoming {
  background: var(--dark-tertiary);
  align-self: flex-start;
  border-bottom-left-radius: 5px;
}

.message-outgoing {
  background: var(--primary);
  align-self: flex-end;
  border-bottom-right-radius: 5px;
}

.message-sender {
  font-weight: 600;
  font-size: 0.85rem;
  margin-bottom: 0.3rem;
  color: var(--success);
}

.message-text {
  line-height: 1.5;
  word-break: break-word;
}

.message-time {
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.6);
  margin-top: 0.5rem;
  text-align: right;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0.3rem;
}

.message-status {
  font-size: 0.7rem;
}

.reply-indicator {
  background: rgba(255, 255, 255, 0.1);
  border-left: 3px solid var(--primary);
  padding: 0.5rem;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.chat-input-container {
  padding: 1rem;
  background: var(--dark-secondary);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 0.8rem;
  align-items: flex-end;
}

.chat-input-wrapper {
  flex: 1;
  background: var(--dark-tertiary);
  border-radius: 25px;
  padding: 0.5rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.chat-input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--light);
  font-size: 1rem;
  padding: 0.5rem 0;
  resize: none;
  max-height: 120px;
  min-height: 24px;
  outline: none;
  font-family: inherit;
}

.input-action-btn {
  background: transparent;
  border: none;
  color: var(--gray);
  font-size: 1.2rem;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.input-action-btn:hover {
  background: var(--border);
  color: var(--primary);
}

.send-btn {
  background: var(--primary);
  color: white;
  border: none;
  width: 46px;
  height: 46px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
}

.send-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

/* –≠–º–æ–¥–∑–∏ –ø–∞–Ω–µ–ª—å */
.emoji-panel {
  background: var(--dark-secondary);
  border-top: 1px solid var(--border);
  padding: 1rem;
  max-height: 250px;
  overflow-y: auto;
}

.emoji-categories {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

.emoji-category-btn {
  background: var(--dark-tertiary);
  border: none;
  color: var(--light);
  padding: 0.5rem 1rem;
  border-radius: 20px;
  cursor: pointer;
  white-space: nowrap;
  font-size: 0.9rem;
  transition: all 0.3s;
}

.emoji-category-btn.active {
  background: var(--primary);
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 0.5rem;
}

.emoji-item {
  font-size: 1.5rem;
  text-align: center;
  cursor: pointer;
  padding: 0.3rem;
  border-radius: 8px;
  transition: all 0.2s;
}

.emoji-item:hover {
  background: var(--dark-tertiary);
  transform: scale(1.2);
}

/* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-list, .friends-list {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  padding: 1rem;
}

.user-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--dark-tertiary);
  border-radius: 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.user-item:hover {
  background: var(--border);
  transform: translateX(5px);
}

.user-avatar-sm {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}

.user-details {
  flex: 1;
}

.user-name {
  font-weight: 600;
  margin-bottom: 0.2rem;
}

.user-status {
  font-size: 0.8rem;
  color: var(--gray);
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.user-actions {
  display: flex;
  gap: 0.5rem;
}

/* –ù–æ–≤–æ—Å—Ç–∏ */
.posts-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding: 1rem;
}

.create-post {
  background: var(--dark-secondary);
  padding: 1.5rem;
  border-radius: 15px;
}

.create-post textarea {
  width: 100%;
  background: var(--dark-tertiary);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--light);
  padding: 1rem;
  font-size: 1rem;
  resize: none;
  min-height: 100px;
  margin-bottom: 1rem;
  outline: none;
  font-family: inherit;
}

.post {
  background: var(--dark-secondary);
  padding: 1.5rem;
  border-radius: 15px;
}

.post-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.post-author {
  font-weight: 600;
}

.post-time {
  font-size: 0.8rem;
  color: var(--gray);
}

.post-content {
  line-height: 1.6;
  margin-bottom: 1rem;
  word-break: break-word;
}

.post-actions {
  display: flex;
  gap: 1rem;
  border-top: 1px solid var(--border);
  padding-top: 1rem;
}

.post-action {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--gray);
  cursor: pointer;
  transition: all 0.3s;
}

.post-action:hover {
  color: var(--primary);
}

/* –ü—Ä–æ—Ñ–∏–ª—å */
.profile-header {
  background: var(--gradient);
  padding: 2rem 1.5rem;
  text-align: center;
  position: relative;
}

.profile-back-btn {
  position: absolute;
  left: 1.5rem;
  top: 2rem;
  background: rgba(0, 0, 0, 0.3);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.3s;
}

.profile-back-btn:hover {
  background: rgba(0, 0, 0, 0.5);
  transform: translateX(-3px);
}

.profile-avatar-large {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: var(--gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  margin: 0 auto 1rem;
  border: 5px solid white;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
}

.profile-name {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.profile-status {
  font-size: 0.9rem;
  opacity: 0.9;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.profile-stats {
  display: flex;
  justify-content: space-around;
  padding: 1.5rem;
  background: var(--dark-secondary);
  border-radius: 15px;
  margin: 1.5rem;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 0.3rem;
}

.stat-label {
  font-size: 0.85rem;
  opacity: 0.7;
}

.profile-section {
  padding: 0 1.5rem 1.5rem;
}

.section-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.profile-bio {
  background: var(--dark-secondary);
  padding: 1.5rem;
  border-radius: 15px;
  line-height: 1.6;
  word-break: break-word;
}

.profile-actions {
  padding: 1.5rem;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.action-btn {
  flex: 1;
  min-width: 140px;
  padding: 1rem;
  border-radius: 12px;
  border: none;
  background: var(--dark-tertiary);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  font-weight: 500;
  transition: all 0.3s;
}

.action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.action-btn.primary {
  background: var(--primary);
}

.action-btn.success {
  background: var(--success);
}

.action-btn.danger {
  background: var(--danger);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.pulse {
  animation: pulse 2s infinite;
}

/* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--dark-tertiary);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 500px) {
  .container {
    max-width: 100%;
  }
  
  .auth-card {
    padding: 2rem 1.5rem;
  }
  
  .profile-actions {
    flex-direction: column;
  }
  
  .action-btn {
    min-width: 100%;
  }
  
  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
  }
}

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
.avatar-selector {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.avatar-option {
  font-size: 24px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--dark-tertiary);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s;
}

.avatar-option.selected {
  border-color: var(--primary);
  background: var(--primary-dark);
  transform: scale(1.1);
}

.status-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.status-option {
  flex: 1;
  padding: 10px;
  text-align: center;
  background: var(--dark-tertiary);
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  min-width: 100px;
  transition: all 0.3s;
}

.status-option.selected {
  border-color: var(--primary);
  background: var(--primary-dark);
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  color: white;
  font-weight: 500;
  z-index: 10000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  animation: slideIn 0.3s ease;
  max-width: 300px;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
<div id="auth">
  <div class="auth-card shadow">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-comments"></i></div>
      <h1>ChatNet Pro</h1>
      <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
    </div>
    
    <div class="form-group">
      <label class="form-label">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
      <input type="email" id="email" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email" value="test@test.com">
    </div>
    
    <div class="form-group">
      <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="password" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value="123456">
    </div>
    
    <button class="btn btn-primary" onclick="login()">
      <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </button>
    
    <div class="auth-footer mt-2">
      <p>–ü—Ä–æ–¥–æ–ª–∂–∞—è, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–∞—à–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p>
    </div>
  </div>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
<div id="profileSetup" class="hidden">
  <div class="profile-header">
    <button class="profile-back-btn" onclick="logout()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="profile-avatar-large" id="setupAvatarPreview">üë§</div>
    <div class="profile-name">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
    <div class="profile-status">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">
      <i class="fas fa-user-circle"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    </div>
    
    <div class="form-group mb-2">
      <label class="form-label">–ù–∏–∫–Ω–µ–π–º</label>
      <input type="text" id="username" class="form-control" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º" value="User">
    </div>
    
    <div class="section-title mt-2">
      <i class="fas fa-smile"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä
    </div>
    <div class="avatar-selector" id="avatarSelectorSetup">
      <div class="avatar-option selected" onclick="selectAvatar(this, 'üë§', 'setup')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üòé', 'setup')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'ü§ñ', 'setup')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üê∂', 'setup')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'ü¶ä', 'setup')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üëë', 'setup')">üëë</div>
    </div>
    
    <div class="section-title mt-2">
      <i class="fas fa-circle"></i> –°—Ç–∞—Ç—É—Å
    </div>
    <div class="status-selector" id="statusSelectorSetup">
      <div class="status-option selected" onclick="selectStatus(this, 'online', 'setup')">
        <i class="fas fa-circle" style="color: #22c55e;"></i> –í —Å–µ—Ç–∏
      </div>
      <div class="status-option" onclick="selectStatus(this, 'busy', 'setup')">
        <i class="fas fa-circle" style="color: #f59e0b;"></i> –ó–∞–Ω—è—Ç
      </div>
      <div class="status-option" onclick="selectStatus(this, 'invisible', 'setup')">
        <i class="fas fa-circle" style="color: #6b7280;"></i> –ù–µ–≤–∏–¥–∏–º–∫–∞
      </div>
    </div>
    
    <div class="form-group mt-2">
      <label class="form-label">–û —Å–µ–±–µ</label>
      <textarea id="bio" class="form-control" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ..." rows="3">–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ChatNet</textarea>
    </div>
    
    <button class="btn btn-primary mt-2" onclick="saveProfile()">
      <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
    </button>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="main" class="hidden">
  <!-- –®–∞–ø–∫–∞ -->
  <div class="header">
    <div class="header-left">
      <div class="user-avatar" id="userAvatar" onclick="openMyProfile()">üë§</div>
      <div class="user-info">
        <h3 id="usernameDisplay">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
        <p><span class="online-dot"></span> <span id="userStatus">–í —Å–µ—Ç–∏</span></p>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="icon-btn" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
      <button class="icon-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
      </button>
      <button class="icon-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
  
  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <div class="tab active" onclick="openTab('chats', this)">
      <i class="fas fa-comments"></i> –ß–∞—Ç—ã <span class="tab-badge" id="unreadCount">0</span>
    </div>
    <div class="tab" onclick="openTab('contacts', this)">
      <i class="fas fa-users"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã
    </div>
    <div class="tab" onclick="openTab('news', this)">
      <i class="fas fa-newspaper"></i> –ù–æ–≤–æ—Å—Ç–∏
    </div>
    <div class="tab" onclick="openTab('profile', this)">
      <i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
    </div>
  </div>
  
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
  <div class="tab-content">
    <!-- –ß–∞—Ç -->
    <div id="chats" class="tab-pane">
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div id="replyBox" class="hidden" style="padding: 10px; background: var(--dark-tertiary); border-left: 4px solid var(--primary); margin: 0 1rem;">
          <div class="flex justify-between items-center">
            <div>
              <small class="text-muted">–û—Ç–≤–µ—Ç –Ω–∞:</small>
              <div id="replyText" style="font-size: 0.9rem;"></div>
            </div>
            <button class="icon-btn btn-sm" onclick="cancelReply()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div id="emojiPanel" class="emoji-panel hidden">
          <!-- –≠–º–æ–¥–∑–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        
        <div class="chat-input-container">
          <button class="input-action-btn" onclick="toggleEmoji()">
            <i class="far fa-smile"></i>
          </button>
          
          <div class="chat-input-wrapper">
            <textarea id="messageInput" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
            
            <button class="input-action-btn" onclick="attachFile()">
              <i class="fas fa-paperclip"></i>
            </button>
          </div>
          
          <button class="send-btn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
    <div id="contacts" class="tab-pane hidden">
      <div class="users-list" id="contactsList">
        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
    
    <!-- –ù–æ–≤–æ—Å—Ç–∏ -->
    <div id="news" class="tab-pane hidden">
      <div class="posts-container">
        <div class="create-post">
          <textarea id="postText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
          <button class="btn btn-primary" onclick="createPost()">
            <i class="fas fa-paper-plane"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
          </button>
        </div>
        
        <div id="postsContainer">
          <!-- –ü–æ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>
    
    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="profile" class="tab-pane hidden">
      <div class="profile-header">
        <div class="profile-avatar-large" id="profileAvatar">üë§</div>
        <div class="profile-name" id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="profile-status" id="profileStatusText">
          <i class="fas fa-circle" style="color: #22c55e;"></i> –í —Å–µ—Ç–∏
        </div>
      </div>
      
      <div class="profile-stats">
        <div class="stat-item">
          <div class="stat-value" id="statMessages">0</div>
          <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statFriends">0</div>
          <div class="stat-label">–î—Ä—É–∑–µ–π</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statPosts">0</div>
          <div class="stat-label">–ü–æ—Å—Ç–æ–≤</div>
        </div>
      </div>
      
      <div class="profile-section">
        <div class="section-title">
          <i class="fas fa-info-circle"></i> –û —Å–µ–±–µ
        </div>
        <div class="profile-bio" id="profileBio">
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
        </div>
      </div>
      
      <div class="profile-actions">
        <button class="action-btn primary" onclick="openMyProfileEditor()">
          <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="action-btn" onclick="showSettings()">
          <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
        <button class="action-btn success" onclick="showStats()">
          <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
      </div>
    </div>
  </div>
</div>

<!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div id="profileView" class="hidden">
  <div class="profile-header">
    <button class="profile-back-btn" onclick="backToMain()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="profile-avatar-large" id="pAvatar">üë§</div>
    <div class="profile-name" id="pName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
    <div class="profile-status" id="pStatus">
      <i class="fas fa-circle" style="color: #22c55e;"></i> –í —Å–µ—Ç–∏
    </div>
  </div>
  
  <div class="profile-stats">
    <div class="stat-item">
      <div class="stat-value" id="pMessages">0</div>
      <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pFriends">0</div>
      <div class="stat-label">–î—Ä—É–∑–µ–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pPosts">0</div>
      <div class="stat-label">–ü–æ—Å—Ç–æ–≤</div>
    </div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">
      <i class="fas fa-info-circle"></i> –û —Å–µ–±–µ
    </div>
    <div class="profile-bio" id="pBio">
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
    </div>
  </div>
  
  <div class="profile-actions">
    <button class="action-btn primary" onclick="writeToUser()">
      <i class="fas fa-comment"></i> –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    </button>
    <button class="action-btn success" onclick="toggleFriend()" id="friendBtn">
      <i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
    </button>
    <button class="action-btn danger" onclick="blockUser()" id="blockBtn">
      <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>
</div>

<!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
<div id="myProfile" class="hidden">
  <div class="profile-header">
    <button class="profile-back-btn" onclick="backToMain()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="profile-avatar-large" id="myAvatarPreview">üë§</div>
    <div class="profile-name">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
  </div>
  
  <div class="profile-section">
    <div class="section-title">
      <i class="fas fa-user-circle"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    </div>
    
    <div class="form-group mb-2">
      <label class="form-label">–ù–∏–∫–Ω–µ–π–º</label>
      <input type="text" id="myUsername" class="form-control" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
    </div>
    
    <div class="section-title mt-2">
      <i class="fas fa-smile"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä
    </div>
    <div class="avatar-selector" id="avatarSelector">
      <div class="avatar-option selected" onclick="selectAvatar(this, 'üë§', 'my')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üòé', 'my')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'ü§ñ', 'my')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üê∂', 'my')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'ü¶ä', 'my')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar(this, 'üëë', 'my')">üëë</div>
    </div>
    
    <div class="section-title mt-2">
      <i class="fas fa-circle"></i> –°—Ç–∞—Ç—É—Å
    </div>
    <div class="status-selector" id="statusSelector">
      <div class="status-option selected" onclick="selectStatus(this, 'online', 'my')">
        <i class="fas fa-circle" style="color: #22c55e;"></i> –í —Å–µ—Ç–∏
      </div>
      <div class="status-option" onclick="selectStatus(this, 'busy', 'my')">
        <i class="fas fa-circle" style="color: #f59e0b;"></i> –ó–∞–Ω—è—Ç
      </div>
      <div class="status-option" onclick="selectStatus(this, 'away', 'my')">
        <i class="fas fa-circle" style="color: #f97316;"></i> –û—Ç–æ—à–µ–ª
      </div>
      <div class="status-option" onclick="selectStatus(this, 'invisible', 'my')">
        <i class="fas fa-circle" style="color: #6b7280;"></i> –ù–µ–≤–∏–¥–∏–º–∫–∞
      </div>
    </div>
    
    <div class="form-group mt-2">
      <label class="form-label">–û —Å–µ–±–µ</label>
      <textarea id="myBio" class="form-control" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." rows="3"></textarea>
    </div>
    
    <button class="btn btn-primary mt-2" onclick="updateMyProfile()">
      <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
  </div>
</div>

</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
firebase.initializeApp({
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748"
});

const auth = firebase.auth();
const db = firebase.firestore();

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
let currentUser = null;
let currentChat = null;
let currentChatUser = null;
let chatUnsubscribe = null;
let replyToMessage = null;
let viewedProfileId = null;
let selectedAvatar = 'üë§';
let selectedStatus = 'online';
let unreadMessages = 0;

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID —á–∞—Ç–∞
const cid = (a, b) => [a, b].sort().join("_");

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏
const emojiCategories = {
  'faces': ['üòÄ','üòÇ','üòä','üòç','üòé','üòú','üò¢','üò°','ü•≥','üò¥','ü§î','ü§©','ü•∫','üòá','ü§Ø','üò±','ü§†','üòà','üëª','ü§ñ'],
  'hands': ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé'],
  'hearts': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü'],
  'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö'],
  'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë','ü•¶','ü•ê'],
  'objects': ['üí°','üì±','üíª','‚åö','üì∑','üéÆ','üîë','üí∞','üíé','‚úèÔ∏è','üìö','üéµ','üé¨','‚öΩ','üèÄ','üéÅ','üéà','üéÄ','üõí','üì¶']
};

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  initEmojiPanel();
  setupEventListeners();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const userDoc = await db.collection("users").doc(user.uid).get();
      if (userDoc.exists) {
        startApp(userDoc.data());
      } else {
        show('profileSetup');
      }
    } else {
      show('auth');
    }
  });
});

function setupEventListeners() {
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏
function initEmojiPanel() {
  const emojiPanel = document.getElementById('emojiPanel');
  if (!emojiPanel) return;
  
  // –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const categoriesContainer = document.createElement('div');
  categoriesContainer.className = 'emoji-categories';
  categoriesContainer.id = 'emojiCategories';
  
  Object.keys(emojiCategories).forEach((cat, index) => {
    const btn = document.createElement('button');
    btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
    btn.textContent = emojiCategories[cat][0];
    btn.onclick = () => setEmojiCategory(cat, btn);
    categoriesContainer.appendChild(btn);
  });
  
  const emojiGrid = document.createElement('div');
  emojiGrid.className = 'emoji-grid';
  emojiGrid.id = 'emojiGrid';
  
  emojiPanel.appendChild(categoriesContainer);
  emojiPanel.appendChild(emojiGrid);
  
  setEmojiCategory('faces', categoriesContainer.firstChild);
}

function setEmojiCategory(category, clickedBtn = null) {
  const emojiGrid = document.getElementById('emojiGrid');
  const buttons = document.querySelectorAll('.emoji-category-btn');
  
  buttons.forEach(btn => btn.classList.remove('active'));
  if (clickedBtn) {
    clickedBtn.classList.add('active');
  } else {
    buttons[0]?.classList.add('active');
  }
  
  emojiGrid.innerHTML = '';
  emojiCategories[category].forEach(emoji => {
    const span = document.createElement('span');
    span.className = 'emoji-item';
    span.textContent = emoji;
    span.onclick = () => addEmoji(emoji);
    emojiGrid.appendChild(span);
  });
}

// ========== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ==========

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  if (!email || !password) {
    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  showNotification('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...', 'info');
  
  try {
    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏
    await auth.signInWithEmailAndPassword(email, password);
    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
  } catch (error) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        showNotification('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
      } catch (createError) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞: ' + createError.message, 'error');
      }
    } else {
      showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
    }
  }
}

// ========== –°–û–ó–î–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø ==========

function selectAvatar(element, avatar, type) {
  selectedAvatar = avatar;
  
  const selector = type === 'setup' ? '#avatarSelectorSetup .avatar-option' : '#avatarSelector .avatar-option';
  document.querySelectorAll(selector).forEach(option => {
    option.classList.remove('selected');
  });
  
  element.classList.add('selected');
  
  if (type === 'setup') {
    document.getElementById('setupAvatarPreview').textContent = avatar;
  } else if (type === 'my') {
    document.getElementById('myAvatarPreview').textContent = avatar;
  }
}

function selectStatus(element, status, type) {
  selectedStatus = status;
  
  const selector = type === 'setup' ? '#statusSelectorSetup .status-option' : '#statusSelector .status-option';
  document.querySelectorAll(selector).forEach(option => {
    option.classList.remove('selected');
  });
  
  element.classList.add('selected');
}

async function saveProfile() {
  const username = document.getElementById('username').value || `User${Math.floor(Math.random() * 10000)}`;
  const bio = document.getElementById('bio').value || "";
  
  if (!username.trim()) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
    return;
  }
  
  try {
    await db.collection("users").doc(auth.currentUser.uid).set({
      username: username,
      avatar: selectedAvatar || "üë§",
      bio: bio,
      online: true,
      lastSeen: Date.now(),
      status: selectedStatus,
      createdAt: Date.now(),
      showOnline: true,
      allowMessages: true,
      friends: [],
      blocked: [],
      stats: {
        messages: 0,
        posts: 0,
        friends: 0
      }
    });
    
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
    startApp({username: username, avatar: selectedAvatar, status: selectedStatus});
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
}

// ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========

function startApp(userData) {
  show('main');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —à–∞–ø–∫–µ
  document.getElementById('userAvatar').textContent = userData.avatar || "üë§";
  document.getElementById('usernameDisplay').textContent = userData.username;
  document.getElementById('userStatus').textContent = getStatusText(userData.status);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  loadContacts();
  loadPosts();
  updateProfileInfo(userData);
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  startLastSeenUpdater();
}

function getStatusText(status) {
  const statuses = {
    'online': '–í —Å–µ—Ç–∏',
    'busy': '–ó–∞–Ω—è—Ç',
    'away': '–û—Ç–æ—à–µ–ª',
    'invisible': '–ù–µ –≤ —Å–µ—Ç–∏',
    'offline': '–ù–µ –≤ —Å–µ—Ç–∏'
  };
  return statuses[status] || '–ù–µ –≤ —Å–µ—Ç–∏';
}

// ========== –í–ö–õ–ê–î–ö–ò ==========

function openTab(tabId, element) {
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
  document.querySelectorAll('.tab-pane').forEach(tab => {
    tab.classList.add('hidden');
  });
  
  // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  const tabElement = document.getElementById(tabId);
  if (tabElement) {
    tabElement.classList.remove('hidden');
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
  if (element) {
    element.classList.add('active');
  }
  
  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
  if (tabId === 'contacts') {
    loadContacts();
  }
  
  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
  if (tabId === 'news') {
    loadPosts();
  }
}

// ========== –ö–û–ù–¢–ê–ö–¢–´ ==========

function loadContacts() {
  const contactsList = document.getElementById('contactsList');
  if (!contactsList) return;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
  contactsList.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</div>';
  
  db.collection("users").onSnapshot(snapshot => {
    if (snapshot.empty) {
      contactsList.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
      return;
    }
    
    contactsList.innerHTML = '';
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        const userId = doc.id;
        
        const lastSeen = formatLastSeen(user.lastSeen);
        const statusHtml = getStatusHtml(user.status, user.online, user.showOnline);
        
        const contactItem = document.createElement('div');
        contactItem.className = 'user-item';
        contactItem.innerHTML = `
          <div class="user-avatar-sm">
            ${user.avatar || "üë§"}
          </div>
          <div class="user-details" onclick="startChat('${userId}')">
            <div class="user-name">${user.username}</div>
            <div class="user-status">${statusHtml} ‚Ä¢ ${lastSeen}</div>
          </div>
          <div class="user-actions">
            <button class="icon-btn btn-sm" onclick="startChat('${userId}')">
              <i class="fas fa-comment"></i>
            </button>
            <button class="icon-btn btn-sm" onclick="openUserProfile('${userId}')">
              <i class="fas fa-user"></i>
            </button>
          </div>
        `;
        
        contactsList.appendChild(contactItem);
      }
    });
  }, error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
    contactsList.innerHTML = '<div class="text-center text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
  });
}

function getStatusHtml(status, online = true, showOnline = true) {
  if (status === 'invisible') {
    return `<i class="fas fa-circle" style="color: #6b7280;"></i> –ù–µ –≤ —Å–µ—Ç–∏`;
  }
  
  if (!online || !showOnline) {
    return `<i class="fas fa-circle" style="color: #6b7280;"></i> –ù–µ –≤ —Å–µ—Ç–∏`;
  }
  
  const colors = {
    'online': '#22c55e',
    'busy': '#f59e0b',
    'away': '#f97316'
  };
  
  const color = colors[status] || '#6b7280';
  const text = getStatusText(status);
  
  return `<i class="fas fa-circle" style="color: ${color};"></i> ${text}`;
}

function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  if (diff < 604800000) return `${Math.floor(diff/86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

// ========== –ß–ê–¢ ==========

function startChat(userId) {
  if (!userId) {
    showNotification('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω', 'error');
    return;
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —á–∞—Ç–æ–≤
  openTab('chats');
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º –≤–µ–¥–µ–º —á–∞—Ç
  currentChatUser = userId;
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —á–∞—Ç–∞
  const chatId = cid(auth.currentUser.uid, userId);
  currentChat = chatId;
  
  // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
  if (chatUnsubscribe) {
    chatUnsubscribe();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
  loadChatMessages(chatId);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
  loadChatUserInfo(userId);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
  }
}

function loadChatMessages(chatId) {
  chatUnsubscribe = db.collection("chats").doc(chatId)
    .collection("messages")
    .orderBy("time", "asc")
    .onSnapshot(snapshot => {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      chatMessages.innerHTML = '';
      
      if (snapshot.empty) {
        chatMessages.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
        return;
      }
      
      snapshot.forEach(doc => {
        const message = doc.data();
        displayMessage(message);
      });
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
      scrollChatToBottom();
      
      // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
      if (currentChatUser) {
        markMessagesAsRead(currentChatUser);
      }
    }, error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages) {
        chatMessages.innerHTML = '<div class="text-center text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
      }
    });
}

function loadChatUserInfo(userId) {
  db.collection("users").doc(userId).get().then(doc => {
    if (doc.exists) {
      const user = doc.data();
      document.getElementById('usernameDisplay').textContent = user.username;
      document.getElementById('userStatus').textContent = getStatusText(user.status);
      document.getElementById('userAvatar').textContent = user.avatar || "üë§";
    }
  });
}

function displayMessage(message) {
  const chatMessages = document.getElementById('chatMessages');
  if (!chatMessages) return;
  
  const isCurrentUser = message.uid === auth.currentUser.uid;
  const messageClass = isCurrentUser ? 'message-outgoing' : 'message-incoming';
  
  const time = new Date(message.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  let statusIcon = '';
  if (isCurrentUser) {
    if (message.status === 'sending') statusIcon = 'üîÑ';
    else if (message.status === 'error') statusIcon = '‚ùå';
    else if (message.status === 'read') statusIcon = 'üëÅÔ∏è‚úì';
    else statusIcon = '‚úì';
  }
  
  const messageHtml = `
    <div class="message ${messageClass}" onclick="replyToMessage('${message.text.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">
      ${message.replyTo ? `<div class="reply-indicator">‚Ü© ${message.replyTo.substring(0, 50)}${message.replyTo.length > 50 ? '...' : ''}</div>` : ''}
      <div class="message-text">${message.text}</div>
      <div class="message-time">
        ${time}
        ${isCurrentUser && statusIcon ? `<span class="message-status">${statusIcon}</span>` : ''}
      </div>
    </div>
  `;
  
  chatMessages.innerHTML += messageHtml;
}

async function sendMessage() {
  if (!currentChat || !auth.currentUser) {
    showNotification('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
    return;
  }
  
  const messageInput = document.getElementById('messageInput');
  const messageText = messageInput.value.trim();
  
  if (!messageText) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
    return;
  }
  
  const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const messageData = {
    uid: auth.currentUser.uid,
    text: messageText,
    replyTo: replyToMessage,
    time: Date.now(),
    status: 'sending',
    messageId: messageId
  };
  
  try {
    // –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —á–∞—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    await db.collection("chats").doc(currentChat).set({
      lastMessage: messageText,
      lastMessageTime: Date.now(),
      participants: [auth.currentUser.uid, currentChatUser],
      updatedAt: Date.now()
    }, { merge: true });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).set(messageData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"
    await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).update({ status: 'delivered' });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
    await db.collection("chats").doc(currentChat).update({
      lastMessage: messageText,
      lastMessageTime: Date.now(),
      updatedAt: Date.now()
    });
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
    cancelReply();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
    await db.collection("users").doc(auth.currentUser.uid).update({
      'stats.messages': firebase.firestore.FieldValue.increment(1)
    });
    
    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    
    try {
      await db.collection("chats").doc(currentChat).collection("messages").doc(messageId).update({ status: 'error' });
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', e);
    }
    
    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

function replyToMessage(text) {
  replyToMessage = text;
  
  const replyBox = document.getElementById('replyBox');
  const replyText = document.getElementById('replyText');
  
  if (replyBox && replyText) {
    replyText.textContent = text.substring(0, 100) + (text.length > 100 ? '...' : '');
    replyBox.classList.remove('hidden');
  }
}

function cancelReply() {
  replyToMessage = null;
  
  const replyBox = document.getElementById('replyBox');
  if (replyBox) {
    replyBox.classList.add('hidden');
  }
}

async function markMessagesAsRead(userId) {
  if (!currentChat || !userId) return;
  
  try {
    const snapshot = await db.collection("chats").doc(currentChat)
      .collection("messages")
      .where("uid", "==", userId)
      .where("status", "in", ["sending", "delivered"])
      .get();
    
    const batch = db.batch();
    snapshot.forEach(doc => {
      const ref = db.collection("chats").doc(currentChat).collection("messages").doc(doc.id);
      batch.update(ref, { status: 'read' });
    });
    
    if (snapshot.size > 0) {
      await batch.commit();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
  }
}

function toggleEmoji() {
  const emojiPanel = document.getElementById('emojiPanel');
  if (emojiPanel) {
    emojiPanel.classList.toggle('hidden');
  }
}

function addEmoji(emoji) {
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.value += emoji;
    messageInput.focus();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏
    const emojiPanel = document.getElementById('emojiPanel');
    if (emojiPanel && !emojiPanel.classList.contains('hidden')) {
      emojiPanel.classList.add('hidden');
    }
  }
}

function scrollChatToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    setTimeout(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
  }
}

// ========== –ü–†–û–§–ò–õ–ò ==========

function updateProfileInfo(userData) {
  document.getElementById('profileAvatar').textContent = userData.avatar || "üë§";
  document.getElementById('profileName').textContent = userData.username;
  document.getElementById('profileStatusText').innerHTML = getStatusHtml(userData.status, userData.online, userData.showOnline);
  document.getElementById('profileBio').textContent = userData.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ";
  
  if (userData.stats) {
    document.getElementById('statMessages').textContent = userData.stats.messages || 0;
    document.getElementById('statFriends').textContent = userData.stats.friends || 0;
    document.getElementById('statPosts').textContent = userData.stats.posts || 0;
  }
}

async function openUserProfile(userId) {
  viewedProfileId = userId;
  
  try {
    const userDoc = await db.collection("users").doc(userId).get();
    if (!userDoc.exists) {
      showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
      return;
    }
    
    const user = userDoc.data();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('pAvatar').textContent = user.avatar || "üë§";
    document.getElementById('pName').textContent = user.username;
    document.getElementById('pStatus').innerHTML = getStatusHtml(user.status, user.online, user.showOnline);
    document.getElementById('pBio').textContent = user.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ";
    
    if (user.stats) {
      document.getElementById('pMessages').textContent = user.stats.messages || 0;
      document.getElementById('pFriends').textContent = user.stats.friends || 0;
      document.getElementById('pPosts').textContent = user.stats.posts || 0;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –¥—Ä—É–∑—å—è—Ö
    const currentUserDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const currentUser = currentUserDoc.data();
    const isFriend = currentUser.friends && currentUser.friends.includes(userId);
    
    const friendBtn = document.getElementById('friendBtn');
    if (isFriend) {
      friendBtn.innerHTML = '<i class="fas fa-user-minus"></i> –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
      friendBtn.classList.remove('success');
      friendBtn.classList.add('danger');
    } else {
      friendBtn.innerHTML = '<i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è';
      friendBtn.classList.remove('danger');
      friendBtn.classList.add('success');
    }
    
    show('profileView');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
  }
}

function openMyProfileEditor() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  db.collection("users").doc(auth.currentUser.uid).get().then(doc => {
    if (doc.exists) {
      const user = doc.data();
      
      document.getElementById('myUsername').value = user.username;
      document.getElementById('myBio').value = user.bio || "";
      document.getElementById('myAvatarPreview').textContent = user.avatar || "üë§";
      
      selectedAvatar = user.avatar || "üë§";
      selectedStatus = user.status || 'online';
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä
      document.querySelectorAll('#avatarSelector .avatar-option').forEach(option => {
        option.classList.remove('selected');
        if (option.textContent === selectedAvatar) {
          option.classList.add('selected');
        }
      });
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      document.querySelectorAll('#statusSelector .status-option').forEach(option => {
        option.classList.remove('selected');
        const statusText = option.textContent.toLowerCase();
        if (statusText.includes(getStatusText(selectedStatus).toLowerCase())) {
          option.classList.add('selected');
        }
      });
      
      show('myProfile');
    }
  });
}

async function updateMyProfile() {
  const username = document.getElementById('myUsername').value;
  const bio = document.getElementById('myBio').value;
  
  if (!username.trim()) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
    return;
  }
  
  try {
    await db.collection("users").doc(auth.currentUser.uid).update({
      username: username,
      avatar: selectedAvatar,
      bio: bio,
      status: selectedStatus,
      lastSeen: Date.now()
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    document.getElementById('userAvatar').textContent = selectedAvatar;
    document.getElementById('usernameDisplay').textContent = username;
    document.getElementById('userStatus').textContent = getStatusText(selectedStatus);
    
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    backToMain();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
  }
}

async function toggleFriend() {
  if (!viewedProfileId) return;
  
  try {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    const userDoc = await userRef.get();
    const user = userDoc.data();
    
    const isFriend = user.friends && user.friends.includes(viewedProfileId);
    
    if (isFriend) {
      // –£–¥–∞–ª—è–µ–º –∏–∑ –¥—Ä—É–∑–µ–π
      await userRef.update({
        friends: firebase.firestore.FieldValue.arrayRemove(viewedProfileId),
        'stats.friends': firebase.firestore.FieldValue.increment(-1)
      });
      showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –¥—Ä—É–∑–µ–π', 'success');
    } else {
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥—Ä—É–∑—å—è
      await userRef.update({
        friends: firebase.firestore.FieldValue.arrayUnion(viewedProfileId),
        'stats.friends': firebase.firestore.FieldValue.increment(1)
      });
      showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è', 'success');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    openUserProfile(viewedProfileId);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π:', error);
    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π', 'error');
  }
}

function writeToUser() {
  if (!viewedProfileId) return;
  
  backToMain();
  startChat(viewedProfileId);
}

function blockUser() {
  showNotification('–§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// ========== –ù–û–í–û–°–¢–ò ==========

function loadPosts() {
  const postsContainer = document.getElementById('postsContainer');
  if (!postsContainer) return;
  
  postsContainer.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>';
  
  db.collection("posts").orderBy("time", "desc").limit(20).onSnapshot(snapshot => {
    postsContainer.innerHTML = '';
    
    if (snapshot.empty) {
      postsContainer.innerHTML = '<p class="text-center text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
      return;
    }
    
    snapshot.forEach(doc => {
      const post = doc.data();
      const time = new Date(post.time).toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const postHtml = `
        <div class="post">
          <div class="post-header">
            <div class="user-avatar-sm">${post.avatar || "üë§"}</div>
            <div>
              <div class="post-author">${post.username}</div>
              <div class="post-time">${time}</div>
            </div>
          </div>
          <div class="post-content">${post.text}</div>
          <div class="post-actions">
            <div class="post-action">
              <i class="far fa-thumbs-up"></i> –ù—Ä–∞–≤–∏—Ç—Å—è
            </div>
            <div class="post-action">
              <i class="far fa-comment"></i> –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
            </div>
            <div class="post-action">
              <i class="fas fa-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </div>
          </div>
        </div>
      `;
      
      postsContainer.innerHTML += postHtml;
    });
  }, error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
    postsContainer.innerHTML = '<p class="text-center text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</p>';
  });
}

async function createPost() {
  const postText = document.getElementById('postText');
  const text = postText.value.trim();
  
  if (!text) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'warning');
    return;
  }
  
  if (!auth.currentUser) {
    showNotification('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã', 'error');
    return;
  }
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const userData = userDoc.data();
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç
    await db.collection("posts").add({
      username: userData.username,
      avatar: userData.avatar || "üë§",
      text: text,
      time: Date.now(),
      uid: auth.currentUser.uid,
      likes: 0,
      comments: 0
    });
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    postText.value = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å—Ç–æ–≤
    await db.collection("users").doc(auth.currentUser.uid).update({
      'stats.posts': firebase.firestore.FieldValue.increment(1)
    });
    
    showNotification('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω', 'success');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
    showNotification('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞', 'error');
  }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function show(screenId) {
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
  ['auth', 'profileSetup', 'main', 'profileView', 'myProfile'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.classList.add('hidden');
    }
  });
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
  const screen = document.getElementById(screenId);
  if (screen) {
    screen.classList.remove('hidden');
  }
}

function backToMain() {
  show('main');
  openTab('chats', document.querySelector('.tab.active'));
}

function toggleTheme() {
  const body = document.body;
  const isDark = getComputedStyle(body).getPropertyValue('--dark').trim();
  
  if (isDark === '#0a0e17') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É
    body.style.setProperty('--dark', '#f8f9fa');
    body.style.setProperty('--dark-secondary', '#e9ecef');
    body.style.setProperty('--dark-tertiary', '#dee2e6');
    body.style.setProperty('--light', '#212529');
    body.style.setProperty('--border', '#ced4da');
    body.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.1)');
    
    showNotification('–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –≤–∫–ª—é—á–µ–Ω–∞', 'success');
  } else {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É
    body.style.setProperty('--dark', '#0a0e17');
    body.style.setProperty('--dark-secondary', '#131b2d');
    body.style.setProperty('--dark-tertiary', '#1a243f');
    body.style.setProperty('--light', '#f8f9fa');
    body.style.setProperty('--border', '#2a3655');
    body.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.3)');
    
    showNotification('–¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –≤–∫–ª—é—á–µ–Ω–∞', 'success');
  }
}

function toggleNotifications() {
  showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω—ã', 'info');
}

function attachFile() {
  showNotification('–§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function showSettings() {
  showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function showStats() {
  showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function startLastSeenUpdater() {
  setInterval(async () => {
    if (auth.currentUser) {
      try {
        await db.collection("users").doc(auth.currentUser.uid).update({
          lastSeen: Date.now()
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è lastSeen:', error);
      }
    }
  }, 30000);
}

async function logout() {
  if (auth.currentUser) {
    try {
      await db.collection("users").doc(auth.currentUser.uid).update({
        online: false,
        lastSeen: Date.now(),
        status: 'offline'
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
    }
  }
  
  await auth.signOut();
  show('auth');
}

function showNotification(message, type = 'info') {
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  document.querySelectorAll('.notification').forEach(el => el.remove());
  
  // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  const notification = document.createElement('div');
  notification.className = `notification`;
  notification.textContent = message;
  
  // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  const colors = {
    'success': '#22c55e',
    'error': '#f72585',
    'warning': '#f59e0b',
    'info': '#3b82f6'
  };
  
  notification.style.background = colors[type] || colors.info;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
  document.body.appendChild(notification);
  
  // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
</script>
</body>
</html>
