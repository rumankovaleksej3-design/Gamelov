<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ChatNet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
}
.page { display:none; padding:20px }
.page.active { display:block }

input, button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:16px;
}

button {
  background:#22c55e;
  color:black;
  font-weight:bold;
}

.chat-box {
  height:300px;
  overflow:auto;
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

.msg {
  margin-bottom:6px;
  font-size:14px;
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="page active">
  <h2>Вход / Регистрация</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Пароль">
  <button onclick="login()">Войти</button>
  <button onclick="register()">Регистрация</button>
</div>

<!-- CHAT -->
<div id="chat" class="page">
  <h2>ChatNet</h2>
  <div class="chat-box" id="messages"></div>
  <input id="msg" placeholder="Сообщение">
  <button onclick="send()">Отправить</button>
  <button onclick="logout()">Выйти</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const authPage = document.getElementById("auth");
const chatPage = document.getElementById("chat");

onAuthStateChanged(auth, user => {
  if (user) {
    authPage.classList.remove("active");
    chatPage.classList.add("active");
    loadMessages();
  } else {
    authPage.classList.add("active");
    chatPage.classList.remove("active");
  }
});

window.register = async () => {
  await createUserWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert(e.message));
};

window.login = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert(e.message));
};

window.logout = () => signOut(auth);

window.send = async () => {
  if (!msg.value) return;
  await addDoc(collection(db, "messages"), {
    user: auth.currentUser.email,
    text: msg.value,
    time: Date.now()
  });
  msg.value = "";
};

function loadMessages() {
  const q = query(collection(db, "messages"), orderBy("time"));
  onSnapshot(q, snap => {
    messages.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      const div = document.createElement("div");
      div.className = "msg";
      div.textContent = d.user + ": " + d.text;
      messages.appendChild(div);
    });
  });
}
</script>

</body>
</html>
