<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* CHATS */
#chats{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#020617;
}

/* MESSAGE */
.msg{
  max-width:80%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:12px;
  background:#1e293b;
}
.me{
  margin-left:auto;
  background:#2563eb;
}
.msg small{
  display:block;
  font-size:11px;
  opacity:.6;
  text-align:right;
  margin-top:4px;
}

/* REPLY */
.reply-preview{
  font-size:12px;
  opacity:.7;
  border-left:2px solid #60a5fa;
  padding-left:6px;
  margin-bottom:4px;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  border:none;
  border-radius:8px;
  padding:10px;
  background:#22c55e;
  font-weight:600;
  cursor:pointer;
}

/* EMOJI */
#emojiPanel{
  padding:8px;
  background:#020617;
}
#emojiPanel span{
  font-size:20px;
  cursor:pointer;
  margin:4px;
}

/* USERS */
.user{
  padding:8px;
  border-bottom:1px solid #222;
  cursor:pointer;
}
.user:hover{background:#1e293b}
.activeUser{background:#334155}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
  flex-shrink:0;
}
.tab{
  flex:1;
  padding:12px;
  text-align:center;
  cursor:pointer;
  opacity:.6;
}
.tab.active{
  opacity:1;
  background:#1e293b;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden">
  <h3>–ù–∏–∫</h3>
  <input id="username"><br><br>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
  <span id="me"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<div id="chats">

  <div class="chat" id="chat"></div>

  <!-- reply box -->
  <div id="replyBox" class="hidden" style="padding:6px;background:#020617">
    –û—Ç–≤–µ—Ç: <span id="replyText"></span>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden">
    <span onclick="addEmoji('üòÄ')">üòÄ</span>
    <span onclick="addEmoji('üòÇ')">üòÇ</span>
    <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span onclick="addEmoji('üî•')">üî•</span>
    <span onclick="addEmoji('üëç')">üëç</span>
  </div>

  <div class="input">
    <button onclick="toggleEmoji()">üòÄ</button>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>

  <div style="padding:10px;font-weight:600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
  <div id="users"></div>
  <small id="chatTitle" style="padding:10px">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>

</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
</div>

</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;
let replyMessage=null;

/* AUTH */
async function login(){
  try{
    await auth.createUserWithEmailAndPassword(email.value,password.value);
  }catch{
    await auth.signInWithEmailAndPassword(email.value,password.value);
  }
}

auth.onAuthStateChanged(async u=>{
  if(!u){show("auth");return;}
  const d=await db.collection("users").doc(u.uid).get();
  d.exists?startApp(d.data().username):show("profile");
});

/* PROFILE */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid)
    .set({username:username.value});
  startApp(username.value);
}

/* START */
function startApp(name){
  show("app");
  me.innerText="–í—ã: "+name;
  loadUsers();
}

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid)
        users.innerHTML+=`<div class="user"
          onclick="openChat('${d.id}','${d.data().username}',this)">
          ${d.data().username}
        </div>`;
    });
  });
}

/* CHAT */
const cid=(a,b)=>[a,b].sort().join("_");
function openChat(uid,name,el){
  document.querySelectorAll(".user").forEach(u=>u.classList.remove("activeUser"));
  el.classList.add("activeUser");

  currentChat=cid(auth.currentUser.uid,uid);
  chatTitle.innerText="–ß–∞—Ç —Å "+name;
  if(unsub)unsub();

  unsub=db.collection("chats").doc(currentChat)
    .collection("messages").orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const t=new Date(m.time).toLocaleTimeString([],{
          hour:'2-digit',minute:'2-digit'
        });
        chat.innerHTML+=`
          <div class="msg ${m.uid===auth.currentUser.uid?"me":""}"
            onclick='reply("${m.text}")'>
            ${m.replyTo?`<div class="reply-preview">‚Ü© ${m.replyTo.text}</div>`:""}
            ${m.text}
            <small>${t}</small>
          </div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

function send(){
  if(!currentChat||!text.value)return;
  db.collection("chats").doc(currentChat)
    .collection("messages")
    .add({
      uid:auth.currentUser.uid,
      text:text.value,
      time:Date.now(),
      replyTo:replyMessage
    });
  text.value="";
  cancelReply();
}

/* REPLY */
function reply(text){
  replyMessage={text};
  replyText.innerText=text;
  replyBox.classList.remove("hidden");
}
function cancelReply(){
  replyMessage=null;
  replyBox.classList.add("hidden");
}

/* EMOJI */
function toggleEmoji(){
  emojiPanel.classList.toggle("hidden");
}
function addEmoji(e){
  text.value+=e;
}

/* UI */
function show(id){
  ["auth","profile","app"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function logout(){auth.signOut();}
</script>
</body>
</html>
