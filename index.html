<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
  display:flex;
  justify-content:center;
}
.hidden{display:none}

.container{
  width:100%;
  max-width:420px;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* CHAT */
.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg{
  margin:6px 0;
  padding:8px 12px;
  border-radius:10px;
  background:#1e293b;
  max-width:80%;
}
.me{
  background:#2563eb;
  margin-left:auto;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  padding:10px;
  border-radius:8px;
  border:none;
  background:#22c55e;
  font-weight:600;
}

/* USERS */
.user{
  padding:8px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.user:hover{background:#020617}
.activeUser{background:#1e293b}

/* POSTS */
.post{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
}
.tab{
  flex:1;
  text-align:center;
  padding:10px;
  opacity:.6;
  cursor:pointer;
}
.tab.active{
  opacity:1;
  background:#1e293b;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden">
  <h3>–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫</h3>
  <input id="username" placeholder="–ù–∏–∫"><br><br>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
  <span id="me"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<!-- CHATS -->
<div id="chats">
  <div class="chat" id="chat"></div>

  <div class="input">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>

  <h4 style="margin:10px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
  <div id="users"></div>
  <small id="chatTitle" style="margin:10px">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
</div>

<!-- NEWS -->
<div id="news" class="hidden" style="padding:10px">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr>
  <div id="posts"></div>
</div>

<!-- FRIENDS -->
<div id="friends" class="hidden" style="padding:10px">
  <h3>–î—Ä—É–∑—å—è</h3>
  <div id="friendsList"></div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
</div>

</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;

/* AUTH */
async function login(){
  try{
    await auth.createUserWithEmailAndPassword(email.value,password.value);
  }catch{
    await auth.signInWithEmailAndPassword(email.value,password.value);
  }
}

auth.onAuthStateChanged(async user=>{
  if(!user){ show("auth"); return; }
  const d=await db.collection("users").doc(user.uid).get();
  if(!d.exists) show("profile");
  else startApp(d.data().username);
});

/* PROFILE */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid)
    .set({username:username.value});
  startApp(username.value);
}

/* START */
function startApp(name){
  show("app");
  me.innerText="–í—ã: "+name;
  loadUsers();
  loadPosts();
  loadFriends();
}

/* TABS */
function openTab(id,el){
  ["chats","news","friends"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id===auth.currentUser.uid) return;
      users.innerHTML+=`<div class="user"
        onclick="openChat('${d.id}','${d.data().username}',this)">
        ${d.data().username}
      </div>`;
    });
  });
}

/* CHAT */
function cid(a,b){return[a,b].sort().join("_");}
function openChat(uid,name,el){
  document.querySelectorAll(".user").forEach(u=>u.classList.remove("activeUser"));
  el.classList.add("activeUser");

  currentChat=cid(auth.currentUser.uid,uid);
  chatTitle.innerText="–ß–∞—Ç —Å "+name;

  if(unsub) unsub();
  unsub=db.collection("chats").doc(currentChat)
    .collection("messages").orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        chat.innerHTML+=`<div class="msg ${m.uid===auth.currentUser.uid?"me":""}">${m.text}</div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

function send(){
  if(!currentChat||!text.value) return;
  db.collection("chats").doc(currentChat)
    .collection("messages")
    .add({uid:auth.currentUser.uid,text:text.value,time:Date.now()});
  text.value="";
}

/* POSTS */
function loadPosts(){
  db.collection("posts").orderBy("time","desc")
    .onSnapshot(s=>{
      posts.innerHTML="";
      s.forEach(d=>{
        const p=d.data();
        posts.innerHTML+=`<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
      });
    });
}
function createPost(){
  if(!postText.value) return;
  db.collection("posts").add({
    uid:auth.currentUser.uid,
    username:me.innerText.replace("–í—ã: ",""),
    text:postText.value,
    time:Date.now()
  });
  postText.value="";
}

/* FRIENDS */
function loadFriends(){
  db.collection("users").onSnapshot(s=>{
    friendsList.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid)
        friendsList.innerHTML+=`<div class="user">${d.data().username}</div>`;
    });
  });
}

/* UI */
function show(id){
  ["auth","profile","app"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function logout(){auth.signOut();}
</script>
</body>
</html>
