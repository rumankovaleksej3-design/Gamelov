<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0e1621;
  color:white;
  height:100vh;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#020617;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* TABS */
.tabs{
  display:flex;
  background:#020617;
}
.tab{
  flex:1;
  padding:12px;
  text-align:center;
  cursor:pointer;
  opacity:.6;
}
.tab.active{
  opacity:1;
  background:#1e293b;
}

/* CHAT */
#chats{
  flex:1;
  display:flex;
  flex-direction:column;
}
.chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#020617;
}
.msg{
  max-width:80%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:12px;
  background:#1e293b;
}
.me{margin-left:auto;background:#2563eb}
.msg small{
  display:block;
  font-size:11px;
  opacity:.6;
  text-align:right;
}

/* INPUT */
.input{
  display:flex;
  gap:6px;
  padding:8px;
  background:#020617;
}
input,textarea{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button{
  border:none;
  border-radius:8px;
  padding:10px;
  background:#22c55e;
  font-weight:600;
  cursor:pointer;
}

/* USERS */
.user{
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  border-bottom:1px solid #222;
}
.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* POSTS */
.post{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

/* PROFILE */
#profileView{
  flex:1;
  padding:20px;
  text-align:center;
}
.profileAvatar{font-size:48px}
.profileName{font-size:20px;font-weight:700}
.profileBio{opacity:.8;margin-top:8px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="auth">
  <h2>ChatNet</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
  <input id="username" placeholder="–ù–∏–∫"><br><br>
  <input id="avatar" placeholder="–ê–≤–∞—Ç–∞—Ä (—ç–º–æ–¥–∑–∏)"><br><br>
  <textarea id="bio" placeholder="–û —Å–µ–±–µ"></textarea><br><br>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- MAIN APP -->
<div id="main" class="hidden">

<header>
  <span id="me"></span>
  <button onclick="logout()" style="background:#ef4444">–í—ã–π—Ç–∏</button>
</header>

<!-- CHATS -->
<div id="chats">
  <div class="chat" id="chat"></div>
  <div class="input">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">‚û§</button>
  </div>
  <div style="padding:10px;font-weight:600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
  <div id="users"></div>
</div>

<!-- NEWS -->
<div id="news" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea><br><br>
  <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  <hr>
  <div id="posts"></div>
</div>

<!-- FRIENDS -->
<div id="friends" class="hidden" style="padding:10px;overflow:auto;flex:1">
  <div id="friendsList"></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
</div>

</div>

<!-- PROFILE VIEW -->
<div id="profileView" class="hidden">
  <button onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="profileAvatar" id="pAvatar"></div>
  <div class="profileName" id="pName"></div>
  <div class="profileBio" id="pBio"></div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain:"chatnet-2a748.firebaseapp.com",
  projectId:"chatnet-2a748"
});

const auth=firebase.auth();
const db=firebase.firestore();

let currentChat=null;
let unsub=null;

/* AUTH */
async function login(){
  try{await auth.createUserWithEmailAndPassword(email.value,password.value);}
  catch{await auth.signInWithEmailAndPassword(email.value,password.value);}
}

auth.onAuthStateChanged(async u=>{
  if(!u){show("auth");return;}
  const d=await db.collection("users").doc(u.uid).get();
  d.exists?startApp(d.data()):show("profileSetup");
});

/* PROFILE SETUP */
async function saveProfile(){
  await db.collection("users").doc(auth.currentUser.uid).set({
    username:username.value,
    avatar:avatar.value||"üë§",
    bio:bio.value||""
  });
  startApp({username:username.value,avatar:avatar.value});
}

/* START */
function startApp(u){
  show("main");
  me.innerText=`${u.avatar||"üë§"} ${u.username}`;
  loadUsers(); loadPosts(); loadFriends();
}

/* TABS */
function openTab(id,el){
  ["chats","news","friends"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

/* USERS + CHAT */
const cid=(a,b)=>[a,b].sort().join("_");

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid){
        const u=d.data();
        users.innerHTML+=`
          <div class="user" onclick="openChat('${d.id}','${u.username}')">
            <div class="avatar" onclick="event.stopPropagation();openProfile('${d.id}')">
              ${u.avatar||"üë§"}
            </div>
            ${u.username}
          </div>`;
      }
    });
  });
}

function openChat(uid,name){
  currentChat=cid(auth.currentUser.uid,uid);
  if(unsub)unsub();
  unsub=db.collection("chats").doc(currentChat)
    .collection("messages").orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const t=new Date(m.time).toLocaleTimeString([],{
          hour:'2-digit',minute:'2-digit'
        });
        chat.innerHTML+=`
          <div class="msg ${m.uid===auth.currentUser.uid?"me":""}">
            ${m.text}
            <small>${t}</small>
          </div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

function send(){
  if(!currentChat||!text.value)return;
  db.collection("chats").doc(currentChat)
    .collection("messages")
    .add({
      uid:auth.currentUser.uid,
      text:text.value,
      time:Date.now()
    });
  text.value="";
}

/* PROFILE VIEW */
async function openProfile(uid){
  const d=await db.collection("users").doc(uid).get();
  const u=d.data();
  pAvatar.innerText=u.avatar||"üë§";
  pName.innerText=u.username;
  pBio.innerText=u.bio||"";
  show("profileView");
}
function backToMain(){show("main")}

/* NEWS */
function loadPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(s=>{
    posts.innerHTML="";
    s.forEach(d=>{
      const p=d.data();
      posts.innerHTML+=`<div class="post"><b>${p.username}</b><br>${p.text}</div>`;
    });
  });
}
function createPost(){
  if(!postText.value)return;
  db.collection("posts").add({
    username:me.innerText,
    text:postText.value,
    time:Date.now()
  });
  postText.value="";
}

/* FRIENDS */
function loadFriends(){
  db.collection("users").onSnapshot(s=>{
    friendsList.innerHTML="";
    s.forEach(d=>{
      if(d.id!==auth.currentUser.uid)
        friendsList.innerHTML+=`<div class="user" onclick="openProfile('${d.id}')">${d.data().username}</div>`;
    });
  });
}

/* UI */
function show(id){
  ["auth","profileSetup","main","profileView"]
    .forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function logout(){auth.signOut();}
</script>
</body>
</html>
