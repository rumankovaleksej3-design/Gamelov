<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ChatNet Pro</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #e2e8f0;
  height: 100vh;
  overflow: hidden;
}

.hidden {
  display: none !important;
}

.container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
#auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 40px 20px;
}

#auth h2 {
  font-size: 3rem;
  color: white;
  margin-bottom: 40px;
  font-weight: 800;
  background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

#auth input {
  width: 100%;
  max-width: 320px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  background: rgba(30, 41, 59, 0.8);
  color: white;
  font-size: 16px;
}

#auth button {
  width: 100%;
  max-width: 320px;
  padding: 16px;
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

/* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
#main {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* –®–ê–ü–ö–ê */
header {
  background: rgba(15, 23, 42, 0.95);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#me {
  font-size: 18px;
  font-weight: 600;
  color: #e2e8f0;
  cursor: pointer;
  padding: 10px 18px;
  border-radius: 12px;
  background: rgba(30, 41, 59, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.header-actions {
  display: flex;
  gap: 10px;
}

.header-btn {
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
  cursor: pointer;
  font-size: 14px;
}

/* –í–ö–õ–ê–î–ö–ò */
.tabs {
  display: flex;
  background: rgba(15, 23, 42, 0.95);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding: 0 20px;
}

.tab {
  flex: 1;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  font-weight: 500;
  color: #94a3b8;
  border-bottom: 3px solid transparent;
}

.tab.active {
  color: #60a5fa;
  border-bottom-color: #60a5fa;
  font-weight: 600;
}

/* –ß–ê–¢–´ */
#chats {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#users {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.user {
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  border-radius: 16px;
  margin-bottom: 10px;
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.user:hover {
  background: rgba(51, 65, 85, 0.6);
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
}

.user-info div:first-child {
  font-weight: 600;
  color: #f1f5f9;
  margin-bottom: 4px;
}

.status {
  font-size: 13px;
  color: #94a3b8;
}

/* –û–ö–ù–û –ß–ê–¢–ê */
.chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.msg {
  max-width: 75%;
  padding: 14px 18px;
  margin: 8px 0;
  border-radius: 18px;
  background: rgba(30, 41, 59, 0.8);
  word-wrap: break-word;
  border: 1px solid rgba(255, 255, 255, 0.05);
  position: relative;
}

.msg:hover .msg-actions {
  display: flex;
}

.msg.me {
  margin-left: auto;
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
}

.msg.edited::after {
  content: " (—Ä–µ–¥.)";
  font-size: 11px;
  opacity: 0.7;
  font-style: italic;
}

.msg small {
  display: block;
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 6px;
}

/* –î–ï–ô–°–¢–í–ò–Ø –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò */
.msg-actions {
  position: absolute;
  right: -40px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  flex-direction: column;
  gap: 5px;
  background: rgba(30, 41, 59, 0.9);
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.msg-action-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: rgba(51, 65, 85, 0.8);
  color: #e2e8f0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s ease;
}

.msg-action-btn:hover {
  background: #3b82f6;
  color: white;
  transform: scale(1.1);
}

/* –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê –° –≠–ú–û–î–ó–ò */
.input {
  display: flex;
  gap: 12px;
  padding: 20px;
  background: rgba(15, 23, 42, 0.95);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  align-items: center;
}

.input input {
  flex: 1;
  padding: 16px 20px;
  border-radius: 25px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  font-size: 16px;
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
}

.input button {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
}

.input-actions {
  display: flex;
  gap: 8px;
}

.emoji-btn {
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.send-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
}

/* –ü–ê–ù–ï–õ–¨ –≠–ú–û–î–ó–ò */
#emojiPanel {
  background: rgba(15, 23, 42, 0.95);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding: 15px;
  max-height: 200px;
  overflow-y: auto;
}

.emoji-category {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.emoji-category-btn {
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(30, 41, 59, 0.8);
  color: #94a3b8;
  cursor: pointer;
  white-space: nowrap;
  font-size: 12px;
  transition: all 0.2s ease;
}

.emoji-category-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 8px;
}

.emoji-item {
  font-size: 22px;
  text-align: center;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.emoji-item:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: scale(1.1);
}

/* –ü–†–ï–í–¨–Æ –û–¢–í–ï–¢–ê –ò –ü–ï–†–ï–°–´–õ–ö–ò */
#replyBox, #forwardBox {
  padding: 14px 20px;
  background: rgba(30, 41, 59, 0.9);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: #94a3b8;
}

#replyBox button, #forwardBox button {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: #94a3b8;
  cursor: pointer;
  font-size: 18px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø */
.voice-message {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 20px;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.voice-play-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #3b82f6;
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.voice-wave {
  flex: 1;
  height: 24px;
  background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}

.voice-wave::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: wave 2s infinite linear;
}

@keyframes wave {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* –°–¢–ò–ö–ï–†–´ */
.sticker-message {
  font-size: 64px;
  text-align: center;
  padding: 10px;
}

.sticker-panel {
  background: rgba(15, 23, 42, 0.95);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding: 15px;
  max-height: 250px;
  overflow-y: auto;
}

.sticker-category {
  margin-bottom: 15px;
}

.sticker-category h4 {
  color: #94a3b8;
  margin-bottom: 10px;
  font-size: 14px;
}

.sticker-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.sticker-item {
  font-size: 36px;
  text-align: center;
  cursor: pointer;
  padding: 8px;
  border-radius: 12px;
  transition: all 0.2s ease;
}

.sticker-item:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: scale(1.1);
}

/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: #1e293b;
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-title {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 20px;
  color: white;
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
}

/* –ü–†–û–§–ò–õ–ò */
.profile-header {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 50px 20px 30px;
  text-align: center;
  position: relative;
}

.profile-avatar {
  font-size: 64px;
  width: 120px;
  height: 120px;
  margin: 0 auto 25px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 4px solid rgba(255, 255, 255, 0.2);
}

/* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  background: #1e293b;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  z-index: 1000;
  max-width: 300px;
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from {
    transform: translateX(100px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.notification.success {
  border-left: 4px solid #22c55e;
}

.notification.error {
  border-left: 4px solid #ef4444;
}

.notification.info {
  border-left: 4px solid #3b82f6;
}

/* –†–ï–ê–ö–¶–ò–ò –ù–ê –°–û–û–ë–©–ï–ù–ò–Ø */
.reactions {
  display: flex;
  gap: 5px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.reaction {
  display: flex;
  align-items: center;
  gap: 2px;
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reaction:hover {
  background: rgba(59, 130, 246, 0.2);
}

.reaction-count {
  color: #94a3b8;
  font-size: 10px;
}

/* –¢–ï–ú–´ */
.theme-option {
  padding: 20px;
  border-radius: 12px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  text-align: center;
  margin-bottom: 10px;
}

.theme-option:hover {
  transform: scale(1.05);
}

.theme-option.selected {
  border-color: #3b82f6;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
}

/* –ò–ì–†–´ */
.game-invite {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  padding: 15px;
  border-radius: 16px;
  margin: 10px 0;
  color: white;
}

.game-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.game-btn {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.game-btn.accept {
  background: #22c55e;
  color: white;
}

.game-btn.decline {
  background: #ef4444;
  color: white;
}

/* –°–ö–†–û–õ–õ–ë–ê–† */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #3b82f6;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #2563eb;
}

/* –ê–ù–ò–ú–ê–¶–ò–ò */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg {
  animation: fadeIn 0.3s ease;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="container">

<!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
<div id="auth">
  <h2>ChatNet Pro</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- PROFILE SETUP -->
<div id="profileSetup" class="hidden">
  <div class="profile-header">
    <div class="profile-avatar" id="setupAvatarPreview">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: white;">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</div>
  </div>
  
  <div style="padding: 20px;">
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</div>
    <div id="avatarSelectorSetup" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 20px 0;">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'setup')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'setup')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'setup')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'setup')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'setup')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'setup')">üëë</div>
    </div>
    
    <input id="username" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;"><br>
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–°—Ç–∞—Ç—É—Å</div>
    <div id="statusSelectorSetup" style="display: flex; gap: 12px; margin: 20px 0;">
      <div class="status-option selected" onclick="selectStatus('online', 'setup')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'setup')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'setup')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <button onclick="saveProfile()" style="width:100%;padding:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 12px; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
<div id="main" class="hidden">
<header>
  <span id="me" onclick="openMyProfile()" style="cursor:pointer"></span>
  <div class="header-actions">
    <button class="header-btn" onclick="showGroupCreation()">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    <button class="header-btn" onclick="showVoiceRecord()">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ</button>
    <button class="header-btn" onclick="showStickers()">üò∫ –°—Ç–∏–∫–µ—Ä—ã</button>
    <button class="header-btn" onclick="showGames()">üéÆ –ò–≥—Ä—ã</button>
    <button class="header-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
  </div>
</header>

<div id="chats">
  <div class="chat" id="chat"></div>

  <div id="replyBox" class="hidden">
    <div style="flex: 1;">
      <div style="font-size: 12px; color: #94a3b8;">–û—Ç–≤–µ—Ç –Ω–∞:</div>
      <div id="replyText" style="color: white;"></div>
    </div>
    <button onclick="cancelReply()">‚úñ</button>
  </div>

  <div id="forwardBox" class="hidden">
    <div style="flex: 1;">
      <div style="font-size: 12px; color: #94a3b8;">–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç–µ:</div>
      <div id="forwardText" style="color: white;"></div>
    </div>
    <button onclick="cancelForward()">‚úñ</button>
  </div>

  <div id="emojiPanel" class="hidden"></div>
  <div id="stickerPanel" class="hidden"></div>

  <div class="input">
    <div class="input-actions">
      <button class="emoji-btn" onclick="toggleEmojiPanel()">üòÄ</button>
      <button class="emoji-btn" onclick="toggleStickerPanel()">üò∫</button>
      <button class="emoji-btn" onclick="startVoiceRecording()">üé§</button>
    </div>
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key=='Enter') send()">
    <button class="send-btn" onclick="send()">‚û§</button>
  </div>

  <div style="padding: 20px; font-weight: 600; color: #f1f5f9; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  </div>
  <div id="users"></div>
</div>

<div id="news" class="hidden">
  <div style="padding: 24px;">
    <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" style="width:100%;padding:18px 20px;border:2px solid rgba(255,255,255,0.1);border-radius:16px;background:rgba(30,41,59,0.8);color:#e2e8f0;min-height:120px;margin-bottom:20px;"></textarea><br>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button onclick="addEmojiToPost('üòä')" style="padding:8px 12px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:#e2e8f0;border-radius:8px;cursor:pointer;">üòä</button>
      <button onclick="addEmojiToPost('üòÇ')" style="padding:8px 12px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:#e2e8f0;border-radius:8px;cursor:pointer;">üòÇ</button>
      <button onclick="addEmojiToPost('‚ù§Ô∏è')" style="padding:8px 12px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:#e2e8f0;border-radius:8px;cursor:pointer;">‚ù§Ô∏è</button>
      <button onclick="addEmojiToPost('üéâ')" style="padding:8px 12px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:#e2e8f0;border-radius:8px;cursor:pointer;">üéâ</button>
    </div>
    <button onclick="createPost()" style="padding:14px 30px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </div>
  <div id="posts"></div>
</div>

<div id="friends" class="hidden">
  <div style="padding:24px;">
    <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 20px; font-size: 18px;">–î—Ä—É–∑—å—è</div>
    <div id="friendsList"></div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('chats',this)">üí¨ –ß–∞—Ç—ã</div>
  <div class="tab" onclick="openTab('news',this)">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
  <div class="tab" onclick="openTab('friends',this)">üë• –î—Ä—É–∑—å—è</div>
  <div class="tab" onclick="showModerationPanel()">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è</div>
  <div class="tab" onclick="showThemes()">üé® –¢–µ–º—ã</div>
</div>

</div>

<!-- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø -->
<div id="profileView" class="hidden">
  <div class="profile-header">
    <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer;">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="pAvatar">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;" id="pName"></div>
    <div style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;" id="pStatus"></div>
  </div>
  
  <div style="padding: 20px;">
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #60a5fa;">–û —Å–µ–±–µ</div>
    <div id="pBio" style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 16px; line-height: 1.6;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0;">
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: #60a5fa;" id="pMessages">0</div>
        <div style="font-size: 12px; color: #94a3b8;">–°–æ–æ–±—â–µ–Ω–∏–π</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: #60a5fa;" id="pFriends">0</div>
        <div style="font-size: 12px; color: #94a3b8;">–î—Ä—É–∑–µ–π</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: #60a5fa;" id="pPosts">0</div>
        <div style="font-size: 12px; color: #94a3b8;">–ü–æ—Å—Ç–æ–≤</div>
      </div>
    </div>
    
    <div style="margin-top: 30px; display: flex; gap: 12px;">
      <button onclick="writeFromProfile()" style="flex:1;padding:14px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;cursor:pointer;">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
      <button onclick="toggleFriend()" id="friendBtn" style="flex:1;padding:14px;background:rgba(30,41,59,0.8);color:#e2e8f0;border:1px solid rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;">ü§ù –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
      <button onclick="sendGameInvite()" style="flex:1;padding:14px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:white;border:none;border-radius:12px;cursor:pointer;">üéÆ –ò–≥—Ä–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–û–ô –ü–†–û–§–ò–õ–¨ -->
<div id="myProfile" class="hidden">
  <div class="profile-header">
    <button onclick="back()" style="position: absolute; left: 20px; top: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer;">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="profile-avatar" id="myAvatarPreview">üë§</div>
    <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #f1f5f9;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <div style="font-size: 16px; color: #94a3b8; margin-bottom: 25px;" id="myStatusPreview">üü¢ –í —Å–µ—Ç–∏</div>
  </div>
  
  <div style="padding: 20px;">
    <input id="myUsername" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;margin:10px 0; padding: 14px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(30, 41, 59, 0.8); color: white;">
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–ê–≤–∞—Ç–∞—Ä</div>
    <div id="avatarSelector" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 20px 0;">
      <div class="avatar-option selected" onclick="selectAvatar('üë§', 'my')">üë§</div>
      <div class="avatar-option" onclick="selectAvatar('üòé', 'my')">üòé</div>
      <div class="avatar-option" onclick="selectAvatar('ü§ñ', 'my')">ü§ñ</div>
      <div class="avatar-option" onclick="selectAvatar('üê∂', 'my')">üê∂</div>
      <div class="avatar-option" onclick="selectAvatar('ü¶ä', 'my')">ü¶ä</div>
      <div class="avatar-option" onclick="selectAvatar('üëë', 'my')">üëë</div>
    </div>
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–°—Ç–∞—Ç—É—Å</div>
    <div id="statusSelector" style="display: flex; gap: 12px; margin: 20px 0;">
      <div class="status-option selected" onclick="selectStatus('online', 'my')">üü¢ –í —Å–µ—Ç–∏</div>
      <div class="status-option" onclick="selectStatus('busy', 'my')">üü° –ó–∞–Ω—è—Ç</div>
      <div class="status-option" onclick="selectStatus('invisible', 'my')">‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞</div>
    </div>
    
    <div style="font-size: 18px; font-weight: 600; margin: 20px 0 16px; color: #60a5fa;">–û —Å–µ–±–µ</div>
    <textarea id="myBio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." style="width:100%;height:100px;padding:14px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:white;margin-bottom:20px;"></textarea>
    
    <button onclick="updateMyProfile()" style="width:100%;padding:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-top:20px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

<!-- –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü–´ -->
<div id="groupCreationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('groupCreationModal')">√ó</button>
    <div class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</div>
    
    <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%;margin-bottom:15px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(30,41,59,0.8);color:white;">
    
    <div style="margin: 15px 0;">
      <div style="font-weight:600;margin-bottom:10px;color:white;">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã:</div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <div class="avatar-option" onclick="selectGroupEmoji('üë•')">üë•</div>
        <div class="avatar-option" onclick="selectGroupEmoji('üë®‚Äçüë©‚Äçüëß‚Äçüë¶')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="avatar-option" onclick="selectGroupEmoji('üéâ')">üéâ</div>
        <div class="avatar-option" onclick="selectGroupEmoji('üíº')">üíº</div>
        <div class="avatar-option" onclick="selectGroupEmoji('üéÆ')">üéÆ</div>
        <div class="avatar-option" onclick="selectGroupEmoji('üìö')">üìö</div>
      </div>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight:600;margin-bottom:10px;color:white;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</div>
      <div id="groupMembersList" style="max-height:200px;overflow-y:auto;padding:10px;background:rgba(30,41,59,0.6);border-radius:8px;"></div>
    </div>
    
    <button onclick="createGroup()" style="width:100%;padding:14px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
  </div>
</div>

<!-- –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø -->
<div id="voiceRecordModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('voiceRecordModal')">√ó</button>
    <div class="modal-title">–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
    
    <div style="text-align: center; padding: 30px;">
      <div id="voiceTimer" style="font-size: 48px; font-weight: 600; color: #60a5fa; margin: 20px 0;">00:00</div>
      <div id="voiceWave" class="voice-wave" style="width: 100%; height: 60px; margin: 30px 0;"></div>
      
      <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
        <button id="recordBtn" onclick="toggleVoiceRecording()" style="width: 60px; height: 60px; border-radius: 50%; background: #ef4444; color: white; border: none; font-size: 24px; cursor: pointer;">‚óè</button>
        <button id="sendVoiceBtn" onclick="sendVoiceMessage()" style="width: 60px; height: 60px; border-radius: 50%; background: #22c55e; color: white; border: none; font-size: 24px; cursor: pointer; display: none;">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–û–î–ï–†–ê–¶–ò–Ø -->
<div id="moderationModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('moderationModal')">√ó</button>
    <div class="modal-title">–ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
    
    <div style="margin: 20px 0;">
      <div id="reportsList" style="max-height:300px;overflow-y:auto;padding:10px;background:rgba(30,41,59,0.6);border-radius:8px;">
        <div style="text-align:center;padding:20px;color:white;opacity:0.7;">–ù–µ—Ç –∂–∞–ª–æ–±</div>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;">
      <button onclick="loadReports()" style="flex:1;padding:12px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:8px;cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button onclick="showUserManagement()" style="flex:1;padding:12px;background:rgba(30,41,59,0.8);color:white;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
    </div>
  </div>
</div>

<!-- –¢–ï–ú–´ -->
<div id="themesModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('themesModal')">√ó</button>
    <div class="modal-title">–í—ã–±–æ—Ä —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
    
    <div style="margin: 20px 0;">
      <div class="theme-option" onclick="selectTheme('dark')" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white;">
        üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
      </div>
      <div class="theme-option" onclick="selectTheme('light')" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #1e293b;">
        ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
      </div>
      <div class="theme-option" onclick="selectTheme('blue')" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white;">
        üîµ –°–∏–Ω—è—è —Ç–µ–º–∞
      </div>
      <div class="theme-option" onclick="selectTheme('purple')" style="background: linear-gradient(135deg, #6d28d9 0%, #8b5cf6 100%); color: white;">
        üü£ –§–∏–æ–ª–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞
      </div>
      <div class="theme-option" onclick="selectTheme('green')" style="background: linear-gradient(135deg, #065f46 0%, #10b981 100%); color: white;">
        üü¢ –ó–µ–ª–µ–Ω–∞—è —Ç–µ–º–∞
      </div>
    </div>
  </div>
</div>

<!-- –ò–ì–†–´ -->
<div id="gamesModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('gamesModal')">√ó</button>
    <div class="modal-title">–ò–≥—Ä—ã</div>
    
    <div style="margin: 20px 0;">
      <div style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
        <div style="font-weight: 600; color: white; margin-bottom: 10px;">üéÆ –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</div>
        <div style="color: #94a3b8; margin-bottom: 15px;">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ –¥–ª—è –¥–≤–æ–∏—Ö</div>
        <button onclick="startTicTacToe()" style="width:100%;padding:12px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;border-radius:8px;cursor:pointer;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      </div>
      
      <div style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
        <div style="font-weight: 600; color: white; margin-bottom: 10px;">üéØ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div>
        <div style="color: #94a3b8; margin-bottom: 15px;">–°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å –≤ –∑–Ω–∞–Ω–∏—è—Ö</div>
        <button onclick="startQuiz()" style="width:100%;padding:12px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:white;border:none;border-radius:8px;cursor:pointer;">–ù–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É</button>
      </div>
      
      <div style="background: rgba(30, 41, 59, 0.6); padding: 20px; border-radius: 12px;">
        <div style="font-weight: 600; color: white; margin-bottom: 10px;">üé≤ –ö–æ—Å—Ç–∏</div>
        <div style="color: #94a3b8; margin-bottom: 15px;">–ë—Ä–æ—Å—å—Ç–µ –∫–æ—Å—Ç–∏ –Ω–∞ —É–¥–∞—á—É</div>
        <button onclick="rollDice()" style="width:100%;padding:12px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;border:none;border-radius:8px;cursor:pointer;">–ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
firebase.initializeApp({
  apiKey: "AIzaSyDioAafJRuJ4eMGK25-RsQb8M95CWlb1BY",
  authDomain: "chatnet-2a748.firebaseapp.com",
  projectId: "chatnet-2a748"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentChat = null;
let currentChatType = 'private';
let unsub = null;
let replyMsg = null;
let forwardMsg = null;
let selectedGroupMembers = new Set();
let profileUid = null;
let selectedAvatar = 'üë§';
let selectedStatus = 'online';
let groupEmoji = 'üë•';
let voiceRecording = false;
let voiceRecorder = null;
let voiceChunks = [];
let voiceTimer = null;
let voiceSeconds = 0;

// –≠–º–æ–¥–∑–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
const emojiCategories = {
  'faces': ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•∏','ü§©','ü•≥'],
  'animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó'],
  'food': ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë','ü•¶','ü•¨','ü•í','üå∂','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†'],
  'activities': ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑'],
  'objects': ['‚åö','üì±','üì≤','üíª','‚å®Ô∏è','üñ•','üñ®','üñ±','üñ≤','üïπ','üóú','üíΩ','üíæ','üíø','üìÄ','üìº','üì∑','üì∏','üìπ','üé•','üìΩ','üéû','üìû','‚òéÔ∏è','üìü','üì†','üì∫','üìª','üéô','üéö'],
  'symbols': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâ','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è']
};

// –°—Ç–∏–∫–µ—Ä—ã
const stickers = {
  'cats': ['üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'],
  'dogs': ['üê∂', 'üêï', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üê©', 'üêæ', 'ü¶¥', 'ü•é'],
  'hearts': ['üíñ', 'üíó', 'üíì', 'üíû', 'üíï', 'üíò', 'üíù', 'üíü', '‚ù£Ô∏è'],
  'stars': ['‚≠ê', 'üåü', '‚ú®', 'üí´', '‚òÑÔ∏è', 'üå†', 'üéá', 'üéÜ', 'üß®']
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏ –ø–∞–Ω–µ–ª–∏
function initEmojiPanel() {
  const emojiPanel = document.getElementById('emojiPanel');
  emojiPanel.innerHTML = '';
  
  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
  const categoriesDiv = document.createElement('div');
  categoriesDiv.className = 'emoji-category';
  
  Object.keys(emojiCategories).forEach((cat, index) => {
    const btn = document.createElement('button');
    btn.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
    btn.textContent = emojiCategories[cat][0];
    btn.onclick = () => showEmojiCategory(cat);
    categoriesDiv.appendChild(btn);
  });
  
  emojiPanel.appendChild(categoriesDiv);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  showEmojiCategory('faces');
}

function showEmojiCategory(category) {
  const emojiPanel = document.getElementById('emojiPanel');
  const gridDiv = document.createElement('div');
  gridDiv.className = 'emoji-grid';
  
  emojiCategories[category].forEach(emoji => {
    const span = document.createElement('span');
    span.className = 'emoji-item';
    span.textContent = emoji;
    span.onclick = () => addEmoji(emoji);
    gridDiv.appendChild(span);
  });
  
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Ç–∫—É
  const oldGrid = emojiPanel.querySelector('.emoji-grid');
  if (oldGrid) oldGrid.remove();
  
  emojiPanel.appendChild(gridDiv);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  document.querySelectorAll('.emoji-category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤
function initStickerPanel() {
  const stickerPanel = document.getElementById('stickerPanel');
  stickerPanel.innerHTML = '';
  stickerPanel.className = 'sticker-panel';
  
  Object.keys(stickers).forEach(category => {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'sticker-category';
    
    const title = document.createElement('h4');
    title.textContent = category.charAt(0).toUpperCase() + category.slice(1);
    categoryDiv.appendChild(title);
    
    const gridDiv = document.createElement('div');
    gridDiv.className = 'sticker-grid';
    
    stickers[category].forEach(sticker => {
      const span = document.createElement('span');
      span.className = 'sticker-item';
      span.textContent = sticker;
      span.onclick = () => sendSticker(sticker);
      gridDiv.appendChild(span);
    });
    
    categoryDiv.appendChild(gridDiv);
    stickerPanel.appendChild(categoryDiv);
  });
}

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  if (!email || !password) {
    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  
  try {
    await auth.signInWithEmailAndPassword(email, password);
    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
  } catch (error) {
    if (error.code === 'auth/user-not-found') {
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
      } catch (regError) {
        showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + regError.message, 'error');
      }
    } else {
      showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
    }
  }
}

auth.onAuthStateChanged(async user => {
  if (!user) {
    show("auth");
    return;
  }
  
  currentUser = user;
  
  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    
    if (!userDoc.exists) {
      show("profileSetup");
    } else {
      startApp(userDoc.data());
    }
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
});

async function saveProfile() {
  const username = document.getElementById('username').value.trim();
  if (!username) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
    return;
  }
  
  try {
    await db.collection("users").doc(auth.currentUser.uid).set({
      username: username,
      avatar: selectedAvatar || "üë§",
      bio: "",
      online: true,
      lastSeen: Date.now(),
      status: selectedStatus || 'online',
      createdAt: Date.now(),
      role: 'user',
      friends: [],
      groups: [],
      stats: {
        messages: 0,
        posts: 0,
        friends: 0
      }
    });
    
    startApp({ username: username, avatar: selectedAvatar });
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω', 'success');
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
  }
}

function startApp(userData) {
  show("main");
  document.getElementById('me').innerText = `${userData.avatar || "üë§"} ${userData.username}`;
  loadUsers();
  loadPosts();
  loadFriends();
  initEmojiPanel();
  initStickerPanel();
  showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.username}!`, 'success');
}

// === –≠–ú–û–î–ó–ò –ò –°–¢–ò–ö–ï–†–´ ===

function toggleEmojiPanel() {
  const emojiPanel = document.getElementById('emojiPanel');
  const stickerPanel = document.getElementById('stickerPanel');
  
  if (emojiPanel.classList.contains('hidden')) {
    emojiPanel.classList.remove('hidden');
    stickerPanel.classList.add('hidden');
  } else {
    emojiPanel.classList.add('hidden');
  }
}

function toggleStickerPanel() {
  const emojiPanel = document.getElementById('emojiPanel');
  const stickerPanel = document.getElementById('stickerPanel');
  
  if (stickerPanel.classList.contains('hidden')) {
    stickerPanel.classList.remove('hidden');
    emojiPanel.classList.add('hidden');
  } else {
    stickerPanel.classList.add('hidden');
  }
}

function addEmoji(emoji) {
  const textInput = document.getElementById('text');
  textInput.value += emoji;
  textInput.focus();
  document.getElementById('emojiPanel').classList.add('hidden');
}

function sendSticker(sticker) {
  if (!currentChat) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
    return;
  }
  
  sendMessage(`[—Å—Ç–∏–∫–µ—Ä] ${sticker}`, 'sticker');
  document.getElementById('stickerPanel').classList.add('hidden');
}

// === –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ===

function showVoiceRecord() {
  showModal('voiceRecordModal');
}

let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

async function toggleVoiceRecording() {
  if (!isRecording) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      
      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };
      
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å audioBlob –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        document.getElementById('sendVoiceBtn').style.display = 'block';
        document.getElementById('recordBtn').textContent = '‚óè';
        document.getElementById('recordBtn').style.background = '#ef4444';
      };
      
      mediaRecorder.start();
      isRecording = true;
      document.getElementById('recordBtn').textContent = '‚ñ†';
      document.getElementById('recordBtn').style.background = '#3b82f6';
      
      // –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏
      voiceSeconds = 0;
      voiceTimer = setInterval(() => {
        voiceSeconds++;
        const minutes = Math.floor(voiceSeconds / 60).toString().padStart(2, '0');
        const seconds = (voiceSeconds % 60).toString().padStart(2, '0');
        document.getElementById('voiceTimer').textContent = `${minutes}:${seconds}`;
        
        if (voiceSeconds >= 120) { // –ú–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã
          stopVoiceRecording();
        }
      }, 1000);
      
    } catch (error) {
      showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
    }
  } else {
    stopVoiceRecording();
  }
}

function stopVoiceRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    isRecording = false;
    clearInterval(voiceTimer);
  }
}

function sendVoiceMessage() {
  if (audioChunks.length > 0) {
    showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
    closeModal('voiceRecordModal');
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å audioBlob –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  } else {
    showNotification('–ù–µ—Ç –∑–∞–ø–∏—Å–∏', 'error');
  }
}

// === –ò–ì–†–´ ===

function showGames() {
  showModal('gamesModal');
}

function startTicTacToe() {
  if (!currentChat) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∏–≥—Ä—ã', 'error');
    return;
  }
  
  const gameInvite = {
    type: 'game',
    game: 'tic-tac-toe',
    from: auth.currentUser.uid,
    fromName: document.getElementById('me').textContent,
    time: Date.now()
  };
  
  sendMessage(`üéÆ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∏–≥—Ä—É "–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏" –æ—Ç ${gameInvite.fromName}`, 'game');
  closeModal('gamesModal');
  showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∏–≥—Ä—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
}

function startQuiz() {
  const questions = [
    { q: "–°—Ç–æ–ª–∏—Ü–∞ –†–æ—Å—Å–∏–∏?", a: "–ú–æ—Å–∫–≤–∞" },
    { q: "2 + 2?", a: "4" },
    { q: "–¶–≤–µ—Ç –Ω–µ–±–∞?", a: "–°–∏–Ω–∏–π" }
  ];
  
  const randomQ = questions[Math.floor(Math.random() * questions.length)];
  sendMessage(`üéØ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞: ${randomQ.q}`, 'quiz');
  closeModal('gamesModal');
}

function rollDice() {
  const dice1 = Math.floor(Math.random() * 6) + 1;
  const dice2 = Math.floor(Math.random() * 6) + 1;
  const diceEmoji = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÑ'];
  
  sendMessage(`üé≤ –ë—Ä–æ—Å–æ–∫ –∫–æ—Å—Ç–µ–π: ${diceEmoji[dice1-1]} ${diceEmoji[dice2-1]} (${dice1 + dice2})`, 'game');
  closeModal('gamesModal');
}

function sendGameInvite() {
  if (!profileUid) return;
  startTicTacToe();
}

// === –¢–ï–ú–´ ===

function showThemes() {
  showModal('themesModal');
}

function selectTheme(theme) {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É –≤ localStorage
  localStorage.setItem('chatnet_theme', theme);
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
  document.body.className = '';
  document.body.classList.add(`theme-${theme}`);
  
  showNotification(`–¢–µ–º–∞ "${theme}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞`, 'success');
  closeModal('themesModal');
}

// === –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ===

function forwardMessage(messageText) {
  forwardMsg = messageText;
  document.getElementById('forwardText').textContent = messageText.length > 50 ? 
    messageText.substring(0, 50) + '...' : messageText;
  document.getElementById('forwardBox').classList.remove('hidden');
}

function cancelForward() {
  forwardMsg = null;
  document.getElementById('forwardBox').classList.add('hidden');
}

// === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===

let editingMessageId = null;

function editMessage(messageId, currentText) {
  editingMessageId = messageId;
  const textInput = document.getElementById('text');
  textInput.value = currentText;
  textInput.focus();
  showNotification('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
}

// === –†–ï–ê–ö–¶–ò–ò –ù–ê –°–û–û–ë–©–ï–ù–ò–Ø ===

function addReaction(messageId, reaction) {
  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è ${reaction}`, 'success');
}

// === –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

function selectAvatar(avatar, type) {
  selectedAvatar = avatar;
  
  if (type === 'setup') {
    document.getElementById('setupAvatarPreview').textContent = avatar;
  } else if (type === 'my') {
    document.getElementById('myAvatarPreview').textContent = avatar;
  }
}

function selectStatus(status, type) {
  selectedStatus = status;
  
  if (type === 'my') {
    const statusText = {
      'online': 'üü¢ –í —Å–µ—Ç–∏',
      'busy': 'üü° –ó–∞–Ω—è—Ç',
      'invisible': '‚ö™ –ù–µ–≤–∏–¥–∏–º–∫–∞'
    };
    document.getElementById('myStatusPreview').textContent = statusText[status];
  }
}

function selectGroupEmoji(emoji) {
  groupEmoji = emoji;
  document.querySelectorAll('.avatar-option').forEach(el => {
    el.style.border = '2px solid transparent';
  });
  event.target.style.border = '2px solid #3b82f6';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≥—Ä—É–ø–ø—ã
async function loadUsersForGroup() {
  const membersList = document.getElementById('groupMembersList');
  membersList.innerHTML = '';
  selectedGroupMembers.clear();
  
  try {
    const snapshot = await db.collection("users").get();
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:5px;cursor:pointer;border:1px solid rgba(255,255,255,0.1);';
        div.innerHTML = `
          <div class="avatar" style="width:32px;height:32px;font-size:16px;">${user.avatar || 'üë§'}</div>
          <div style="color:white;">${user.username}</div>
          <div style="margin-left:auto;color:#3b82f6;">+</div>
        `;
        div.onclick = () => toggleGroupMember(doc.id, div);
        membersList.appendChild(div);
      }
    });
  } catch (error) {
    membersList.innerHTML = `<div style="color:#ef4444;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
  }
}

function toggleGroupMember(uid, element) {
  if (selectedGroupMembers.has(uid)) {
    selectedGroupMembers.delete(uid);
    element.style.background = '';
    element.querySelector('div:last-child').textContent = '+';
    element.querySelector('div:last-child').style.color = '#3b82f6';
  } else {
    selectedGroupMembers.add(uid);
    element.style.background = 'rgba(59, 130, 246, 0.2)';
    element.querySelector('div:last-child').textContent = '‚úì';
    element.querySelector('div:last-child').style.color = '#22c55e';
  }
}

async function createGroup() {
  const groupName = document.getElementById('groupNameInput').value.trim();
  
  if (!groupName) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
    return;
  }
  
  if (selectedGroupMembers.size === 0) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã', 'error');
    return;
  }
  
  try {
    const groupId = 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const members = Array.from(selectedGroupMembers);
    members.push(auth.currentUser.uid);
    
    const groupData = {
      id: groupId,
      name: groupName,
      avatar: groupEmoji || 'üë•',
      creator: auth.currentUser.uid,
      members: members,
      admins: [auth.currentUser.uid],
      createdAt: Date.now()
    };
    
    await db.collection('groups').doc(groupId).set(groupData);
    
    const batch = db.batch();
    members.forEach(memberId => {
      const userRef = db.collection('users').doc(memberId);
      batch.update(userRef, {
        groups: firebase.firestore.FieldValue.arrayUnion(groupId)
      });
    });
    await batch.commit();
    
    showNotification(`–ì—Ä—É–ø–ø–∞ "${groupName}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
    closeModal('groupCreationModal');
    document.getElementById('groupNameInput').value = '';
    selectedGroupMembers.clear();
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + error.message, 'error');
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(text, type = 'text') {
  if (!currentChat) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
    return;
  }
  
  const messageData = {
    uid: auth.currentUser.uid,
    text: text,
    type: type,
    replyTo: replyMsg,
    forward: forwardMsg,
    time: Date.now(),
    edited: false
  };
  
  try {
    if (currentChatType === 'private') {
      await db.collection("chats").doc(currentChat)
        .collection("messages").add(messageData);
    }
    
    // –û—á–∏—â–∞–µ–º
    if (replyMsg) cancelReply();
    if (forwardMsg) cancelForward();
    
    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
  }
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
async function send() {
  const text = document.getElementById('text').value.trim();
  if (!text) return;
  
  await sendMessage(text);
  document.getElementById('text').value = '';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadUsers() {
  db.collection("users").onSnapshot(snapshot => {
    const usersContainer = document.getElementById('users');
    usersContainer.innerHTML = '';
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        const statusText = getStatusText(user);
        
        const userDiv = document.createElement('div');
        userDiv.className = 'user';
        userDiv.innerHTML = `
          <div class="avatar" onclick="event.stopPropagation();openProfile('${doc.id}')">${user.avatar || "üë§"}</div>
          <div class="user-info" onclick="openChat('${doc.id}')">
            <div>${user.username} ${user.role === 'admin' ? 'üëë' : user.role === 'moderator' ? 'üõ°Ô∏è' : ''}</div>
            <div class="status">${statusText}</div>
          </div>
        `;
        usersContainer.appendChild(userDiv);
      }
    });
  });
}

function getStatusText(user) {
  if (user.status === 'invisible') {
    return '‚ö™ –ù–µ –≤ —Å–µ—Ç–∏';
  } else if (user.online) {
    return `üü¢ ${user.status === 'busy' ? '–ó–∞–Ω—è—Ç' : '–í —Å–µ—Ç–∏'}`;
  } else {
    const lastSeen = formatLastSeen(user.lastSeen);
    return `‚ö™ –±—ã–ª(–∞) ${lastSeen}`;
  }
}

function formatLastSeen(timestamp) {
  if (!timestamp) return "–¥–∞–≤–Ω–æ";
  const diff = Date.now() - timestamp;
  
  if (diff < 60000) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
  if (diff < 3600000) return `${Math.floor(diff/60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} —á –Ω–∞–∑–∞–¥`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('ru-RU');
}

function openChat(uid) {
  currentChat = cid(auth.currentUser.uid, uid);
  currentChatType = 'private';
  
  if (unsub) unsub();
  
  document.getElementById('chat').innerHTML = '';
  
  unsub = db.collection("chats").doc(currentChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snapshot => {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        displayMessage(msg, chat, doc.id);
      });
      
      chat.scrollTop = chat.scrollHeight;
    });
}

function cid(a, b) {
  return [a, b].sort().join("_");
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function displayMessage(msg, container, msgId) {
  const timeStr = new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const isOwnMessage = msg.uid === auth.currentUser.uid;
  
  let messageContent = '';
  
  if (msg.type === 'sticker') {
    messageContent = `<div class="sticker-message">${msg.text.replace('[—Å—Ç–∏–∫–µ—Ä] ', '')}</div>`;
  } else if (msg.type === 'game') {
    messageContent = `
      <div class="game-invite">
        ${msg.text}
        <div class="game-buttons">
          <button class="game-btn accept" onclick="acceptGameInvite('${msgId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button class="game-btn decline" onclick="declineGameInvite('${msgId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      </div>
    `;
  } else {
    messageContent = msg.text;
  }
  
  const messageHTML = `
    <div class="msg ${isOwnMessage ? "me" : ""} ${msg.edited ? "edited" : ""}">
      ${messageContent}
      <small>${timeStr}</small>
      
      <div class="msg-actions">
        <button class="msg-action-btn" onclick="reply('${msg.text.replace(/'/g, "\\'")}')">‚Ü©</button>
        <button class="msg-action-btn" onclick="forwardMessage('${msg.text.replace(/'/g, "\\'")}')">‚Ü™</button>
        ${isOwnMessage ? `
          <button class="msg-action-btn" onclick="editMessage('${msgId}', '${msg.text.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
        ` : ''}
        <button class="msg-action-btn" onclick="addReaction('${msgId}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="msg-action-btn" onclick="addReaction('${msgId}', 'üòÇ')">üòÇ</button>
      </div>
    </div>
  `;
  
  container.innerHTML += messageHTML;
}

// –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
function reply(text) {
  replyMsg = text;
  document.getElementById('replyText').textContent = text.length > 50 ? 
    text.substring(0, 50) + '...' : text;
  document.getElementById('replyBox').classList.remove('hidden');
  document.getElementById('text').focus();
}

function cancelReply() {
  replyMsg = null;
  document.getElementById('replyBox').classList.add('hidden');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
function loadPosts() {
  db.collection("posts").orderBy("time", "desc").onSnapshot(snapshot => {
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = '';
    
    snapshot.forEach(doc => {
      const post = doc.data();
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.style.cssText = 'background:rgba(30,41,59,0.8);padding:20px;border-radius:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);';
      postDiv.innerHTML = `
        <b>${post.username}</b><br>
        ${post.text}
      `;
      postsContainer.appendChild(postDiv);
    });
  });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å —ç–º–æ–¥–∑–∏
function addEmojiToPost(emoji) {
  const postText = document.getElementById('postText');
  postText.value += emoji;
  postText.focus();
}

async function createPost() {
  const postText = document.getElementById('postText').value.trim();
  if (!postText) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'error');
    return;
  }
  
  try {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    const username = userDoc.data()?.username || '–ê–Ω–æ–Ω–∏–º';
    
    await db.collection("posts").add({
      username: username,
      text: postText,
      time: Date.now(),
      uid: auth.currentUser.uid
    });
    
    document.getElementById('postText').value = '';
    showNotification('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω', 'success');
    
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message, 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π
function loadFriends() {
  db.collection("users").onSnapshot(snapshot => {
    const friendsList = document.getElementById('friendsList');
    friendsList.innerHTML = '';
    
    snapshot.forEach(doc => {
      if (doc.id !== auth.currentUser.uid) {
        const user = doc.data();
        const statusText = getStatusText(user);
        
        const friendDiv = document.createElement('div');
        friendDiv.className = 'user';
        friendDiv.innerHTML = `
          <div class="avatar">${user.avatar || "üë§"}</div>
          <div class="user-info">
            <div>${user.username}</div>
            <div class="status">${statusText}</div>
          </div>
        `;
        friendsList.appendChild(friendDiv);
      }
    });
  });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function showModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function openTab(id, el) {
  ["chats", "news", "friends"].forEach(x => {
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
  
  document.querySelectorAll(".tab").forEach(t => {
    t.classList.remove("active");
  });
  el.classList.add("active");
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
function show(id) {
  ["auth", "profileSetup", "main", "profileView", "myProfile"].forEach(x => {
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// –ù–∞–∑–∞–¥
function back() {
  show("main");
}

// –í—ã–π—Ç–∏
async function logout() {
  try {
    if (auth.currentUser) {
      await db.collection("users").doc(auth.currentUser.uid).update({
        online: false,
        lastSeen: Date.now()
      });
    }
    await auth.signOut();
    showNotification('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
  } catch (error) {
    showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message, 'error');
  }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
      <div style="color:white;">${message}</div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
  const savedTheme = localStorage.getItem('chatnet_theme') || 'dark';
  selectTheme(savedTheme);
  
  if (auth.currentUser) {
    auth.signOut();
  }
});
</script>
</body>
</html>
